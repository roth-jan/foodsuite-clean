<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FoodSuite Pro - Vollst√§ndige Warenwirtschaft mit KI-Speiseplanung</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* === MAIN LAYOUT === */
        .main-header {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .main-content {
            min-height: calc(100vh - 120px);
            padding: 20px 0;
        }
        .tab-content { 
            display: none; 
            animation: fadeIn 0.3s ease-in;
        }
        .tab-content.active { 
            display: block; 
        }
        .nav-link.active { 
            background-color: #0d6efd !important; 
            color: white !important;
        }
        
        /* === METRICS CARDS === */
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .metric-card.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .metric-card.danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .metric-card.info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* === CHARTS === */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        /* === NOTIFICATIONS === */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        /* === QUICK ACTIONS === */
        .quick-action {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .quick-action:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* === AI COMPONENTS === */
        .ai-suggestion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .ai-suggestion::before {
            content: "ü§ñ";
            position: absolute;
            top: -10px;
            left: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .ai-suggestion-title {
            font-weight: 700;
            margin-bottom: 10px;
            margin-top: 15px;
            font-size: 16px;
        }
        .ai-assistant-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        .ai-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .ai-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .ai-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .ai-button.active {
            background: rgba(255,255,255,0.4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .ai-designer-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px dashed rgba(255,255,255,0.5);
        }
        
        .ai-designer-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            border-color: rgba(255,255,255,0.8);
        }
        
        /* Make AI Designer modal scrollable */
        #aiDesignerModal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Dropdown navigation improvements */
        .navbar .dropdown-menu {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 0.5rem;
        }
        
        .navbar .dropdown-item {
            padding: 0.6rem 1.2rem;
            transition: all 0.2s;
        }
        
        .navbar .dropdown-item:hover {
            background-color: #f8f9fa;
            padding-left: 1.5rem;
        }
        
        .navbar .dropdown-item i {
            width: 20px;
        }
        
        .navbar .notification-badge {
            position: absolute;
            top: -2px;
            right: -8px;
        }
        
        /* === DRAG & DROP STYLES === */
        .recipe-library {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            height: fit-content;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .recipe-scroll-container {
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
            padding-right: 10px;
        }
        
        .recipe-scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .recipe-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .recipe-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .recipe-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Collapsible Panels */
        .collapse-panel {
            margin-bottom: 10px;
        }
        
        .collapse-panel button {
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .collapse-panel button:hover {
            background-color: rgba(13, 110, 253, 0.1);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .collapse-panel button[aria-expanded="true"] .bi-chevron-down {
            transform: rotate(180deg);
        }
        
        .collapse-panel .bi-chevron-down {
            transition: transform 0.3s ease;
        }
        
        .collapse-panel .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .recipe-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
        }
        .recipe-item:hover {
            background: #e9ecef;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.2);
        }
        .recipe-item:active {
            cursor: grabbing;
        }
        .recipe-item.dragging {
            opacity: 0.6;
            transform: rotate(5deg) scale(0.95);
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .recipe-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 6px;
            color: #2c3e50;
        }
        .recipe-meta {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .recipe-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .recipe-tag {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: #495057;
        }
        .recipe-tag.vegetarian { background: #d4edda; color: #155724; }
        .recipe-tag.vegan { background: #d1ecf1; color: #0c5460; }
        .recipe-tag.protein { background: #f8d7da; color: #721c24; }
        .recipe-tag.gluten-free { background: #fff3cd; color: #856404; }
        .recipe-drag-hint {
            font-size: 10px;
            color: #6c757d;
            font-style: italic;
            margin-top: 5px;
        }
        
        /* === CALENDAR STYLES === */
        .calendar-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .calendar-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .meal-planning-table {
            width: 100%;
            margin: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .meal-planning-table thead th {
            background: #007bff;
            color: white;
            font-weight: 700;
            text-align: center;
            padding: 15px 8px;
            border: none;
            font-size: 16px;
        }
        
        .time-header {
            background: #0056b3 !important;
            width: 120px;
            min-width: 120px;
        }
        
        .day-header {
            width: calc((100% - 120px) / 7);
        }
        
        .meal-label-cell {
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            width: 120px;
            min-width: 120px;
            border-right: 2px solid #007bff;
        }
        
        .meal-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #495057;
        }
        
        .meal-label i {
            font-size: 18px;
            color: #007bff;
        }
        .calendar-time-slot {
            background: #f8f9fa;
            padding: 18px 12px;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #495057;
            border-right: 1px solid #dee2e6;
        }
        .calendar-day-header {
            background: #007bff;
            color: white;
            padding: 15px 8px;
            font-weight: 700;
            text-align: center;
            font-size: 16px;
            border-radius: 8px;
        }
        .calendar-cell {
            background: white;
            min-height: 120px;
            max-height: 180px;
            padding: 12px;
            position: relative;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            vertical-align: top;
            overflow-y: auto;
        }
        
        .meal-slot {
            cursor: pointer;
            position: relative;
        }
        
        .day-column {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        
        .add-meal-btn {
            margin-top: auto;
            width: 100%;
        }
        .calendar-cell:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }
        .calendar-cell.drag-over {
            background: #e7f3ff !important;
            border-color: #007bff !important;
            border-style: dashed;
            animation: dragPulse 1s infinite;
        }
        .calendar-cell.has-meals {
            background: #f0f8ff;
            border-color: #007bff;
        }
        .calendar-cell-empty {
            color: #6c757d;
            font-size: 12px;
            text-align: center;
            font-style: italic;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            height: 100%;
            justify-content: center;
            min-height: 80px;
        }
        
        .calendar-cell-empty i {
            font-size: 20px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 11px;
        }

        /* Collaboration styles */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 150px;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        
        .context-menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item i {
            margin-right: 8px;
            width: 16px;
        }
        
        .comment-indicator {
            cursor: pointer;
        }
        
        .comment-indicator:hover {
            transform: scale(1.1);
        }
        
        .online-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .meal-event {
            background: #ffffff;
            color: #333;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 12px;
            width: 100%;
            text-align: left;
            cursor: move;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
            margin-bottom: 10px;
        }
        
        .meal-time {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .meal-type {
            font-size: 0.75rem;
        }
        .meal-event:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.3);
        }
        .meal-event.dragging {
            opacity: 0.6;
            transform: rotate(5deg) scale(0.95);
            z-index: 1000;
        }
        .meal-event.breakfast { 
            background: linear-gradient(135deg, #ffc107, #e0a800);
            box-shadow: 0 4px 15px rgba(255,193,7,0.2);
        }
        .meal-event.lunch { 
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40,167,69,0.2);
        }
        .meal-event.dinner { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: 0 4px 15px rgba(220,53,69,0.2);
        }
        .meal-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 6px;
            line-height: 1.2;
        }
        .meal-details {
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        /* === INFO PANELS === */
        .info-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .cost-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .cost-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 16px;
            color: #007bff;
            margin-bottom: 0;
        }
        .nutrition-bar {
            background: #e9ecef;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .nutrition-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        .nutrition-fill.protein { background: linear-gradient(90deg, #28a745, #20c997); }
        .nutrition-fill.carbs { background: linear-gradient(90deg, #ffc107, #e0a800); }
        .nutrition-fill.fat { background: linear-gradient(90deg, #dc3545, #c82333); }
        .nutrition-fill.fiber { background: linear-gradient(90deg, #6f42c1, #5a32a3); }
        
        /* === PRODUCTS TABLE === */
        .products-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .table-actions {
            display: flex;
            gap: 5px;
        }
        .stock-indicator {
            width: 80px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-right: 8px;
        }
        .stock-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .stock-fill.high { background: #28a745; }
        .stock-fill.medium { background: #ffc107; }
        .stock-fill.low { background: #dc3545; }
        
        /* === ANIMATIONS === */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes dragPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes dropSuccess {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .drop-success {
            animation: dropSuccess 0.6s ease-out;
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* AI Optimization Effects */
        .calendar-cell.optimizing {
            animation: optimizePulse 1s ease-in-out infinite;
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
        }
        
        .calendar-cell.optimized {
            animation: optimizeSuccess 0.6s ease-out;
            background-color: #d4edda !important;
            border-color: #28a745 !important;
        }
        
        @keyframes optimizePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
        
        @keyframes optimizeSuccess {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* AI Suggestion Tooltip */
        .ai-suggestion-tooltip {
            position: fixed;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            z-index: 2000;
            pointer-events: none;
            transform: translateY(-5px);
            animation: fadeIn 0.2s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        
        .ai-suggestion-tooltip.good {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .ai-suggestion-tooltip.warning {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #212529;
        }
        
        .ai-suggestion-tooltip.neutral {
            background: linear-gradient(135deg, #6c757d, #545b62);
            color: white;
        }
        
        .ai-suggestion-tooltip i {
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            /* Mobile: Stack calendar and recipe library */
            .meal-planning-table {
                font-size: 12px;
            }
            
            .meal-planning-table thead th {
                padding: 10px 5px;
                font-size: 12px;
            }
            
            .time-header {
                width: 80px;
                min-width: 80px;
            }
            
            .meal-label-cell {
                width: 80px;
                min-width: 80px;
            }
            
            .meal-label {
                font-size: 10px;
            }
            
            .meal-label i {
                font-size: 14px;
            }
            
            .calendar-cell {
                min-height: 80px;
                max-height: 120px;
                padding: 8px;
                font-size: 10px;
            }
            
            .calendar-cell-empty {
                min-height: 60px;
            }
            
            .empty-text {
                font-size: 9px;
            }
            
            .recipe-item {
                padding: 15px;
                margin-bottom: 12px;
                min-height: 60px; /* Better touch targets */
                border: 3px solid #e9ecef; /* Thicker borders for better visibility */
            }
            
            .meal-event {
                padding: 10px;
                min-height: 50px;
            }
            
            .meal-title {
                font-size: 12px;
            }
            .meal-details {
                font-size: 10px;
            }
            
            /* Mobile: Collapse panels default closed */
            .collapse-panel button {
                font-size: 14px;
                padding: 12px 16px;
            }
            
            /* Mobile: Category tabs smaller */
            #recipe-category-tabs .nav-link {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            /* Mobile: Recipe library optimizations */
            .recipe-library {
                padding: 20px;
                max-height: 60vh;
            }
            
            .recipe-scroll-container {
                max-height: 300px;
            }
            
            /* Mobile: AI Assistant panel smaller */
            .ai-assistant-panel {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .ai-controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .ai-button {
                font-size: 11px;
                padding: 8px 12px;
                text-align: center;
            }
        }
        
        /* === BATCH SELECTION STYLES === */
        .batch-selection-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .batch-actions-bar {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .batch-actions-bar.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .batch-selection-info {
            font-weight: 600;
            color: #495057;
        }
        
        .batch-action-buttons {
            display: flex;
            gap: 10px;
        }
        
        tr.selected-row {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        
        .select-all-checkbox {
            transform: scale(1.2);
        }
        
        /* === EXPORT MODAL STYLES === */
        .export-modal .modal-dialog {
            max-width: 600px;
        }
        
        .export-options {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .export-option {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .export-option:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }
        
        .export-option.selected {
            border-color: #007bff;
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .export-option.selected::after {
            content: "‚úì";
            position: absolute;
            top: 10px;
            right: 15px;
            color: #007bff;
            font-size: 24px;
            font-weight: bold;
        }
        
        .export-format-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .export-format-badge.csv {
            background-color: #28a745;
            color: white;
        }
        
        .export-format-badge.excel {
            background-color: #217346;
            color: white;
        }
        
        .export-format-badge.pdf {
            background-color: #dc3545;
            color: white;
        }
        
        .export-progress {
            display: none;
            margin-top: 20px;
        }
        
        .export-progress.show {
            display: block;
        }
        
        /* === HISTORY VIEW STYLES === */
        .history-timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .history-timeline::before {
            content: "";
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #dee2e6;
        }
        
        .history-item {
            position: relative;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }
        
        .history-item::before {
            content: "";
            position: absolute;
            left: -30px;
            top: 25px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #dee2e6;
        }
        
        .history-item.create::before {
            background-color: #28a745;
        }
        
        .history-item.update::before {
            background-color: #ffc107;
        }
        
        .history-item.delete::before {
            background-color: #dc3545;
        }
        
        .history-date {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-action {
            font-weight: 600;
            color: #212529;
            margin-bottom: 10px;
        }
        
        .history-details {
            font-size: 14px;
            color: #495057;
            line-height: 1.6;
        }
        
        .history-user {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 13px;
            color: #6c757d;
        }
        
        .history-changes {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .history-changes-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .history-change-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-change-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .history-field-name {
            font-weight: 600;
            color: #495057;
        }
        
        .history-old-value {
            color: #dc3545;
            text-decoration: line-through;
        }
        
        .history-new-value {
            color: #28a745;
            font-weight: 600;
        }
        
        /* === ADVANCED FILTER COLLAPSE ANIMATION === */
        .advanced-filters {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 0;
            margin-top: 20px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .advanced-filters-toggle {
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .advanced-filters-toggle:hover {
            background-color: rgba(13, 110, 253, 0.05);
            border-color: #007bff;
            color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
        }
        
        .advanced-filters-toggle .filter-icon {
            transition: transform 0.3s ease;
            display: inline-block;
            margin-left: 8px;
        }
        
        .advanced-filters-toggle[aria-expanded="true"] .filter-icon {
            transform: rotate(180deg);
        }
        
        .advanced-filters-toggle::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: left;
        }
        
        .advanced-filters-toggle[aria-expanded="true"]::after {
            transform: scaleX(1);
        }
        
        .advanced-filters-content {
            padding: 25px;
            background: white;
            margin: 15px;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .filter-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .filter-group:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .filter-group-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group-title i {
            color: #007bff;
        }
        
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .filter-chip {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .filter-chip:hover {
            background-color: rgba(13, 110, 253, 0.1);
            border-color: #007bff;
            color: #007bff;
            transform: translateY(-1px);
        }
        
        .filter-chip.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .filter-chip .remove-filter {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Collapse animation */
        .collapse {
            transition: height 0.35s ease;
        }
        
        .collapsing {
            height: 0;
            overflow: hidden;
            transition: height 0.35s ease;
        }
        
        /* === ENHANCED MOBILE RESPONSIVE === */
        @media (max-width: 768px) {
            /* Mobile batch actions */
            .batch-actions-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .batch-action-buttons {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .batch-action-buttons .btn {
                flex: 1;
                min-width: 120px;
            }
            
            /* Mobile export modal */
            .export-modal .modal-dialog {
                margin: 10px;
            }
            
            .export-option {
                padding: 15px;
            }
            
            /* Mobile history view */
            .history-timeline {
                padding-left: 25px;
            }
            
            .history-timeline::before {
                left: 10px;
            }
            
            .history-item {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .history-item::before {
                left: -21px;
                width: 10px;
                height: 10px;
            }
            
            .history-changes {
                padding: 10px;
            }
            
            .history-change-item {
                flex-direction: column;
                gap: 5px;
            }
            
            /* Mobile filters */
            .advanced-filters-content {
                padding: 15px;
                margin: 10px;
            }
            
            .filter-chips {
                gap: 6px;
            }
            
            .filter-chip {
                font-size: 12px;
                padding: 5px 12px;
            }
            
            /* Mobile tables with horizontal scroll */
            .table-responsive {
                -webkit-overflow-scrolling: touch;
            }
            
            .table th, .table td {
                white-space: nowrap;
            }
            
            /* Mobile sticky table header */
            .table thead th {
                position: sticky;
                top: 0;
                background-color: white;
                z-index: 10;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
        
        @media (max-width: 576px) {
            /* Extra small devices */
            .metric-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .metric-card h3 {
                font-size: 1.5rem;
            }
            
            .metric-card h6 {
                font-size: 0.875rem;
            }
            
            /* Compact navigation */
            .navbar-nav .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .notification-badge {
                width: 16px;
                height: 16px;
                font-size: 10px;
                top: -5px;
                right: -5px;
            }
        }
        
        /* === ANIMATIONS === */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes highlightRow {
            0% { background-color: rgba(255, 193, 7, 0.3); }
            100% { background-color: transparent; }
        }
        
        .highlight-animation {
            animation: highlightRow 2s ease-out;
        }
        
        /* Custom background colors for modals */
        .bg-purple {
            background-color: #6f42c1 !important;
            color: white !important;
        }

        /* Fix for Custom Mode Modal - Entferne ALLE CSS-√úberschreibungen */
        #aiDesignerModal .modal-body {
            min-height: 500px;
        }
        
        /* Lass Bootstrap die komplette Kontrolle √ºber Tabs */
    </style>
</head>
<body>
    <header class="main-header">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#dashboard">
                    <i class="bi bi-basket2 me-2"></i>FoodSuite
                    <span class="badge bg-light text-primary ms-2">Pro</span>
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" data-tab="dashboard">
                                <i class="bi bi-speedometer2 me-1"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#meal-planning" data-tab="meal-planning">
                                <i class="bi bi-calendar-week me-1"></i>KI-Speiseplanung
                                <span class="badge bg-warning text-dark ms-1">NEW</span>
                            </a>
                        </li>
                        <!-- Warenwirtschaft Dropdown -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-box-seam me-1"></i>Warenwirtschaft
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#products" data-tab="products">
                                    <i class="bi bi-box-seam me-2"></i>Produkte
                                </a></li>
                                <li><a class="dropdown-item" href="#inventory" data-tab="inventory">
                                    <i class="bi bi-boxes me-2"></i>Lagerbestand
                                </a></li>
                                <li><a class="dropdown-item" href="#recipes" data-tab="recipes">
                                    <i class="bi bi-book me-2"></i>Rezepte
                                </a></li>
                            </ul>
                        </li>
                        
                        <!-- Einkauf & Bestellung -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-cart me-1"></i>Einkauf
                                <span class="notification-badge" id="orderNotificationBadge">3</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#suppliers" data-tab="suppliers">
                                    <i class="bi bi-truck me-2"></i>Lieferanten
                                </a></li>
                                <li><a class="dropdown-item" href="#orders" data-tab="orders">
                                    <i class="bi bi-cart-check me-2"></i>Bestellungen
                                    <span class="badge bg-danger ms-2">3</span>
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="showToast('üöß Ausschreibungen - Coming Soon!', 'info')">
                                    <i class="bi bi-megaphone me-2"></i>Ausschreibungen
                                    <span class="text-muted small">(bald)</span>
                                </a></li>
                            </ul>
                        </li>
                        <!-- Analytics & Controlling -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-graph-up me-1"></i>Controlling
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#analytics" data-tab="analytics">
                                    <i class="bi bi-graph-up me-2"></i>Analytics & Reports
                                </a></li>
                                <li><a class="dropdown-item" href="#price-monitoring" data-tab="price-monitoring">
                                    <i class="bi bi-currency-euro me-2"></i>Preis√ºberwachung
                                    <span class="badge bg-info ms-2">NEW</span>
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="showToast('üìä Budget-Planung in Entwicklung', 'info')">
                                    <i class="bi bi-piggy-bank me-2"></i>Budget-Planung
                                    <span class="text-muted small">(bald)</span>
                                </a></li>
                            </ul>
                        </li>
                    </ul>
                    
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <select class="form-select form-select-sm" onchange="switchTenant(this.value)">
                                <option value="demo">Demo Restaurant</option>
                                <option value="hotel">Grand Hotel</option>
                                <option value="cafeteria">Uni Cafeteria</option>
                            </select>
                        </div>
                        <div class="me-3">
                            <span class="badge bg-success">
                                <i class="bi bi-person-check me-1"></i>Admin
                            </span>
                        </div>
                        <div class="dropdown user-dropdown">
                            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <div class="user-info d-flex align-items-center">
                                    <i class="bi bi-person-circle me-1"></i>
                                    <span id="currentUserName">L√§dt...</span>
                                    <span class="badge bg-secondary ms-1" id="currentUserRole">...</span>
                                </div>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header" id="userMenuHeader">
                                    <i class="bi bi-person-circle me-1"></i>L√§dt...
                                </h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showUserProfile()">
                                    <i class="bi bi-person me-2"></i>Mein Profil
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="showUserManagement()">
                                    <i class="bi bi-people me-2"></i>Benutzerverwaltung
                                </a></li>
                                <li><a class="dropdown-item" href="#" data-action="showModal" data-modal="settingsModal">
                                    <i class="bi bi-gear me-2"></i>Einstellungen
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><small class="dropdown-item-text">
                                    <i class="bi bi-clock me-1"></i>Letzte Anmeldung: <span id="lastLoginTime">vor 2 Std.</span>
                                </small></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logoutUser()">
                                    <i class="bi bi-box-arrow-right me-2"></i>Abmelden
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="container-fluid">
            <!-- ===== DASHBOARD TAB ===== -->
            <div id="dashboard" class="tab-content active">
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <h1><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
                        <p class="text-muted">Willkommen zur√ºck! Hier ist Ihre √úbersicht f√ºr <span id="currentTenant">Demo Restaurant</span>.</p>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="metric-card info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-2">Aktive Produkte</h6>
                                    <h3 class="mb-0" id="activeProductsCount">2,543</h3>
                                    <small>
                                        <i class="bi bi-arrow-up"></i> 127 neue diese Woche
                                    </small>
                                </div>
                                <div>
                                    <i class="bi bi-box-seam fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="metric-card warning">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-2">Geplante Men√ºs</h6>
                                    <h3 class="mb-0" id="plannedMenusCount">142</h3>
                                    <small>
                                        N√§chste 7 Tage
                                    </small>
                                </div>
                                <div>
                                    <i class="bi bi-calendar-week fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="metric-card danger">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-2">Kritische Best√§nde</h6>
                                    <h3 class="mb-0" id="lowStockCount">23</h3>
                                    <small>
                                        <i class="bi bi-exclamation-triangle"></i> Nachbestellung n√∂tig
                                    </small>
                                </div>
                                <div>
                                    <i class="bi bi-box2 fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="metric-card success">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-2">KI-Einsparungen</h6>
                                    <h3 class="mb-0" id="aiSavingsAmount">‚Ç¨1,847</h3>
                                    <small>
                                        Durch intelligente Planung
                                    </small>
                                </div>
                                <div>
                                    <i class="bi bi-robot fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Ausgaben-Trend & KI-Optimierung</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="expensesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-robot me-2"></i>KI-Empfehlungen</h5>
                            </div>
                            <div class="card-body">
                                <div id="aiRecommendations">
                                    <div class="ai-suggestion">
                                        <div class="ai-suggestion-title">Optimierungsvorschlag</div>
                                        <p class="mb-3">Das italienische Men√º vom Donnerstag kann durch Austausch der Vorspeise um 12% g√ºnstiger werden.</p>
                                        <button class="btn btn-sm btn-light" data-action="applyAIRecommendation" data-param="1">
                                            <i class="bi bi-check me-1"></i>Anwenden
                                        </button>
                                    </div>
                                    <div class="ai-suggestion">
                                        <div class="ai-suggestion-title">Saisonaler Hinweis</div>
                                        <p class="mb-3">K√ºrbis ist aktuell 30% g√ºnstiger. Empfehlung: K√ºrbissuppe f√ºr n√§chste Woche.</p>
                                        <button class="btn btn-sm btn-light" data-action="applyAIRecommendation" data-param="2">
                                            <i class="bi bi-lightbulb me-1"></i>Rezept generieren
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-lightning-fill me-2"></i>Schnellaktionen</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="quick-action" data-tab="meal-planning">
                                            <i class="bi bi-calendar-week me-2 fs-4"></i>
                                            <div class="fw-bold">KI-Speiseplanung</div>
                                            <small>Intelligente Men√ºplanung</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="quick-action" data-action="generateWeeklyMenu">
                                            <i class="bi bi-robot me-2 fs-4"></i>
                                            <div class="fw-bold">Wochenmen√º generieren</div>
                                            <small>Automatisch optimieren</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="quick-action" data-tab="products">
                                            <i class="bi bi-box-seam me-2 fs-4"></i>
                                            <div class="fw-bold">Produkte verwalten</div>
                                            <small>Lager & Bestellungen</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="quick-action" data-tab="analytics">
                                            <i class="bi bi-graph-up me-2 fs-4"></i>
                                            <div class="fw-bold">Analytics</div>
                                            <small>Preisvergleich & Trends</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== MEAL PLANNING TAB ===== -->
            <div id="meal-planning" class="tab-content">
                <div class="row mb-4">
                    <div class="col">
                        <h1>
                            <i class="bi bi-calendar-week me-2"></i>KI-Speiseplanung
                            <span class="badge bg-primary ms-2">
                                <i class="bi bi-robot me-1"></i>AI-Powered
                            </span>
                        </h1>
                        <p class="text-muted">Intelligente Men√ºplanung mit Drag & Drop, KI-Optimierung und Echtzeit-Kostenberechnung</p>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex gap-2 align-items-center">
                            <select class="form-select" id="aiModeSelect" onchange="updateAIMode(this.value)" style="width: 200px;">
                                <option value="cost_optimized">üí∞ Kostenoptimiert</option>
                                <option value="balanced_nutrition">ü•ó Ausgewogene Ern√§hrung</option>
                                <option value="variety">üé≤ Maximale Abwechslung</option>
                                <option value="seasonal">üåø Saisonal</option>
                                <option value="inventory_based">üì¶ Lagerbasiert</option>
                            </select>
                            <button class="btn btn-primary" data-action="generateAIWeekMenu">
                                <i class="bi bi-robot me-2"></i>KI-Plan erstellen
                            </button>
                            <button class="btn btn-info" data-action="optimizeCurrentPlan">
                                <i class="bi bi-magic me-2"></i>Plan optimieren
                            </button>
                            <button class="btn btn-success" onclick="generateIntelligentShoppingList()">
                                <i class="bi bi-cart-fill me-2"></i>Einkaufsliste
                            </button>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-success" onclick="showExportModal()">
                                <i class="bi bi-download me-2"></i>Exportieren
                            </button>
                            <button class="btn btn-outline-info" onclick="showHistoryView()">
                                <i class="bi bi-clock-history me-2"></i>Historie
                            </button>
                        </div>
                    </div>
                </div>

                <!-- KI Assistant Panel -->
                <div class="ai-assistant-panel">
                    <h5><i class="bi bi-robot me-2"></i>KI-Assistent f√ºr Speiseplanung</h5>
                    <div class="ai-controls">
                        <div class="ai-button active" data-action="toggleAIMode" data-param="cost">
                            <i class="bi bi-currency-euro me-1"></i>Kosten-Optimierung
                        </div>
                        <div class="ai-button" data-action="toggleAIMode" data-param="nutrition">
                            <i class="bi bi-heart-pulse me-1"></i>N√§hrwert-Balance
                        </div>
                        <div class="ai-button" data-action="toggleAIMode" data-param="variety">
                            <i class="bi bi-palette me-1"></i>Abwechslung
                        </div>
                        <div class="ai-button" data-action="toggleAIMode" data-param="seasonal">
                            <i class="bi bi-leaf me-1"></i>Saisonal
                        </div>
                        <div class="ai-button" data-action="toggleAIMode" data-param="inventory">
                            <i class="bi bi-box-seam me-1"></i>Lagerbestand
                        </div>
                        <div class="ai-button ai-designer-btn" data-action="showModal" data-modal="aiDesignerModal">
                            <i class="bi bi-person-gear me-1"></i>Pers√∂nlich anpassen
                        </div>
                    </div>
                    <div id="aiStatus">
                        <small><i class="bi bi-check-circle me-1"></i>KI-Modus: Kosten-Optimierung aktiv</small>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-9">
                        <!-- Meal Planning Calendar -->
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <h5><i class="bi bi-calendar-week me-2"></i>Wochenplanung</h5>
                                <div class="calendar-nav">
                                    <button class="btn btn-outline-primary btn-sm" data-action="previousWeek">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <span id="currentWeek" class="fw-bold">KW 3, 2024</span>
                                    <button class="btn btn-outline-primary btn-sm" data-action="nextWeek">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="calendar-grid" id="mealCalendar">
                                <!-- Calendar will be generated by JavaScript -->
                            </div>
                            
                            <!-- Collapsible Info Panels -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="collapse-panel">
                                        <button class="btn btn-outline-primary w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#costCollapse">
                                            <i class="bi bi-currency-euro me-2"></i>Kosten-√úbersicht
                                            <i class="bi bi-chevron-down float-end"></i>
                                        </button>
                                        <div class="collapse" id="costCollapse">
                                            <div class="card card-body mt-2">
                                                <div class="cost-summary">
                                                    <div class="cost-item">
                                                        <span>Fr√ºhst√ºck</span>
                                                        <span id="breakfastCost">‚Ç¨0</span>
                                                    </div>
                                                    <div class="cost-item">
                                                        <span>Mittagessen</span>
                                                        <span id="lunchCost">‚Ç¨0</span>
                                                    </div>
                                                    <div class="cost-item">
                                                        <span>Abendessen</span>
                                                        <span id="dinnerCost">‚Ç¨0</span>
                                                    </div>
                                                    <div class="cost-item">
                                                        <span><strong>Gesamt/Woche</strong></span>
                                                        <span id="totalWeeklyCost"><strong>‚Ç¨0</strong></span>
                                                    </div>
                                                </div>
                                                <div class="text-center">
                                                    <span class="badge bg-success" id="savingsBadge">Keine Einsparungen</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="collapse-panel">
                                        <button class="btn btn-outline-success w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#nutritionCollapse">
                                            <i class="bi bi-heart-pulse me-2"></i>N√§hrwert-Balance
                                            <i class="bi bi-chevron-down float-end"></i>
                                        </button>
                                        <div class="collapse" id="nutritionCollapse">
                                            <div class="card card-body mt-2">
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span>Protein</span>
                                                        <span id="proteinPercent">25%</span>
                                                    </div>
                                                    <div class="nutrition-bar">
                                                        <div class="nutrition-fill protein" id="proteinBar" style="width: 25%"></div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span>Kohlenhydrate</span>
                                                        <span id="carbsPercent">45%</span>
                                                    </div>
                                                    <div class="nutrition-bar">
                                                        <div class="nutrition-fill carbs" id="carbsBar" style="width: 45%"></div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span>Fette</span>
                                                        <span id="fatPercent">30%</span>
                                                    </div>
                                                    <div class="nutrition-bar">
                                                        <div class="nutrition-fill fat" id="fatBar" style="width: 30%"></div>
                                                    </div>
                                                </div>
                                                <div class="text-center">
                                                    <span class="badge bg-success" id="nutritionStatus">Ausgewogen</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3">
                        <!-- Recipe Library -->
                        <div class="recipe-library">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="bi bi-book me-2"></i>Rezept-Bibliothek</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleBatchSelection()">
                                        <i class="bi bi-check-square me-1"></i>Auswahl
                                    </button>
                                    <span class="badge bg-info" id="recipeCount">0 Rezepte</span>
                                </div>
                            </div>
                            
                            <!-- Category Tabs -->
                            <ul class="nav nav-pills nav-fill mb-3" id="recipe-category-tabs">
                                <li class="nav-item">
                                    <button class="nav-link active btn-sm" data-category="all" onclick="filterRecipesByCategory('all')">
                                        <i class="bi bi-grid me-1"></i>Alle
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link btn-sm" data-category="breakfast" onclick="filterRecipesByCategory('breakfast')">
                                        <i class="bi bi-sunrise me-1"></i>Fr√ºhst√ºck
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link btn-sm" data-category="lunch" onclick="filterRecipesByCategory('lunch')">
                                        <i class="bi bi-sun me-1"></i>Mittag
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link btn-sm" data-category="dinner" onclick="filterRecipesByCategory('dinner')">
                                        <i class="bi bi-moon me-1"></i>Abend
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Search Bar -->
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="recipeSearchInput" placeholder="Rezepte suchen..." onkeyup="filterRecipes(this.value)">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearRecipeSearch()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters -->
                            <div class="mb-3">
                                <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                                    <i class="bi bi-funnel me-2"></i>Erweiterte Filter
                                    <i class="bi bi-chevron-down float-end"></i>
                                </button>
                                <div class="collapse mt-2" id="advancedFilters">
                                    <div class="card card-body">
                                        <!-- Price Range -->
                                        <div class="mb-3">
                                            <label class="form-label small">Preis pro Portion</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <input type="number" class="form-control form-control-sm" id="priceMin" placeholder="Min ‚Ç¨" step="0.50" min="0">
                                                </div>
                                                <div class="col-6">
                                                    <input type="number" class="form-control form-control-sm" id="priceMax" placeholder="Max ‚Ç¨" step="0.50" min="0">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Preparation Time -->
                                        <div class="mb-3">
                                            <label class="form-label small">Zubereitungszeit (Min)</label>
                                            <select class="form-select form-select-sm" id="prepTimeFilter">
                                                <option value="">Alle</option>
                                                <option value="15">< 15 Min</option>
                                                <option value="30">< 30 Min</option>
                                                <option value="60">< 60 Min</option>
                                                <option value="120">< 2 Stunden</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Allergens -->
                                        <div class="mb-3">
                                            <label class="form-label small">Allergene ausschlie√üen</label>
                                            <div class="allergen-filters">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="glutenFree" value="gluten">
                                                    <label class="form-check-label small" for="glutenFree">Glutenfrei</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="lactoseFree" value="lactose">
                                                    <label class="form-check-label small" for="lactoseFree">Laktosefrei</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="vegan" value="vegan">
                                                    <label class="form-check-label small" for="vegan">Vegan</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="vegetarian" value="vegetarian">
                                                    <label class="form-check-label small" for="vegetarian">Vegetarisch</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Season Filter -->
                                        <div class="mb-3">
                                            <label class="form-label small">Saison</label>
                                            <select class="form-select form-select-sm" id="seasonFilter">
                                                <option value="">Alle Jahreszeiten</option>
                                                <option value="spring">Fr√ºhling</option>
                                                <option value="summer">Sommer</option>
                                                <option value="autumn">Herbst</option>
                                                <option value="winter">Winter</option>
                                            </select>
                                        </div>
                                        
                                        <button class="btn btn-sm btn-primary" onclick="applyAdvancedFilters()">
                                            <i class="bi bi-check me-1"></i>Filter anwenden
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="resetAdvancedFilters()">
                                            <i class="bi bi-x me-1"></i>Zur√ºcksetzen
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Batch Operations Bar -->
                            <div class="batch-operations-bar mb-2" id="batchOperationsBar" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                    <span><span id="selectedRecipeCount">0</span> Rezepte ausgew√§hlt</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="batchEditRecipes()">
                                            <i class="bi bi-pencil me-1"></i>Bearbeiten
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="batchDeleteRecipes()">
                                            <i class="bi bi-trash me-1"></i>L√∂schen
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearBatchSelection()">
                                            <i class="bi bi-x me-1"></i>Auswahl aufheben
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recipe List with improved layout -->
                            <div id="recipeList" class="recipe-scroll-container">
                                <!-- Recipes will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== PRODUCTS TAB ===== -->
            <div id="products" class="tab-content">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="bi bi-box-seam me-2"></i>Produktverwaltung</h1>
                        <p class="text-muted">Verwalten Sie Ihre Produkte, Preise und Lagerbest√§nde</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" data-action="showModal" data-param="createProductModal">
                            <i class="bi bi-plus-circle me-2"></i>Neues Produkt
                        </button>
                        <button class="btn btn-outline-secondary" data-action="exportProducts">
                            <i class="bi bi-download me-2"></i>Export
                        </button>
                    </div>
                </div>

                <div class="products-table">
                    <div class="card-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" placeholder="Produkte suchen..." onkeyup="filterProducts(this.value)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" onchange="filterByCategory(this.value)">
                                    <option value="">Alle Kategorien</option>
                                    <option value="fleisch">Fleisch</option>
                                    <option value="gemuese">Gem√ºse</option>
                                    <option value="dairy">Milchprodukte</option>
                                    <option value="getraenke">Getr√§nke</option>
                                    <option value="backwaren">Backwaren</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" onchange="filterByStock(this.value)">
                                    <option value="">Alle Best√§nde</option>
                                    <option value="high">Hoch</option>
                                    <option value="medium">Mittel</option>
                                    <option value="low">Niedrig</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" onchange="filterByStatus(this.value)">
                                    <option value="">Alle Status</option>
                                    <option value="active">Aktiv</option>
                                    <option value="inactive">Inaktiv</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" data-action="clearProductFilters">
                                    <i class="bi bi-x-circle me-2"></i>Reset
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Artikelnummer</th>
                                        <th>Name</th>
                                        <th>Kategorie</th>
                                        <th>Preis</th>
                                        <th>Lagerbestand</th>
                                        <th>Lieferant</th>
                                        <th>Status</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Products will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== RECIPES TAB ===== -->
            <div id="recipes" class="tab-content">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="bi bi-book me-2"></i>Rezeptverwaltung</h1>
                        <p class="text-muted">Verwalten Sie Ihre Rezepte und Men√ºs</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" data-action="showModal" data-param="createRecipeModal">
                            <i class="bi bi-plus-circle me-2"></i>Neues Rezept
                        </button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-book fs-1 text-primary"></i>
                                <h5 class="card-title mt-2">Rezepte</h5>
                                <h3 class="text-primary" id="totalRecipes">127</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-heart fs-1 text-danger"></i>
                                <h5 class="card-title mt-2">Favoriten</h5>
                                <h3 class="text-danger" id="favoriteRecipes">23</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-people fs-1 text-success"></i>
                                <h5 class="card-title mt-2">√ò Portionen</h5>
                                <h3 class="text-success" id="averagePortions">45</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-currency-euro fs-1 text-warning"></i>
                                <h5 class="card-title mt-2">√ò Kosten</h5>
                                <h3 class="text-warning" id="averageCost">‚Ç¨3.45</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="row" id="recipeGrid">
                            <!-- Recipes will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== SUPPLIERS TAB ===== -->
            <div id="suppliers" class="tab-content">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="bi bi-truck me-2"></i>Lieferantenverwaltung</h1>
                        <p class="text-muted">Verwalten Sie Ihre Lieferanten und Bewertungen</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" data-action="showModal" data-param="createSupplierModal">
                            <i class="bi bi-plus-circle me-2"></i>Neuer Lieferant
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Lieferant</th>
                                        <th>Kontakt</th>
                                        <th>Produkte</th>
                                        <th>Bewertung</th>
                                        <th>Status</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="suppliersTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== ORDERS TAB ===== -->
            <div id="orders" class="tab-content">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="bi bi-cart-check me-2"></i>Bestellverwaltung</h1>
                        <p class="text-muted">Verwalten Sie Ihre Bestellungen und Lieferungen</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" data-action="showModal" data-param="createOrderModal">
                            <i class="bi bi-plus-circle me-2"></i>Neue Bestellung
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Bestellnummer</th>
                                        <th>Datum</th>
                                        <th>Lieferant</th>
                                        <th>Artikel</th>
                                        <th>Gesamtpreis</th>
                                        <th>Status</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== INVENTORY TAB ===== -->
            <div id="inventory" class="tab-content">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="bi bi-boxes me-2"></i>Lagerverwaltung</h1>
                        <p class="text-muted">Verwalten Sie Ihre Lagerbest√§nde und Inventur</p>
                    </div>
                    <div class="col-auto">
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary" data-action="startInventoryCheck">
                                <i class="bi bi-clipboard-check me-2"></i>Inventur starten
                            </button>
                            <button class="btn btn-success" data-action="showGoodsReceipts">
                                <i class="bi bi-truck me-2"></i>Wareneingang
                            </button>
                            <button class="btn btn-info" data-action="showPendingDeliveries">
                                <i class="bi bi-clock me-2"></i>Erwartete Lieferungen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Inventory Navigation -->
                <ul class="nav nav-tabs mb-3" id="inventoryTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button" role="tab">
                            <i class="bi bi-boxes me-1"></i>Lagerbestand
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="goods-receipts-tab" data-bs-toggle="tab" data-bs-target="#goods-receipts" type="button" role="tab">
                            <i class="bi bi-truck me-1"></i>Wareneingang
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-deliveries-tab" data-bs-toggle="tab" data-bs-target="#pending-deliveries" type="button" role="tab">
                            <i class="bi bi-clock me-1"></i>Erwartete Lieferungen
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="inventoryTabContent">
                    <!-- Stock Overview -->
                    <div class="tab-pane fade show active" id="stock" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Produkt</th>
                                                <th>Lagerort</th>
                                                <th>Bestand</th>
                                                <th>Mindestbestand</th>
                                                <th>F√ºllstand</th>
                                                <th>Wert</th>
                                                <th>Aktionen</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventoryTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Goods Receipts -->
                    <div class="tab-pane fade" id="goods-receipts" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-truck me-2"></i>Wareneing√§nge</h5>
                                <button class="btn btn-success btn-sm" data-action="createGoodsReceipt">
                                    <i class="bi bi-plus me-1"></i>Neuer Wareneingang
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Eingangsnummer</th>
                                                <th>Bestellung</th>
                                                <th>Lieferant</th>
                                                <th>Eingangsdatum</th>
                                                <th>Artikel</th>
                                                <th>Wert</th>
                                                <th>Status</th>
                                                <th>Aktionen</th>
                                            </tr>
                                        </thead>
                                        <tbody id="goodsReceiptsTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Deliveries -->
                    <div class="tab-pane fade" id="pending-deliveries" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Erwartete Lieferungen</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Bestellung</th>
                                                <th>Lieferant</th>
                                                <th>Lieferdatum</th>
                                                <th>Artikel</th>
                                                <th>Wert</th>
                                                <th>Status</th>
                                                <th>Tage bis Lieferung</th>
                                                <th>Aktionen</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pendingDeliveriesTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== ANALYTICS TAB ===== -->
            <div id="analytics" class="tab-content">
                <div class="row mb-4">
                    <div class="col">
                        <h1><i class="bi bi-graph-up me-2"></i>Analytics & Preisvergleich</h1>
                        <p class="text-muted">Analysieren Sie Kosten, Preise und Optimierungspotentiale</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" data-action="runPriceComparison">
                            <i class="bi bi-graph-up me-2"></i>Preisvergleich starten
                        </button>
                        <button class="btn btn-outline-info" data-action="exportAnalytics">
                            <i class="bi bi-file-earmark-text me-2"></i>Report exportieren
                        </button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Preisvergleich Top 10 Produkte</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="priceComparisonChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Kostenentwicklung</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="costTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Kosteneinsparungen Potentiale</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Produkt</th>
                                        <th>Aktueller Preis</th>
                                        <th>G√ºnstigster Preis</th>
                                        <th>Einsparung</th>
                                        <th>Lieferant</th>
                                        <th>Empfehlung</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Rindfleisch 1kg</strong></td>
                                        <td>‚Ç¨12.50</td>
                                        <td>‚Ç¨11.20</td>
                                        <td><strong class="text-success">‚Ç¨1.30</strong></td>
                                        <td>Fleischerei Weber</td>
                                        <td><span class="badge bg-success">Wechseln</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Kartoffeln 5kg</strong></td>
                                        <td>‚Ç¨3.20</td>
                                        <td>‚Ç¨2.80</td>
                                        <td><strong class="text-success">‚Ç¨0.40</strong></td>
                                        <td>Gro√ühandel Schmidt</td>
                                        <td><span class="badge bg-warning">Pr√ºfen</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Milch 3,5% 1L</strong></td>
                                        <td>‚Ç¨1.25</td>
                                        <td>‚Ç¨1.10</td>
                                        <td><strong class="text-success">‚Ç¨0.15</strong></td>
                                        <td>Molkerei Hansen</td>
                                        <td><span class="badge bg-success">Wechseln</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-light border-top mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        &copy; 2024 FoodSuite Pro - KI-gest√ºtzte Warenwirtschaft f√ºr Gro√ük√ºchen
                    </small>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">
                        Version 3.0.0 | 
                        <span class="system-status healthy">Healthy</span> |
                        <span id="lastSync">KI-Sync: aktiv</span>
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- ===== PRICE MONITORING TAB ===== -->
    <div id="price-monitoring" class="tab-content">
        <div class="container mt-4">
            <div class="row mb-4">
                <div class="col">
                    <h1><i class="bi bi-currency-euro me-2"></i>Preis√ºberwachung</h1>
                    <p class="text-muted">√úberwachen Sie Preisentwicklungen und erhalten Sie Alerts bei Preis√§nderungen</p>
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="showPriceAlertModal()">
                        <i class="bi bi-bell-fill me-2"></i>Preisalarm erstellen
                    </button>
                    <button class="btn btn-outline-info" onclick="exportPriceReport()">
                        <i class="bi bi-file-earmark-excel me-2"></i>Preisbericht exportieren
                    </button>
                </div>
            </div>

            <!-- Price Alert Summary -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h3 class="text-danger mb-0" id="priceIncreaseCount">0</h3>
                            <small class="text-muted">Preiserh√∂hungen diese Woche</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h3 class="text-success mb-0" id="priceDecreaseCount">0</h3>
                            <small class="text-muted">Preissenkungen diese Woche</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-0" id="activeAlertsCount">0</h3>
                            <small class="text-muted">Aktive Preisalarme</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h3 class="text-info mb-0" id="potentialSavings">‚Ç¨0</h3>
                            <small class="text-muted">M√∂gliche Einsparungen</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Trends -->
            <div class="row g-3 mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Preisentwicklung Top 10 Produkte</h5>
                            <select class="form-select form-select-sm w-auto" id="priceTrendPeriod">
                                <option value="7">Letzte 7 Tage</option>
                                <option value="30" selected>Letzte 30 Tage</option>
                                <option value="90">Letzte 90 Tage</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <canvas id="priceHistoryChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Gr√∂√üte Preis√§nderungen</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="biggestChanges">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Supplier Price Comparison -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Lieferanten-Preisvergleich</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Produkt</th>
                                    <th>Aktueller Lieferant</th>
                                    <th>Aktueller Preis</th>
                                    <th>G√ºnstigster Lieferant</th>
                                    <th>G√ºnstigster Preis</th>
                                    <th>M√∂gliche Ersparnis</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="supplierComparisonTable">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Active Price Alerts -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Aktive Preisalarme</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Produkt</th>
                                    <th>Alarm-Typ</th>
                                    <th>Schwellenwert</th>
                                    <th>Status</th>
                                    <th>Ausgel√∂st</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="priceAlertsTable">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Alert Modal -->
    <div class="modal fade" id="priceAlertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Preisalarm erstellen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="priceAlertForm">
                        <div class="mb-3">
                            <label class="form-label">Alarm Name</label>
                            <input type="text" class="form-control" id="alertName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Produkt</label>
                            <select class="form-select" id="alertProductId" required>
                                <option value="">Produkt w√§hlen...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alarm-Typ</label>
                            <select class="form-select" id="alertType" required>
                                <option value="increase">Preiserh√∂hung √ºber X%</option>
                                <option value="decrease">Preissenkung √ºber X%</option>
                                <option value="threshold_above">Preis √ºbersteigt Betrag</option>
                                <option value="threshold_below">Preis unterschreitet Betrag</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schwellenwert</label>
                            <input type="number" class="form-control" id="alertThreshold" step="0.01" required>
                            <small class="form-text text-muted">Prozent oder Euro-Betrag je nach Typ</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">E-Mail f√ºr Benachrichtigung</label>
                            <input type="email" class="form-control" id="alertEmail" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="createPriceAlert()">Alarm erstellen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">FoodSuite Pro</strong>
                <small class="text-muted">Jetzt</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ===== APPLICATION DATA =====
        
        const AppData = {
            currentTenant: 'demo',
            currentWeek: 3,
            aiMode: 'cost_optimized',
            
            // User management
            currentUser: null,
            userRoles: {},
            isLoggedIn: false,
            
            // Automation settings
            automationSettings: null,
            
            // Sample data
            recipes: [
                { id: 1, name: 'Rindergulasch', category: 'lunch', cost: 4.80, portions: 50, prepTime: 120, calories: 540, protein: 28, carbs: 35, fat: 20, tags: ['protein'] },
                { id: 2, name: 'Gem√ºsesuppe', category: 'dinner', cost: 1.90, portions: 30, prepTime: 45, calories: 280, protein: 8, carbs: 45, fat: 15, tags: ['vegetarian'] },
                { id: 3, name: 'M√ºsli-Buffet', category: 'breakfast', cost: 2.40, portions: 60, prepTime: 15, calories: 320, protein: 12, carbs: 60, fat: 25, tags: ['vegetarian'] },
                { id: 4, name: 'Pasta Arrabiata', category: 'lunch', cost: 3.20, portions: 40, prepTime: 30, calories: 480, protein: 15, carbs: 70, fat: 20, tags: ['vegetarian'] },
                { id: 5, name: 'Fischfilet', category: 'dinner', cost: 5.50, portions: 35, prepTime: 25, calories: 420, protein: 35, carbs: 10, fat: 25, tags: ['protein'] },
                { id: 6, name: 'Obstsalat', category: 'breakfast', cost: 1.80, portions: 40, prepTime: 20, calories: 180, protein: 2, carbs: 90, fat: 5, tags: ['vegan'] },
                { id: 7, name: 'Schnitzel', category: 'lunch', cost: 6.20, portions: 45, prepTime: 35, calories: 650, protein: 40, carbs: 20, fat: 35, tags: ['protein'] },
                { id: 8, name: 'K√ºrbissuppe', category: 'dinner', cost: 2.30, portions: 50, prepTime: 40, calories: 220, protein: 6, carbs: 50, fat: 10, tags: ['vegetarian'] },
                { id: 9, name: 'Pancakes', category: 'breakfast', cost: 2.10, portions: 30, prepTime: 25, calories: 380, protein: 8, carbs: 65, fat: 20, tags: ['vegetarian'] },
                { id: 10, name: 'Lasagne', category: 'lunch', cost: 4.90, portions: 40, prepTime: 90, calories: 520, protein: 25, carbs: 45, fat: 30, tags: ['vegetarian'] }
            ],
            
            products: [
                { id: 1, articleNumber: 'ART-001', name: 'Rindfleisch 1kg', category: 'fleisch', price: 12.50, stock: 45, minStock: 10, supplier: 'Metro AG', status: 'active' },
                { id: 2, articleNumber: 'ART-002', name: 'Kartoffeln 5kg', category: 'gemuese', price: 3.20, stock: 120, minStock: 50, supplier: 'Bio-Hof M√ºller', status: 'active' },
                { id: 3, articleNumber: 'ART-003', name: 'Milch 3,5% 1L', category: 'dairy', price: 1.25, stock: 80, minStock: 30, supplier: 'Gro√ühandel Schmidt', status: 'active' },
                { id: 4, articleNumber: 'ART-004', name: 'Mineralwasser 0,5L', category: 'getraenke', price: 0.45, stock: 200, minStock: 100, supplier: 'Metro AG', status: 'inactive' },
                { id: 5, articleNumber: 'ART-005', name: 'Brot Vollkorn 500g', category: 'backwaren', price: 2.80, stock: 25, minStock: 15, supplier: 'B√§ckerei M√ºller', status: 'active' },
                { id: 6, articleNumber: 'ART-006', name: 'H√§hnchenbrust 1kg', category: 'fleisch', price: 8.90, stock: 15, minStock: 20, supplier: 'Fleischerei Weber', status: 'active' },
                { id: 7, articleNumber: 'ART-007', name: 'Tomaten 1kg', category: 'gemuese', price: 2.50, stock: 8, minStock: 25, supplier: 'Bio-Hof M√ºller', status: 'active' },
                { id: 8, articleNumber: 'ART-008', name: 'K√§se Gouda 200g', category: 'dairy', price: 3.40, stock: 60, minStock: 20, supplier: 'Gro√ühandel Schmidt', status: 'active' }
            ],
            
            mealPlan: {},
            
            // Drag & Drop state
            draggedRecipe: null,
            draggedElement: null
        };

        // ===== USER MANAGEMENT & AUTHENTICATION =====
        
        async function initializeUserManagement() {
            console.log('üë• Initializing user management...');
            
            try {
                // Load user roles
                const rolesResponse = await fetch(`${API_BASE_URL}/auth/roles`, {
                    headers: { 'X-Tenant-ID': 'demo' }
                });
                
                if (rolesResponse.ok) {
                    AppData.userRoles = await rolesResponse.json();
                }
                
                // Check if user is already logged in
                const currentUserResponse = await fetch(`${API_BASE_URL}/auth/current-user`, {
                    headers: { 'X-Tenant-ID': 'demo' }
                });
                
                if (currentUserResponse.ok) {
                    AppData.currentUser = await currentUserResponse.json();
                    AppData.isLoggedIn = true;
                    updateUserInterface();
                } else {
                    // Auto-login as admin for demo
                    await loginUser('admin', 'admin123');
                }
                
            } catch (error) {
                console.error('Failed to initialize user management:', error);
                // Auto-login as admin for demo
                await loginUser('admin', 'admin123');
            }
        }
        
        async function loginUser(username, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': 'demo'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    AppData.currentUser = result.user;
                    AppData.isLoggedIn = true;
                    updateUserInterface();
                    
                    // Close login modal if open
                    const loginModal = document.getElementById('loginModal');
                    if (loginModal) {
                        const modal = bootstrap.Modal.getInstance(loginModal);
                        if (modal) modal.hide();
                    }
                    
                    showToast(`Willkommen, ${result.user.firstName}!`, 'success');
                    return true;
                } else {
                    const error = await response.json();
                    showToast(error.message || 'Login fehlgeschlagen', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Verbindungsfehler beim Login', 'error');
                return false;
            }
        }
        
        async function logoutUser() {
            try {
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    headers: { 'X-Tenant-ID': 'demo' }
                });
                
                AppData.currentUser = null;
                AppData.isLoggedIn = false;
                updateUserInterface();
                
                // Redirect to dashboard
                showTab('dashboard');
                showToast('Erfolgreich abgemeldet', 'info');
                
            } catch (error) {
                console.error('Logout error:', error);
                // Force logout on client side
                AppData.currentUser = null;
                AppData.isLoggedIn = false;
                updateUserInterface();
            }
        }
        
        function updateUserInterface() {
            const currentUserName = document.getElementById('currentUserName');
            const currentUserRole = document.getElementById('currentUserRole');
            const userMenuHeader = document.getElementById('userMenuHeader');
            const lastLoginTime = document.getElementById('lastLoginTime');
            
            if (AppData.isLoggedIn && AppData.currentUser) {
                const user = AppData.currentUser;
                const role = AppData.userRoles[user.role] || { name: user.role, icon: 'person', color: '#6c757d' };
                
                // Update user info in navbar
                if (currentUserName) {
                    currentUserName.textContent = `${user.firstName} ${user.lastName}`;
                }
                
                if (currentUserRole) {
                    currentUserRole.textContent = role.name;
                    currentUserRole.className = `badge ms-1`;
                    currentUserRole.style.backgroundColor = role.color;
                }
                
                if (userMenuHeader) {
                    userMenuHeader.innerHTML = `
                        <i class="bi bi-${role.icon} me-1" style="color: ${role.color}"></i>${role.name}
                    `;
                }
                
                if (lastLoginTime && user.lastLogin) {
                    const loginDate = new Date(user.lastLogin);
                    const timeDiff = Math.floor((Date.now() - loginDate.getTime()) / (1000 * 60));
                    if (timeDiff < 60) {
                        lastLoginTime.textContent = `vor ${timeDiff} Min.`;
                    } else if (timeDiff < 1440) {
                        lastLoginTime.textContent = `vor ${Math.floor(timeDiff / 60)} Std.`;
                    } else {
                        lastLoginTime.textContent = loginDate.toLocaleDateString();
                    }
                }
                
                // Show/hide UI elements based on permissions
                updatePermissionBasedUI(user);
                
            } else {
                // Show login prompt
                if (currentUserName) {
                    currentUserName.textContent = 'Nicht angemeldet';
                }
                
                if (currentUserRole) {
                    currentUserRole.textContent = 'Gast';
                    currentUserRole.className = 'badge bg-secondary ms-1';
                }
                
                if (userMenuHeader) {
                    userMenuHeader.innerHTML = '<i class="bi bi-person-circle me-1"></i>Nicht angemeldet';
                }
            }
        }
        
        function updatePermissionBasedUI(user) {
            const role = AppData.userRoles[user.role];
            if (!role) return;
            
            const permissions = role.permissions || [];
            
            // Hide/show navigation tabs based on permissions
            const navTabs = {
                'dashboard': true, // Always visible
                'meal-planning': permissions.includes('meal_planning_read') || permissions.includes('meal_planning_full'),
                'products': permissions.includes('inventory_read') || permissions.includes('inventory_full'),
                'recipes': permissions.includes('recipes_read') || permissions.includes('recipes_full'),
                'suppliers': permissions.includes('suppliers_read') || permissions.includes('suppliers_full'),
                'orders': permissions.includes('orders_read') || permissions.includes('orders_full'),
                'inventory': permissions.includes('inventory_read') || permissions.includes('inventory_full'),
                'analytics': permissions.includes('analytics_read') || permissions.includes('analytics_full')
            };
            
            Object.entries(navTabs).forEach(([tabId, isVisible]) => {
                const tabElement = document.querySelector(`a[data-tab="${tabId}"]`);
                if (tabElement) {
                    tabElement.style.display = isVisible ? 'block' : 'none';
                }
            });
            
            // Hide/show action buttons based on permissions  
            setTimeout(() => {
                // Delete buttons (only for admin and managers)
                const deleteButtons = document.querySelectorAll('.btn-danger, button[data-action*="delete"]');
                const canDelete = permissions.includes('delete_data') || user.role === 'admin';
                deleteButtons.forEach(btn => {
                    btn.style.display = canDelete ? 'inline-block' : 'none';
                });
                
                // Add approval buttons for meal planning if user can approve
                if (document.querySelector('#meal-planning.active') && permissions.includes('approve_meal_plans')) {
                    addApprovalButtons();
                }
            }, 500);
        }
        
        function addApprovalButtons() {
            const mealPlanContainer = document.querySelector('#meal-planning .calendar-container');
            if (!mealPlanContainer || document.querySelector('.approval-controls')) return;
            
            // Add approval controls at top of meal planning
            const approvalControls = document.createElement('div');
            approvalControls.className = 'approval-controls mb-3 p-3 bg-light border rounded';
            approvalControls.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Speiseplan-Genehmigung</h6>
                        <small class="text-muted">Status: <span class="badge bg-warning">Entwurf</span></small>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="submitMealPlanForApproval()">
                            <i class="bi bi-send"></i> Zur Genehmigung einreichen
                        </button>
                        <button class="btn btn-success btn-sm" onclick="approveMealPlan()">
                            <i class="bi bi-check-circle"></i> Genehmigen
                        </button>
                    </div>
                </div>
            `;
            
            mealPlanContainer.parentNode.insertBefore(approvalControls, mealPlanContainer);
        }
        
        function submitMealPlanForApproval() {
            showToast('Speiseplan zur Genehmigung eingereicht', 'info');
            const statusBadge = document.querySelector('.approval-controls .badge');
            if (statusBadge) {
                statusBadge.className = 'badge bg-warning';
                statusBadge.textContent = 'Eingereicht';
            }
        }
        
        function approveMealPlan() {
            showToast('Speiseplan genehmigt', 'success');
            const statusBadge = document.querySelector('.approval-controls .badge');
            if (statusBadge) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Genehmigt';
            }
        }
        
        function showUserManagement() {
            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            loadUserList();
            modal.show();
        }
        
        async function loadUserList() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'X-Tenant-ID': 'demo' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const users = data.items || [];
                    
                    const userList = document.getElementById('userList');
                    userList.innerHTML = users.map(user => {
                        const role = AppData.userRoles[user.role] || { name: user.role, icon: 'person', color: '#6c757d' };
                        return `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-${role.icon} me-3" style="color: ${role.color}"></i>
                                    <div>
                                        <h6 class="mb-0">${user.firstName} ${user.lastName}</h6>
                                        <small class="text-muted">${user.email} ‚Ä¢ ${role.name}</small>
                                    </div>
                                </div>
                                <div>
                                    <span class="badge ${user.isActive ? 'bg-success' : 'bg-secondary'}">
                                        ${user.isActive ? 'Aktiv' : 'Inaktiv'}
                                    </span>
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="editUser(${user.id})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    showToast('Fehler beim Laden der Benutzerliste', 'error');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                showToast('Verbindungsfehler beim Laden der Benutzer', 'error');
            }
        }
        
        function editUser(userId) {
            showToast(`Benutzer ${userId} bearbeiten - Feature in Entwicklung`, 'info');
        }
        
        function showUserProfile() {
            const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
            
            if (AppData.currentUser) {
                const user = AppData.currentUser;
                const role = AppData.userRoles[user.role] || { name: user.role };
                
                document.getElementById('profileName').value = `${user.firstName} ${user.lastName}`;
                document.getElementById('profileEmail').value = user.email;
                document.getElementById('profileRole').value = role.name;
                document.getElementById('profileLanguage').value = user.preferences?.language || 'de';
                document.getElementById('profileTheme').value = user.preferences?.theme || 'light';
                document.getElementById('profileNotifications').checked = user.preferences?.notifications || false;
            }
            
            modal.show();
        }
        
        function saveUserProfile() {
            showToast('Profil gespeichert', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('userProfileModal'));
            modal.hide();
        }
        
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            loginUser(username, password);
        }
        
        function handleProfileSave(event) {
            event.preventDefault();
            saveUserProfile();
        }

        // ===== COLLABORATIVE MEAL PLANNING =====
        
        // Store collaboration data
        const CollaborationData = {
            comments: new Map(),
            userActivity: new Map(),
            currentViewers: new Set(),
            changeHistory: [],
            activeDiscussions: new Map()
        };
        
        // Initialize collaboration features
        function initializeCollaboration() {
            console.log('ü§ù Initializing collaborative features...');
            
            // Set up real-time activity tracking
            trackUserActivity();
            
            // Load existing comments and discussions
            loadCollaborationData();
            
            // Set up change tracking for meal plans
            setupMealPlanChangeTracking();
            
            // Show online users indicator
            updateOnlineUsersDisplay();
        }
        
        function trackUserActivity() {
            const currentUser = AppData.currentUser;
            if (!currentUser) return;
            
            // Update user's last activity
            CollaborationData.userActivity.set(currentUser.id, {
                user: currentUser,
                lastSeen: new Date(),
                currentSection: 'dashboard',
                isActive: true
            });
            
            // Track tab changes
            document.addEventListener('click', function(e) {
                const tabLink = e.target.closest('[data-tab]');
                if (tabLink) {
                    const tabId = tabLink.getAttribute('data-tab');
                    updateUserActivity('currentSection', tabId);
                }
            });
            
            // Update activity every 30 seconds
            setInterval(() => {
                updateUserActivity('lastSeen', new Date());
            }, 30000);
        }
        
        function updateUserActivity(key, value) {
            const currentUser = AppData.currentUser;
            if (!currentUser) return;
            
            const activity = CollaborationData.userActivity.get(currentUser.id) || {};
            activity[key] = value;
            CollaborationData.userActivity.set(currentUser.id, activity);
            
            // Update online users display if on meal planning tab
            if (document.querySelector('#meal-planning.active')) {
                updateOnlineUsersDisplay();
            }
        }
        
        function updateOnlineUsersDisplay() {
            let onlineUsersContainer = document.querySelector('.online-users-indicator');
            
            if (!onlineUsersContainer) {
                // Create online users indicator in meal planning tab
                const mealPlanningTab = document.getElementById('meal-planning');
                if (!mealPlanningTab) return;
                
                onlineUsersContainer = document.createElement('div');
                onlineUsersContainer.className = 'online-users-indicator mb-3 p-2 bg-light border rounded';
                
                const tabHeader = mealPlanningTab.querySelector('h1').parentNode;
                tabHeader.appendChild(onlineUsersContainer);
            }
            
            const activeUsers = Array.from(CollaborationData.userActivity.values())
                .filter(activity => {
                    const timeDiff = Date.now() - new Date(activity.lastSeen).getTime();
                    return timeDiff < 5 * 60 * 1000; // Active in last 5 minutes
                });
            
            onlineUsersContainer.innerHTML = `
                <div class="d-flex align-items-center">
                    <small class="text-muted me-3">
                        <i class="bi bi-people-fill me-1"></i>
                        ${activeUsers.length} Benutzer aktiv
                    </small>
                    <div class="d-flex">
                        ${activeUsers.map(activity => {
                            const role = AppData.userRoles[activity.user.role] || {};
                            return `
                                <div class="d-flex align-items-center me-3" title="${activity.user.firstName} ${activity.user.lastName} - ${role.name}">
                                    <div class="online-indicator me-1" style="width: 8px; height: 8px; background: ${role.color || '#28a745'}; border-radius: 50%;"></div>
                                    <small>${activity.user.firstName}</small>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function setupMealPlanChangeTracking() {
            // Track drag & drop changes
            document.addEventListener('drop', function(e) {
                if (e.target.closest('.calendar-cell')) {
                    const recipeData = e.dataTransfer?.getData('text/plain');
                    if (recipeData) {
                        recordMealPlanChange('recipe_added', {
                            cell: e.target.closest('.calendar-cell').id,
                            recipe: JSON.parse(recipeData),
                            timestamp: new Date(),
                            user: AppData.currentUser
                        });
                    }
                }
            });

            // Add context menu for calendar cells
            document.addEventListener('contextmenu', function(e) {
                const calendarCell = e.target.closest('.calendar-cell');
                if (calendarCell) {
                    e.preventDefault();
                    showContextMenu(e, calendarCell.id);
                }
            });

            // Hide context menu on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });
        }

        function showContextMenu(event, cellId) {
            hideContextMenu(); // Hide any existing menu

            const cell = document.getElementById(cellId);
            const hasMeal = cell.classList.contains('has-meal');
            const hasComments = CollaborationData.comments.has(cellId);
            const canApprove = AppData.currentUser && AppData.userRoles[AppData.currentUser.role]?.permissions.includes('approve_meal_plans');

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.id = 'contextMenu';
            
            menu.innerHTML = `
                <div class="context-menu-item" onclick="showCommentsModal('${cellId}')">
                    <i class="bi bi-chat-dots"></i>
                    ${hasComments ? 'Kommentare anzeigen' : 'Kommentar hinzuf√ºgen'}
                </div>
                ${hasMeal ? `
                    <div class="context-menu-item" onclick="editMealPortion('${cellId}')">
                        <i class="bi bi-pencil"></i>
                        Portionen bearbeiten
                    </div>
                    <div class="context-menu-item" onclick="showNutritionInfo('${cellId}')">
                        <i class="bi bi-heart-pulse"></i>
                        N√§hrwerte anzeigen
                    </div>
                    <div class="context-menu-item" onclick="copyMealToOtherDay('${cellId}')">
                        <i class="bi bi-copy"></i>
                        An anderen Tag kopieren
                    </div>
                ` : `
                    <div class="context-menu-item" onclick="suggestRecipe('${cellId}')">
                        <i class="bi bi-lightbulb"></i>
                        Rezept vorschlagen
                    </div>
                `}
                ${canApprove ? `
                    <div class="context-menu-item" onclick="requestApproval('${cellId}')">
                        <i class="bi bi-check-circle"></i>
                        Genehmigung anfordern
                    </div>
                ` : ''}
                <div class="context-menu-item" onclick="showCellHistory('${cellId}')">
                    <i class="bi bi-clock-history"></i>
                    √Ñnderungshistorie
                </div>
            `;

            // Position menu
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';

            // Adjust position if menu goes off screen
            document.body.appendChild(menu);
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = (event.pageX - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = (event.pageY - rect.height) + 'px';
            }
        }

        function hideContextMenu() {
            const existingMenu = document.getElementById('contextMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
        }

        function editMealPortion(cellId) {
            hideContextMenu();
            const portionInput = prompt('Anzahl Portionen eingeben:', '50');
            if (portionInput && !isNaN(portionInput)) {
                recordMealPlanChange('portion_updated', {
                    cellId,
                    newPortion: parseInt(portionInput),
                    timestamp: new Date(),
                    user: AppData.currentUser
                });
                showToast(`Portionen auf ${portionInput} aktualisiert`, 'success');
            }
        }

        function showNutritionInfo(cellId) {
            hideContextMenu();
            const cell = document.getElementById(cellId);
            const mealName = cell.querySelector('.meal-name')?.textContent || 'Unbekanntes Gericht';
            
            showToast(`N√§hrwerte f√ºr "${mealName}" werden geladen...`, 'info');
            // In einer echten Anwendung w√ºrde hier eine API-Anfrage erfolgen
            setTimeout(() => {
                alert(`N√§hrwerte f√ºr ${mealName}:\n\nKalorien: 450 kcal\nProtein: 25g\nKohlenhydrate: 35g\nFett: 20g`);
            }, 1000);
        }

        function copyMealToOtherDay(cellId) {
            hideContextMenu();
            showToast('Mahlzeit in Zwischenablage kopiert - Rechtsklick auf Zielfeld zum Einf√ºgen', 'info');
            // In einer echten Anwendung w√ºrde hier eine Copy-Paste-Funktionalit√§t implementiert
        }

        function suggestRecipe(cellId) {
            hideContextMenu();
            const suggestions = [
                'Rindergulasch mit Kartoffeln',
                'Vegetarische Lasagne',
                'H√§hnchen-Curry mit Reis',
                'Gem√ºsesuppe',
                'Pasta Arrabiata'
            ];
            const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            
            if (confirm(`Vorschlag f√ºr diese Mahlzeit:\n\n"${randomSuggestion}"\n\nM√∂chten Sie dieses Rezept verwenden?`)) {
                showToast(`Rezept "${randomSuggestion}" hinzugef√ºgt`, 'success');
                recordMealPlanChange('recipe_suggested', {
                    cellId,
                    suggestedRecipe: randomSuggestion,
                    timestamp: new Date(),
                    user: AppData.currentUser
                });
            }
        }

        function requestApproval(cellId) {
            hideContextMenu();
            recordMealPlanChange('approval_requested', {
                cellId,
                timestamp: new Date(),
                user: AppData.currentUser
            });
            showToast('Genehmigung f√ºr diese Mahlzeit angefordert', 'info');
        }

        function showCellHistory(cellId) {
            hideContextMenu();
            const cellHistory = CollaborationData.changeHistory.filter(change => 
                change.details && change.details.cellId === cellId
            );

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-clock-history me-2"></i>
                                √Ñnderungshistorie
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${cellHistory.length > 0 ? cellHistory.map(change => {
                                const timeAgo = getTimeAgo(change.timestamp);
                                const role = AppData.userRoles[change.user.role] || {};
                                
                                return `
                                    <div class="d-flex align-items-start mb-3 p-3 border rounded">
                                        <i class="bi bi-${role.icon || 'person-circle'} me-3 mt-1" 
                                           style="color: ${role.color || '#6c757d'}"></i>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between">
                                                <strong>${change.user.firstName} ${change.user.lastName}</strong>
                                                <small class="text-muted">${timeAgo}</small>
                                            </div>
                                            <div class="text-muted">${getActionDescription(change.action)}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('') : '<p class="text-muted">Keine √Ñnderungen f√ºr diese Zelle gefunden.</p>'}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        function recordMealPlanChange(action, details) {
            const change = {
                id: Date.now(),
                action,
                details,
                timestamp: new Date(),
                user: AppData.currentUser
            };
            
            CollaborationData.changeHistory.unshift(change);
            
            // Keep only last 50 changes
            if (CollaborationData.changeHistory.length > 50) {
                CollaborationData.changeHistory = CollaborationData.changeHistory.slice(0, 50);
            }
            
            // Update change history display
            updateChangeHistoryDisplay();
            
            // Notify other users (in a real app, this would be via WebSocket)
            showChangeNotification(change);
        }
        
        function showChangeNotification(change) {
            if (change.user.id === AppData.currentUser?.id) return; // Don't show own changes
            
            const actionText = {
                'recipe_added': 'hat ein Rezept hinzugef√ºgt',
                'recipe_removed': 'hat ein Rezept entfernt',
                'comment_added': 'hat einen Kommentar hinzugef√ºgt',
                'approval_requested': 'hat eine Genehmigung angefordert'
            };
            
            showToast(
                `${change.user.firstName} ${actionText[change.action] || 'hat eine √Ñnderung vorgenommen'}`,
                'info',
                5000
            );
        }
        
        function addCommentToMealPlan(cellId, comment) {
            if (!comment.trim()) return;
            
            const newComment = {
                id: Date.now(),
                cellId,
                text: comment.trim(),
                user: AppData.currentUser,
                timestamp: new Date(),
                replies: []
            };
            
            if (!CollaborationData.comments.has(cellId)) {
                CollaborationData.comments.set(cellId, []);
            }
            
            CollaborationData.comments.get(cellId).push(newComment);
            
            // Record change
            recordMealPlanChange('comment_added', {
                cellId,
                comment: newComment
            });
            
            // Update UI
            updateCommentsDisplay(cellId);
            
            return newComment;
        }
        
        function showCommentsModal(cellId) {
            const cell = document.getElementById(cellId);
            if (!cell) return;
            
            const dayName = cell.getAttribute('data-day') || 'Unbekannt';
            const mealType = cell.getAttribute('data-meal') || 'Mahlzeit';
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'commentsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-chat-dots me-2"></i>
                                Diskussion: ${dayName} - ${mealType}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="comments-container mb-3" style="max-height: 300px; overflow-y: auto;">
                                <div id="commentsList">
                                    <!-- Comments will be loaded here -->
                                </div>
                            </div>
                            <div class="comment-form">
                                <form onsubmit="handleCommentSubmit(event, '${cellId}')">
                                    <div class="input-group">
                                        <input type="text" class="form-control" 
                                               id="newCommentText" 
                                               placeholder="Kommentar hinzuf√ºgen..." 
                                               required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send"></i> Senden
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            
            // Load comments
            loadCommentsForCell(cellId);
            
            bootstrapModal.show();
            
            // Clean up when modal is closed
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        function loadCommentsForCell(cellId) {
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;
            
            const comments = CollaborationData.comments.get(cellId) || [];
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-chat-dots fs-2"></i>
                        <p class="mt-2">Noch keine Kommentare</p>
                        <small>Seien Sie der Erste, der kommentiert!</small>
                    </div>
                `;
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => {
                const role = AppData.userRoles[comment.user.role] || {};
                const timeAgo = getTimeAgo(comment.timestamp);
                
                return `
                    <div class="comment-item mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-${role.icon || 'person-circle'} me-2" 
                                   style="color: ${role.color || '#6c757d'}"></i>
                                <strong>${comment.user.firstName} ${comment.user.lastName}</strong>
                                <small class="text-muted ms-2">${role.name}</small>
                            </div>
                            <small class="text-muted">${timeAgo}</small>
                        </div>
                        <p class="mb-0">${comment.text}</p>
                    </div>
                `;
            }).join('');
        }
        
        function handleCommentSubmit(event, cellId) {
            event.preventDefault();
            const commentText = document.getElementById('newCommentText').value;
            
            if (commentText.trim()) {
                addCommentToMealPlan(cellId, commentText);
                document.getElementById('newCommentText').value = '';
                loadCommentsForCell(cellId);
                
                // Add visual indicator to calendar cell
                addCommentIndicator(cellId);
            }
        }
        
        function addCommentIndicator(cellId) {
            const cell = document.getElementById(cellId);
            if (!cell) return;
            
            let indicator = cell.querySelector('.comment-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'comment-indicator position-absolute';
                indicator.style.cssText = 'top: 2px; right: 2px; z-index: 5;';
                indicator.innerHTML = '<i class="bi bi-chat-dots text-primary"></i>';
                indicator.title = 'Hat Kommentare - Klicken zum Anzeigen';
                indicator.onclick = () => showCommentsModal(cellId);
                
                cell.style.position = 'relative';
                cell.appendChild(indicator);
            }
            
            // Update comment count
            const comments = CollaborationData.comments.get(cellId) || [];
            indicator.innerHTML = `
                <span class="badge bg-primary rounded-pill">
                    <i class="bi bi-chat-dots me-1"></i>${comments.length}
                </span>
            `;
        }
        
        function updateChangeHistoryDisplay() {
            let historyContainer = document.querySelector('.change-history-container');
            
            if (!historyContainer) {
                // Create change history panel in meal planning
                const mealPlanningTab = document.getElementById('meal-planning');
                if (!mealPlanningTab) return;
                
                historyContainer = document.createElement('div');
                historyContainer.className = 'change-history-container mt-3';
                
                const calendarContainer = mealPlanningTab.querySelector('.calendar-container');
                if (calendarContainer && calendarContainer.parentNode) {
                    calendarContainer.parentNode.appendChild(historyContainer);
                }
            }
            
            const recentChanges = CollaborationData.changeHistory.slice(0, 5);
            
            historyContainer.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>
                            Letzte √Ñnderungen
                        </h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showFullChangeHistory()">
                            Alle anzeigen
                        </button>
                    </div>
                    <div class="card-body p-2">
                        ${recentChanges.length > 0 ? recentChanges.map(change => {
                            const timeAgo = getTimeAgo(change.timestamp);
                            const role = AppData.userRoles[change.user.role] || {};
                            
                            return `
                                <div class="d-flex align-items-center mb-2 p-2 border-bottom">
                                    <i class="bi bi-${role.icon || 'person-circle'} me-2" 
                                       style="color: ${role.color || '#6c757d'}"></i>
                                    <div class="flex-grow-1">
                                        <small>
                                            <strong>${change.user.firstName}</strong> 
                                            ${getActionDescription(change.action)}
                                        </small>
                                        <div class="text-muted" style="font-size: 0.75rem;">${timeAgo}</div>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<small class="text-muted">Keine √Ñnderungen</small>'}
                    </div>
                </div>
            `;
        }
        
        function getActionDescription(action) {
            const descriptions = {
                'recipe_added': 'hat ein Rezept hinzugef√ºgt',
                'recipe_removed': 'hat ein Rezept entfernt',
                'comment_added': 'hat kommentiert',
                'approval_requested': 'hat Genehmigung angefordert',
                'meal_plan_approved': 'hat Speiseplan genehmigt',
                'portion_updated': 'hat Portionen aktualisiert',
                'recipe_suggested': 'hat ein Rezept vorgeschlagen'
            };
            
            return descriptions[action] || 'hat eine √Ñnderung vorgenommen';
        }
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - new Date(timestamp);
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'gerade eben';
            if (minutes < 60) return `vor ${minutes} Min.`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `vor ${hours} Std.`;
            
            const days = Math.floor(hours / 24);
            return `vor ${days} Tag${days > 1 ? 'en' : ''}`;
        }
        
        function loadCollaborationData() {
            // In einer echten Anwendung w√ºrden diese Daten vom Server geladen
            // F√ºr Demo-Zwecke erstellen wir einige Beispielkommentare
            
            CollaborationData.comments.set('cell-monday-lunch', [
                {
                    id: 1,
                    cellId: 'cell-monday-lunch',
                    text: 'Sollten wir nicht eine vegetarische Alternative anbieten?',
                    user: { id: 2, firstName: 'Anna', lastName: 'M√ºller', role: 'chef' },
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                    replies: []
                },
                {
                    id: 2,
                    cellId: 'cell-monday-lunch',
                    text: 'Gute Idee! Ich schlage Gem√ºselasagne vor.',
                    user: { id: 4, firstName: 'Lisa', lastName: 'Weber', role: 'nutritionist' },
                    timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000), // 1 hour ago
                    replies: []
                }
            ]);
            
            // Add comment indicators for demo
            setTimeout(() => {
                addCommentIndicator('cell-monday-lunch');
            }, 1000);
        }
        
        function showFullChangeHistory() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-clock-history me-2"></i>
                                Vollst√§ndige √Ñnderungshistorie
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${CollaborationData.changeHistory.map(change => {
                                    const timeAgo = getTimeAgo(change.timestamp);
                                    const role = AppData.userRoles[change.user.role] || {};
                                    
                                    return `
                                        <div class="d-flex align-items-start mb-3 p-3 border rounded">
                                            <i class="bi bi-${role.icon || 'person-circle'} me-3 mt-1" 
                                               style="color: ${role.color || '#6c757d'}"></i>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between">
                                                    <strong>${change.user.firstName} ${change.user.lastName}</strong>
                                                    <small class="text-muted">${timeAgo}</small>
                                                </div>
                                                <div class="text-muted">${getActionDescription(change.action)}</div>
                                                ${change.details ? `<small class="text-muted mt-1 d-block">${JSON.stringify(change.details, null, 2)}</small>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        // ===== AUTOMATION SETTINGS & SMART WORKFLOWS =====
        
        async function initializeAutomationSettings() {
            console.log('‚öôÔ∏è Initializing automation settings...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/automation-settings`, {
                    headers: { 'X-Tenant-ID': TENANT_ID }
                });
                
                if (response.ok) {
                    AppData.automationSettings = await response.json();
                    console.log('‚úÖ Automation settings loaded:', AppData.automationSettings);
                } else {
                    console.warn('‚ö†Ô∏è Could not load automation settings, using defaults');
                    AppData.automationSettings = getDefaultAutomationSettings();
                }
                
                // Update UI based on automation settings
                updateAutomationUI();
                
            } catch (error) {
                console.error('‚ùå Failed to initialize automation settings:', error);
                AppData.automationSettings = getDefaultAutomationSettings();
            }
        }
        
        function getDefaultAutomationSettings() {
            return {
                einkaufslisten: 'manual',
                bestellungen: 'assisted',
                lieferanten: 'manual',
                lager: 'assisted',
                benachrichtigungen: true,
                preisvergleiche: true,
                saisonale_empfehlungen: true,
                auto_approval_limit: 500
            };
        }
        
        function updateAutomationUI() {
            // Add automation indicators to relevant sections
            addAutomationIndicators();
            
            // Update button labels based on automation mode
            updateButtonLabels();
        }
        
        function addAutomationIndicators() {
            const settings = AppData.automationSettings;
            if (!settings) return;
            
            // Add indicators to meal planning section
            const mealPlanningTab = document.getElementById('meal-planning');
            if (mealPlanningTab) {
                let automationIndicator = mealPlanningTab.querySelector('.automation-indicator');
                if (!automationIndicator) {
                    automationIndicator = document.createElement('div');
                    automationIndicator.className = 'automation-indicator alert alert-info d-flex align-items-center mb-3';
                    
                    const headerRow = mealPlanningTab.querySelector('.row').nextElementSibling;
                    if (headerRow) {
                        headerRow.parentNode.insertBefore(automationIndicator, headerRow);
                    }
                }
                
                const einkaufslistenMode = getModeLabel(settings.einkaufslisten);
                const bestellungenMode = getModeLabel(settings.bestellungen);
                
                automationIndicator.innerHTML = `
                    <i class="bi bi-gear-fill me-2"></i>
                    <div class="flex-grow-1">
                        <strong>Automatisierung aktiv:</strong>
                        Einkaufslisten: <span class="badge bg-${getModeColor(settings.einkaufslisten)}">${einkaufslistenMode}</span>
                        Bestellungen: <span class="badge bg-${getModeColor(settings.bestellungen)}">${bestellungenMode}</span>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="showAutomationSettings()">
                        <i class="bi bi-gear"></i> Einstellungen
                    </button>
                `;
            }
        }
        
        function getModeLabel(mode) {
            const labels = {
                'manual': 'Manuell',
                'assisted': 'Assistiert',
                'auto': 'Automatisch'
            };
            return labels[mode] || 'Unbekannt';
        }
        
        function getModeColor(mode) {
            const colors = {
                'manual': 'secondary',
                'assisted': 'warning',
                'auto': 'success'
            };
            return colors[mode] || 'secondary';
        }
        
        function updateButtonLabels() {
            const settings = AppData.automationSettings;
            if (!settings) return;
            
            // Update shopping list generation button
            setTimeout(() => {
                const generateButton = document.querySelector('[data-action="generateAIWeekMenu"]');
                if (generateButton && settings.einkaufslisten !== 'manual') {
                    const originalText = generateButton.textContent;
                    if (!originalText.includes('ü§ñ')) {
                        generateButton.innerHTML = `ü§ñ ${originalText}`;
                        generateButton.title = `Automatisierung: ${getModeLabel(settings.einkaufslisten)}`;
                    }
                }
            }, 2000);
        }
        
        function showAutomationSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'automationSettingsModal';
            
            const settings = AppData.automationSettings || getDefaultAutomationSettings();
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-gear-fill me-2"></i>
                                Automatisierungseinstellungen
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Hinweis:</strong> Sie k√∂nnen jederzeit zwischen automatischen KI-Vorschl√§gen und manueller Steuerung wechseln.
                            </div>
                            
                            <form id="automationSettingsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-cart me-2"></i>Einkaufslisten</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Wie sollen Einkaufslisten erstellt werden?</label>
                                            <select class="form-select" name="einkaufslisten">
                                                <option value="manual" ${settings.einkaufslisten === 'manual' ? 'selected' : ''}>
                                                    üü• Immer manuell erstellen
                                                </option>
                                                <option value="assisted" ${settings.einkaufslisten === 'assisted' ? 'selected' : ''}>
                                                    üü® KI-Vorschl√§ge + manuelle Freigabe (Empfohlen)
                                                </option>
                                                <option value="auto" ${settings.einkaufslisten === 'auto' ? 'selected' : ''}>
                                                    üü© Vollautomatisch generieren
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <h6><i class="bi bi-truck me-2"></i>Bestellungen</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Wie sollen Bestellungen abgewickelt werden?</label>
                                            <select class="form-select" name="bestellungen">
                                                <option value="manual" ${settings.bestellungen === 'manual' ? 'selected' : ''}>
                                                    üü• Immer manuell bestellen
                                                </option>
                                                <option value="assisted" ${settings.bestellungen === 'assisted' ? 'selected' : ''}>
                                                    üü® Bestellvorschl√§ge anzeigen (Empfohlen)
                                                </option>
                                                <option value="auto" ${settings.bestellungen === 'auto' ? 'selected' : ''}>
                                                    üü© Auto-Bestellungen mit Freigabe
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <h6><i class="bi bi-shop me-2"></i>Lieferanten</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Wie sollen Lieferanten ausgew√§hlt werden?</label>
                                            <select class="form-select" name="lieferanten">
                                                <option value="manual" ${settings.lieferanten === 'manual' ? 'selected' : ''}>
                                                    üü• Manuell ausw√§hlen
                                                </option>
                                                <option value="assisted" ${settings.lieferanten === 'assisted' ? 'selected' : ''}>
                                                    üü® KI-Empfehlungen anzeigen
                                                </option>
                                                <option value="auto" ${settings.lieferanten === 'auto' ? 'selected' : ''}>
                                                    üü© Automatisch den g√ºnstigsten w√§hlen
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-boxes me-2"></i>Lagerverwaltung</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Wie soll das Lager verwaltet werden?</label>
                                            <select class="form-select" name="lager">
                                                <option value="manual" ${settings.lager === 'manual' ? 'selected' : ''}>
                                                    üü• Manuell aktualisieren
                                                </option>
                                                <option value="assisted" ${settings.lager === 'assisted' ? 'selected' : ''}>
                                                    üü® Automatisch + manuelle Kontrolle (Empfohlen)
                                                </option>
                                                <option value="auto" ${settings.lager === 'auto' ? 'selected' : ''}>
                                                    üü© Vollautomatisch verwalten
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <h6><i class="bi bi-currency-euro me-2"></i>Erweiterte Einstellungen</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Auto-Genehmigungsgrenze (EUR)</label>
                                            <input type="number" class="form-control" name="auto_approval_limit" 
                                                   value="${settings.auto_approval_limit || 500}" min="0" max="10000" step="50">
                                            <small class="form-text text-muted">Bestellungen bis zu diesem Betrag werden automatisch genehmigt</small>
                                        </div>
                                        
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="benachrichtigungen" 
                                                   ${settings.benachrichtigungen ? 'checked' : ''}>
                                            <label class="form-check-label">E-Mail-Benachrichtigungen</label>
                                        </div>
                                        
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="preisvergleiche" 
                                                   ${settings.preisvergleiche ? 'checked' : ''}>
                                            <label class="form-check-label">Automatische Preisvergleiche</label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="saisonale_empfehlungen" 
                                                   ${settings.saisonale_empfehlungen ? 'checked' : ''}>
                                            <label class="form-check-label">Saisonale Empfehlungen anzeigen</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <h6>üè≠ Empfohlene Einstellungen nach Betriebstyp:</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadRecommendations('small_kitchen')">
                                            Kleine K√ºche
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadRecommendations('canteen')">
                                            Kantine
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadRecommendations('catering')">
                                            Catering
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadRecommendations('hospital')">
                                            Krankenhaus
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-outline-danger" onclick="resetToDefaults()">Zur√ºcksetzen</button>
                            <button type="button" class="btn btn-primary" onclick="saveAutomationSettings()">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        async function loadRecommendations(businessType) {
            try {
                const response = await fetch(`${API_BASE_URL}/automation-settings/recommendations/${businessType}`, {
                    headers: { 'X-Tenant-ID': TENANT_ID }
                });
                
                if (response.ok) {
                    const recommendations = await response.json();
                    
                    // Update form with recommendations
                    const form = document.getElementById('automationSettingsForm');
                    Object.entries(recommendations).forEach(([key, value]) => {
                        const field = form.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (field.type === 'checkbox') {
                                field.checked = value;
                            } else {
                                field.value = value;
                            }
                        }
                    });
                    
                    showToast(`Empfohlene Einstellungen f√ºr ${businessType} geladen`, 'success');
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                showToast('Fehler beim Laden der Empfehlungen', 'error');
            }
        }
        
        function resetToDefaults() {
            if (confirm('M√∂chten Sie wirklich alle Einstellungen auf die Standardwerte zur√ºcksetzen?')) {
                const defaults = getDefaultAutomationSettings();
                const form = document.getElementById('automationSettingsForm');
                
                Object.entries(defaults).forEach(([key, value]) => {
                    const field = form.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = value;
                        } else {
                            field.value = value;
                        }
                    }
                });
                
                showToast('Einstellungen auf Standardwerte zur√ºckgesetzt', 'info');
            }
        }
        
        async function saveAutomationSettings() {
            try {
                const form = document.getElementById('automationSettingsForm');
                const formData = new FormData(form);
                
                const settings = {};
                for (const [key, value] of formData.entries()) {
                    if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
                        settings[key] = true;
                    } else if (key === 'auto_approval_limit') {
                        settings[key] = parseInt(value);
                    } else {
                        settings[key] = value;
                    }
                }
                
                // Add unchecked checkboxes
                const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        settings[checkbox.name] = false;
                    }
                });
                
                const response = await fetch(`${API_BASE_URL}/automation-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': TENANT_ID
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    AppData.automationSettings = await response.json();
                    updateAutomationUI();
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('automationSettingsModal'));
                    modal.hide();
                    
                    showToast('Automatisierungseinstellungen gespeichert', 'success');
                } else {
                    showToast('Fehler beim Speichern der Einstellungen', 'error');
                }
                
            } catch (error) {
                console.error('Error saving automation settings:', error);
                showToast('Verbindungsfehler beim Speichern', 'error');
            }
        }
        
        // ===== INTELLIGENT SHOPPING LIST GENERATOR =====
        
        async function generateIntelligentShoppingList() {
            const settings = AppData.automationSettings;
            if (!settings) {
                showToast('Automatisierungseinstellungen werden geladen...', 'info');
                return;
            }
            
            const mode = settings.einkaufslisten;
            const weekNumber = AppData.currentWeek;
            const year = new Date().getFullYear();
            
            try {
                showToast('üõí Einkaufsliste wird generiert...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/shopping-list/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': TENANT_ID
                    },
                    body: JSON.stringify({ weekNumber, year, mode })
                });
                
                if (response.ok) {
                    const shoppingList = await response.json();
                    showShoppingListModal(shoppingList);
                } else {
                    showToast('Fehler beim Generieren der Einkaufsliste', 'error');
                }
                
            } catch (error) {
                console.error('Error generating shopping list:', error);
                showToast('Verbindungsfehler beim Generieren der Einkaufsliste', 'error');
            }
        }
        
        function showShoppingListModal(shoppingList) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'shoppingListModal';
            
            const automationBadge = getModeLabel(shoppingList.automation_mode);
            const automationColor = getModeColor(shoppingList.automation_mode);
            
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-cart-fill me-2"></i>
                                Intelligente Einkaufsliste KW ${shoppingList.week_info?.weekNumber || AppData.currentWeek}
                                <span class="badge bg-${automationColor} ms-2">${automationBadge}</span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${shoppingList.items.length === 0 ? `
                                <div class="alert alert-info text-center">
                                    <i class="bi bi-info-circle fs-2"></i>
                                    <h5 class="mt-3">Keine Artikel ben√∂tigt</h5>
                                    <p class="mb-0">${shoppingList.message || 'Alle ben√∂tigten Artikel sind ausreichend auf Lager.'}</p>
                                </div>
                            ` : `
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <div class="row">
                                            <div class="col-3">
                                                <div class="text-center">
                                                    <div class="h4 text-primary">${shoppingList.summary.total_items}</div>
                                                    <small class="text-muted">Artikel</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="text-center">
                                                    <div class="h4 text-success">‚Ç¨${shoppingList.summary.total_cost.toFixed(2)}</div>
                                                    <small class="text-muted">Gesch√§tzte Kosten</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="text-center">
                                                    <div class="h4 text-danger">${shoppingList.summary.high_priority_items}</div>
                                                    <small class="text-muted">Dringend</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="text-center">
                                                    <div class="h4 text-info">${shoppingList.summary.categories.length}</div>
                                                    <small class="text-muted">Kategorien</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-success" onclick="generateOrderSuggestions()">
                                                <i class="bi bi-truck"></i> Bestellvorschl√§ge generieren
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="exportShoppingList()">
                                                <i class="bi bi-download"></i> Liste exportieren
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Artikel</th>
                                                <th>Kategorie</th>
                                                <th>Ben√∂tigt</th>
                                                <th>Lager</th>
                                                <th>Bestellen</th>
                                                <th>Kosten</th>
                                                <th>Lieferant</th>
                                                <th>Priorit√§t</th>
                                                <th>Aktion</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${shoppingList.items.map(item => `
                                                <tr class="${item.priority === 'high' ? 'table-warning' : ''}">
                                                    <td>
                                                        <strong>${item.product_name}</strong>
                                                        ${item.notes ? `<br><small class="text-muted">${item.notes}</small>` : ''}
                                                    </td>
                                                    <td><span class="badge bg-secondary">${item.category}</span></td>
                                                    <td>${item.required_quantity} kg</td>
                                                    <td>
                                                        <span class="${item.current_stock < 10 ? 'text-danger' : 'text-success'}">
                                                            ${item.current_stock} kg
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               value="${item.order_quantity}" min="0" step="1"
                                                               style="width: 80px;" onchange="updateItemCost(this, ${item.product_id})">
                                                    </td>
                                                    <td class="item-cost">‚Ç¨${item.estimated_cost.toFixed(2)}</td>
                                                    <td>${item.supplier_suggestion}</td>
                                                    <td>
                                                        <span class="badge bg-${item.priority === 'high' ? 'danger' : 'warning'}">
                                                            ${item.priority === 'high' ? 'Dringend' : 'Normal'}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromList(${item.product_id})">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                            ${shoppingList.items.length > 0 ? `
                                <button type="button" class="btn btn-outline-primary" onclick="editShoppingList()">Bearbeiten</button>
                                <button type="button" class="btn btn-success" onclick="generateOrderSuggestions()">Bestellen</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
            
            // Store shopping list data for order generation
            window.currentShoppingList = shoppingList;
        }
        
        async function generateOrderSuggestions() {
            const shoppingList = window.currentShoppingList;
            if (!shoppingList || !shoppingList.items.length) {
                showToast('Keine Einkaufsliste verf√ºgbar', 'error');
                return;
            }
            
            try {
                showToast('üì¶ Bestellvorschl√§ge werden generiert...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/orders/suggest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': TENANT_ID
                    },
                    body: JSON.stringify({ 
                        shopping_list_items: shoppingList.items,
                        group_by_supplier: true 
                    })
                });
                
                if (response.ok) {
                    const orderSuggestions = await response.json();
                    showOrderSuggestionsModal(orderSuggestions);
                } else {
                    showToast('Fehler beim Generieren der Bestellvorschl√§ge', 'error');
                }
                
            } catch (error) {
                console.error('Error generating order suggestions:', error);
                showToast('Verbindungsfehler beim Generieren der Bestellvorschl√§ge', 'error');
            }
        }
        
        function showOrderSuggestionsModal(orderSuggestions) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'orderSuggestionsModal';
            
            const automationBadge = getModeLabel(orderSuggestions.automation_mode);
            const automationColor = getModeColor(orderSuggestions.automation_mode);
            
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-truck-flatbed me-2"></i>
                                Intelligente Bestellvorschl√§ge
                                <span class="badge bg-${automationColor} ms-2">${automationBadge}</span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="h4 text-primary">${orderSuggestions.summary.total_suppliers}</div>
                                            <small class="text-muted">Lieferanten</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="h4 text-success">‚Ç¨${orderSuggestions.summary.total_cost.toFixed(2)}</div>
                                            <small class="text-muted">Gesamtkosten</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="h4 text-danger">${orderSuggestions.summary.high_priority_orders}</div>
                                            <small class="text-muted">Dringende Bestellungen</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="h4 text-success">${orderSuggestions.summary.auto_approved_orders || 0}</div>
                                            <small class="text-muted">Auto-genehmigt</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${orderSuggestions.suggestions.length === 0 ? `
                                <div class="alert alert-info text-center">
                                    <i class="bi bi-info-circle fs-2"></i>
                                    <h5 class="mt-3">Keine Bestellungen erforderlich</h5>
                                    <p class="mb-0">Alle ben√∂tigten Artikel sind ausreichend auf Lager.</p>
                                </div>
                            ` : `
                                <div class="accordion" id="orderSuggestionsAccordion">
                                    ${orderSuggestions.suggestions.map((suggestion, index) => `
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="heading${index}">
                                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                        <div>
                                                            <strong>${suggestion.supplier_name}</strong>
                                                            <span class="badge bg-${suggestion.priority === 'high' ? 'danger' : 'warning'} ms-2">
                                                                ${suggestion.priority === 'high' ? 'Dringend' : 'Normal'}
                                                            </span>
                                                            ${suggestion.automation_action === 'auto_order' ? 
                                                                '<span class="badge bg-success ms-2">Auto-Bestellung</span>' : 
                                                                '<span class="badge bg-secondary ms-2">Vorschlag</span>'
                                                            }
                                                        </div>
                                                        <div class="text-end">
                                                            <div class="h6 mb-0">‚Ç¨${suggestion.total_cost.toFixed(2)}</div>
                                                            <small class="text-muted">${suggestion.item_count} Artikel</small>
                                                        </div>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                                 data-bs-parent="#orderSuggestionsAccordion">
                                                <div class="accordion-body">
                                                    <div class="row mb-3">
                                                        <div class="col-md-8">
                                                            <div class="row">
                                                                <div class="col-4">
                                                                    <small class="text-muted">E-Mail:</small><br>
                                                                    <strong>${suggestion.supplier_email}</strong>
                                                                </div>
                                                                <div class="col-4">
                                                                    <small class="text-muted">Lieferung:</small><br>
                                                                    <strong>${suggestion.estimated_delivery}</strong>
                                                                </div>
                                                                <div class="col-4">
                                                                    <small class="text-muted">Mindestbestellwert:</small><br>
                                                                    <strong>‚Ç¨${suggestion.min_order_value}</strong>
                                                                    ${suggestion.meets_minimum ? 
                                                                        '<i class="bi bi-check-circle text-success ms-1"></i>' : 
                                                                        '<i class="bi bi-exclamation-triangle text-warning ms-1"></i>'
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="d-grid gap-2">
                                                                <button class="btn btn-success btn-sm" onclick="createOrderFromSuggestion(${index})">
                                                                    <i class="bi bi-plus-circle"></i> Bestellung erstellen
                                                                </button>
                                                                <button class="btn btn-outline-primary btn-sm" onclick="sendOrderEmail(${index})">
                                                                    <i class="bi bi-envelope"></i> E-Mail senden
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="table-responsive">
                                                        <table class="table table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Artikel</th>
                                                                    <th>Menge</th>
                                                                    <th>Einzelpreis</th>
                                                                    <th>Gesamtpreis</th>
                                                                    <th>Priorit√§t</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${suggestion.items.map(item => `
                                                                    <tr>
                                                                        <td>${item.product_name}</td>
                                                                        <td>${item.order_quantity} kg</td>
                                                                        <td>‚Ç¨${(item.estimated_cost / item.order_quantity).toFixed(2)}</td>
                                                                        <td>‚Ç¨${item.estimated_cost.toFixed(2)}</td>
                                                                        <td>
                                                                            <span class="badge bg-${item.priority === 'high' ? 'danger' : 'warning'}">
                                                                                ${item.priority === 'high' ? 'Dringend' : 'Normal'}
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                            ${orderSuggestions.suggestions.length > 0 ? `
                                <button type="button" class="btn btn-outline-primary" onclick="exportOrderSuggestions()">Exportieren</button>
                                <button type="button" class="btn btn-success" onclick="createAllOrders()">Alle Bestellungen erstellen</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
            
            // Store order suggestions for actions
            window.currentOrderSuggestions = orderSuggestions;
        }
        
        function createOrderFromSuggestion(suggestionIndex) {
            const suggestions = window.currentOrderSuggestions;
            if (!suggestions || !suggestions.suggestions[suggestionIndex]) return;
            
            const suggestion = suggestions.suggestions[suggestionIndex];
            
            showToast(`Bestellung an ${suggestion.supplier_name} wird erstellt...`, 'info');
            
            // In a real application, this would create an actual order
            setTimeout(() => {
                showToast(`‚úÖ Bestellung #BES-${Date.now()} an ${suggestion.supplier_name} erstellt (‚Ç¨${suggestion.total_cost.toFixed(2)})`, 'success');
            }, 1500);
        }
        
        function sendOrderEmail(suggestionIndex) {
            const suggestions = window.currentOrderSuggestions;
            if (!suggestions || !suggestions.suggestions[suggestionIndex]) return;
            
            const suggestion = suggestions.suggestions[suggestionIndex];
            
            showToast(`E-Mail an ${suggestion.supplier_email} wird gesendet...`, 'info');
            
            setTimeout(() => {
                showToast(`üìß Bestellanfrage an ${suggestion.supplier_name} gesendet`, 'success');
            }, 1000);
        }
        
        function createAllOrders() {
            const suggestions = window.currentOrderSuggestions;
            if (!suggestions || suggestions.suggestions.length === 0) return;
            
            if (confirm(`M√∂chten Sie wirklich ${suggestions.suggestions.length} Bestellungen erstellen?\n\nGesamtkosten: ‚Ç¨${suggestions.summary.total_cost.toFixed(2)}`)) {
                showToast('Alle Bestellungen werden erstellt...', 'info');
                
                setTimeout(() => {
                    showToast(`‚úÖ ${suggestions.suggestions.length} Bestellungen erfolgreich erstellt!`, 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('orderSuggestionsModal'));
                    if (modal) modal.hide();
                }, 2000);
            }
        }
        
        function exportShoppingList() {
            showToast('Einkaufsliste wird als CSV exportiert...', 'info');
            setTimeout(() => showToast('‚úÖ CSV-Datei heruntergeladen', 'success'), 1000);
        }
        
        function exportOrderSuggestions() {
            showToast('Bestellvorschl√§ge werden als PDF exportiert...', 'info');
            setTimeout(() => showToast('‚úÖ PDF-Datei heruntergeladen', 'success'), 1000);
        }

        // ===== NAVIGATION & TABS =====
        
        function showTab(tabId) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Update navigation
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            const activeLink = document.querySelector(`a[href="#${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Load tab-specific data
            loadTabData(tabId);
        }

        function loadTabData(tabId) {
            switch (tabId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'meal-planning':
                    loadMealPlanning();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'suppliers':
                    loadSuppliers();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'recipes':
                    loadRecipes();
                    break;
                case 'price-monitoring':
                    loadPriceMonitoring();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                default:
                    console.log(`Loading tab: ${tabId}`);
                    break;
            }
        }

        function switchTenant(tenantId) {
            AppData.currentTenant = tenantId;
            const tenantNames = {
                'demo': 'Demo Restaurant',
                'hotel': 'Grand Hotel',
                'cafeteria': 'Uni Cafeteria'
            };
            document.getElementById('currentTenant').textContent = tenantNames[tenantId];
            showToast(`Gewechselt zu ${tenantNames[tenantId]}`, 'info');
        }

        // ===== DASHBOARD =====
        
        async function loadDashboard() {
            try {
                // Show loading state
                document.getElementById('activeProductsCount').textContent = '...';
                document.getElementById('lowStockCount').textContent = '...';
                
                // Load dashboard stats from API
                const stats = await api.getDashboardStats();
                
                // Update all metrics
                document.getElementById('activeProductsCount').textContent = stats.activeProducts.toLocaleString();
                document.getElementById('lowStockCount').textContent = stats.lowStockProducts;
                
                // Update additional metrics from analytics
                const activeSuppliersElement = document.getElementById('activeSuppliersCount');
                if (activeSuppliersElement) {
                    activeSuppliersElement.textContent = stats.activeSuppliers;
                }
                
                const activeRecipesElement = document.getElementById('activeRecipesCount');
                if (activeRecipesElement) {
                    activeRecipesElement.textContent = stats.activeRecipes;
                }
                
                const inventoryValueElement = document.getElementById('inventoryValue');
                if (inventoryValueElement) {
                    inventoryValueElement.textContent = '‚Ç¨' + stats.inventoryValue.toLocaleString();
                }
                
                const costSavingsElement = document.getElementById('costSavings');
                if (costSavingsElement) {
                    costSavingsElement.textContent = '‚Ç¨' + stats.costSavings.toLocaleString();
                }
                
                const ordersTodayElement = document.getElementById('ordersToday');
                if (ordersTodayElement) {
                    ordersTodayElement.textContent = stats.ordersToday;
                }
                
                // Update notification badge
                const lowStockBadge = document.querySelector('.notification-badge');
                if (lowStockBadge) {
                    lowStockBadge.textContent = stats.lowStockProducts;
                    lowStockBadge.style.display = stats.lowStockProducts > 0 ? 'flex' : 'none';
                }
                
                // Load charts
                loadExpensesChart();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('activeProductsCount').textContent = '0';
                document.getElementById('lowStockCount').textContent = '0';
                showToast('Fehler beim Laden der Dashboard-Daten', 'error');
            }
        }

        function loadExpensesChart() {
            const ctx = document.getElementById('expensesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.expensesChart instanceof Chart) {
                window.expensesChart.destroy();
            }
            
            window.expensesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['KW 1', 'KW 2', 'KW 3', 'KW 4', 'KW 5'],
                    datasets: [{
                        label: 'Normale Ausgaben (‚Ç¨)',
                        data: [2400, 2200, 2800, 2600, 2750],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'KI-Optimiert (‚Ç¨)',
                        data: [2100, 1950, 2450, 2280, 2350],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===== MEAL PLANNING =====
        
        function loadMealPlanning() {
            createMealCalendar();
            loadRecipeLibrary();
            updateCostSummary();
            updateNutritionBalance();
            
            // Auto-generate AI meal plan if calendar is empty
            setTimeout(() => {
                const mealPlanKeys = Object.keys(AppData.mealPlan);
                const displayedMeals = document.querySelectorAll('.meal-slot .meal-event').length;
                
                if (mealPlanKeys.length === 0 && displayedMeals === 0) {
                    console.log('ü§ñ Calendar is empty - auto-generating AI meal plan...');
                    showToast('ü§ñ KI generiert automatisch Ihren Wochenplan...', 'info');
                    generateAIWeekMenu();
                }
            }, 1500);
        }

        function updateCalendarCell(cell, slot) {
            // Aktualisiere eine einzelne Kalenderzelle
            const meal = AppData.mealPlan[slot];
            if (meal) {
                const [day, mealType] = slot.split('-');
                const mealClass = mealType === 'breakfast' ? 'breakfast' : 
                                  mealType === 'lunch' ? 'lunch' : 'dinner';
                
                cell.innerHTML = `
                    <div class="meal-event ${mealClass}" draggable="true" data-recipe-id="${meal.id}">
                        <div class="meal-title">${meal.name}</div>
                        <div class="meal-details">
                            ${meal.portions || 400} Portionen
                            ‚Ç¨${(meal.cost || 3.50).toFixed(2)}/Portion
                        </div>
                    </div>
                `;
                
                // Drag event handlers neu setzen
                const mealEvent = cell.querySelector('.meal-event');
                if (mealEvent) {
                    mealEvent.addEventListener('dragstart', handleDragStart);
                    mealEvent.addEventListener('dragend', handleDragEnd);
                }
                
                cell.classList.add('has-meal');
            } else {
                cell.innerHTML = '<div class="calendar-cell-empty">Ziehen Sie ein Rezept hierher</div>';
                cell.classList.remove('has-meal');
            }
        }
        
        function createMealCalendar() {
            const calendar = document.getElementById('mealCalendar');
            const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const mealTypes = ['breakfast', 'lunch', 'dinner'];
            const mealLabels = ['Fr√ºhst√ºck', 'Mittagessen', 'Abendessen'];
            
            // Create proper HTML table structure for better readability
            calendar.innerHTML = `
                <table class="meal-planning-table table table-bordered">
                    <thead>
                        <tr>
                            <th class="time-header">Mahlzeit</th>
                            ${days.map(day => `<th class="day-header">${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody id="calendarTableBody">
                    </tbody>
                </table>
            `;
            
            const tableBody = document.getElementById('calendarTableBody');
            
            // Create rows for each meal type
            mealTypes.forEach((mealType, mealIndex) => {
                const row = document.createElement('tr');
                row.className = `meal-row meal-${mealType}`;
                
                // Meal type label cell
                const labelCell = document.createElement('td');
                labelCell.className = 'meal-label-cell';
                labelCell.innerHTML = `
                    <div class="meal-label">
                        <i class="bi bi-${mealType === 'breakfast' ? 'sunrise' : mealType === 'lunch' ? 'sun' : 'moon'}"></i>
                        ${mealLabels[mealIndex]}
                    </div>
                `;
                row.appendChild(labelCell);
                
                // Day cells for this meal type
                dayKeys.forEach((dayKey, dayIndex) => {
                    const slot = `${dayKey}-${mealType}`;
                    const dayCell = document.createElement('td');
                    dayCell.className = 'calendar-cell meal-slot';
                    dayCell.dataset.day = dayKey;
                    dayCell.dataset.meal = mealType;
                    dayCell.dataset.slot = slot;
                
                    // Check if there's a meal planned for this specific slot
                    const plannedMeal = AppData.mealPlan[slot];
                    if (plannedMeal) {
                        const recipe = AppData.recipes.find(r => r.id === plannedMeal.id);
                        if (recipe) {
                            dayCell.innerHTML = createMealHTML(recipe, slot);
                            dayCell.classList.add('has-meal');
                        }
                    } else {
                        dayCell.innerHTML = `
                            <div class="calendar-cell-empty">
                                <i class="bi bi-plus-circle-dotted text-muted"></i>
                                <div class="empty-text">Rezept hier ablegen</div>
                            </div>
                        `;
                    }
                    
                    // Add drag & drop event listeners
                    dayCell.addEventListener('dragover', handleDragOver);
                    dayCell.addEventListener('dragenter', handleDragEnter);
                    dayCell.addEventListener('dragleave', handleDragLeave);
                    dayCell.addEventListener('drop', handleDrop);
                    
                    row.appendChild(dayCell);
                });
                
                tableBody.appendChild(row);
            });
        }

        function refreshMealPlanningDisplay() {
            // Update all meal slots in the new table structure
            const mealSlots = document.querySelectorAll('.meal-slot');
            
            mealSlots.forEach(slot => {
                const slotKey = slot.dataset.slot;
                const plannedMeal = AppData.mealPlan[slotKey];
                
                if (plannedMeal) {
                    const recipe = AppData.recipes.find(r => r.id === plannedMeal.id);
                    if (recipe) {
                        slot.innerHTML = createMealHTML(recipe, slotKey);
                        slot.classList.add('has-meal');
                    }
                } else {
                    slot.innerHTML = `
                        <div class="calendar-cell-empty">
                            <i class="bi bi-plus-circle-dotted text-muted"></i>
                            <div class="empty-text">Rezept hier ablegen</div>
                        </div>
                    `;
                    slot.classList.remove('has-meal');
                }
            });
        }

        async function loadRecipeLibrary() {
            const recipeList = document.getElementById('recipeList');
            recipeList.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Lade Rezepte...</span></div></div>';
            
            try {
                // Fetch recipes from API with higher limit
                const response = await fetch(`${API_BASE_URL}/recipes?limit=60`, {
                    headers: {
                        'X-Tenant-ID': TENANT_ID
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load recipes');
                }
                
                const data = await response.json();
                const recipes = data.items || [];
                
                // Update AppData.recipes with real data
                AppData.recipes = recipes;
                console.log(`üìö Loaded ${recipes.length} recipes into AppData`);
                
                recipeList.innerHTML = '';
                
                recipes.forEach(recipe => {
                    const recipeItem = document.createElement('div');
                    recipeItem.className = 'recipe-item';
                    recipeItem.draggable = true;
                    recipeItem.dataset.recipeId = recipe.id;
                    recipeItem.dataset.category = recipe.category || 'lunch'; // Set category for filtering
                    
                    // Parse tags if they're a string
                    const recipeTags = typeof recipe.tags === 'string' ? recipe.tags.split(',').map(t => t.trim()) : (recipe.tags || []);
                    const tags = recipeTags.map(tag => `<span class="recipe-tag">${tag}</span>`).join('');
                    
                    // Category icon
                    let categoryIcon = 'üçΩÔ∏è';
                    if (recipe.category === 'breakfast') categoryIcon = 'üåÖ';
                    else if (recipe.category === 'lunch') categoryIcon = '‚òÄÔ∏è';
                    else if (recipe.category === 'dinner') categoryIcon = 'üåô';
                    
                    recipeItem.innerHTML = `
                        <div class="batch-checkbox" style="display: none;">
                            <input type="checkbox" class="form-check-input" data-recipe-id="${recipe.id}" onchange="updateBatchSelection()">
                        </div>
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="recipe-name">${recipe.name}</div>
                            <span class="category-icon">${categoryIcon}</span>
                        </div>
                        <div class="recipe-meta">
                            ${recipe.portions} Portionen ‚Ä¢ ‚Ç¨${recipe.cost_per_portion}/Portion
                        </div>
                        <div class="recipe-tags">${tags}</div>
                        <div class="recipe-drag-hint">
                            <i class="bi bi-grip-vertical me-1"></i>Klicken und ziehen
                        </div>
                    `;
                    
                    // Add drag event listeners
                    recipeItem.addEventListener('dragstart', handleDragStart);
                    recipeItem.addEventListener('dragend', handleDragEnd);
                    
                    recipeList.appendChild(recipeItem);
                });
                
                // Update recipe count
                updateRecipeCount(recipes.length);
                
                console.log(`‚úÖ Loaded ${recipes.length} recipes for drag & drop`);
            } catch (error) {
                console.error('Failed to load recipes:', error);
                recipeList.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Rezepte</div>';
            }
        }

        function addMealToDay(dayKey) {
            // Create a modal to select meal time and recipe
            const modalHTML = `
                <div class="modal fade" id="addMealModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Mahlzeit hinzuf√ºgen</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Uhrzeit (optional)</label>
                                    <input type="time" class="form-control" id="mealTime">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mahlzeittyp</label>
                                    <input type="text" class="form-control" id="mealType" placeholder="z.B. Fr√ºhst√ºck, Snack, Hauptmahlzeit">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rezept ausw√§hlen</label>
                                    <select class="form-select" id="recipeSelect">
                                        ${AppData.recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                <button type="button" class="btn btn-primary" onclick="saveMealToDay('${dayKey}')">Hinzuf√ºgen</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body if not exists
            if (!document.getElementById('addMealModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addMealModal'));
            modal.show();
        }
        
        function saveMealToDay(dayKey) {
            const time = document.getElementById('mealTime').value || '';
            const type = document.getElementById('mealType').value || 'Mahlzeit';
            const recipeId = parseInt(document.getElementById('recipeSelect').value);
            const recipe = AppData.recipes.find(r => r.id === recipeId);
            
            if (recipe) {
                const mealKey = `${dayKey}-${Date.now()}`;
                AppData.mealPlan[mealKey] = {
                    id: recipe.id,
                    time: time,
                    type: type
                };
                
                refreshMealPlanningDisplay();
                updateCostSummary();
                updateNutritionBalance();
                showToast(`${recipe.name} hinzugef√ºgt`, 'success');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMealModal'));
                modal.hide();
            }
        }

        function createMealHTML(recipe, mealKey) {
            const categoryClass = recipe.category ? recipe.category.toLowerCase() : 'hauptgericht';
            const mealData = mealKey ? AppData.mealPlan[mealKey] : {};
            const timeDisplay = mealData.time ? `<span class="meal-time">${mealData.time}</span>` : '';
            const typeDisplay = mealData.type ? `<span class="meal-type badge bg-secondary">${mealData.type}</span>` : '';
            
            return `
                <div class="meal-event ${categoryClass}" draggable="true" data-recipe-id="${recipe.id}" data-meal-key="${mealKey || ''}">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            ${timeDisplay}
                            ${typeDisplay}
                        </div>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="removeMealFromCell('${mealKey}')">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <div class="meal-title fw-bold">${recipe.name}</div>
                    <div class="meal-details small text-muted">
                        ${recipe.portions} Portionen ‚Ä¢ ‚Ç¨${recipe.cost_per_portion}/Portion
                    </div>
                </div>
            `;
        }

        function removeMealFromCell(mealKey) {
            if (mealKey && AppData.mealPlan[mealKey]) {
                delete AppData.mealPlan[mealKey];
                refreshMealPlanningDisplay();
                updateCostSummary();
                updateNutritionBalance();
                showToast('Mahlzeit entfernt', 'info');
            }
        }

        // ===== DRAG & DROP HANDLERS =====
        
        function handleDragStart(e) {
            AppData.draggedElement = e.target;
            AppData.draggedElement.classList.add('dragging');
            
            const recipeId = parseInt(e.target.dataset.recipeId);
            AppData.draggedRecipe = AppData.recipes.find(r => r.id === recipeId);
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            
            console.log('üîÑ Drag started:', AppData.draggedRecipe?.name);
        }

        function handleDragEnd(e) {
            if (AppData.draggedElement) {
                AppData.draggedElement.classList.remove('dragging');
            }
            
            // Remove drag-over class from all cells
            document.querySelectorAll('.calendar-cell').forEach(cell => {
                cell.classList.remove('drag-over');
            });
            
            AppData.draggedElement = null;
            AppData.draggedRecipe = null;
            
            console.log('‚úÖ Drag ended');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const cell = e.target.closest('.calendar-cell');
            if (cell) {
                cell.classList.add('drag-over');
                
                // AI-VORSCHLAG: Zeige Empfehlung beim Hovern
                const draggedId = e.dataTransfer.types.includes('text/plain') ? 
                    draggedRecipeId : null;
                if (draggedId) {
                    showAISuggestion(cell, draggedId);
                }
            }
        }

        function handleDragLeave(e) {
            const cell = e.target.closest('.calendar-cell');
            if (cell && !cell.contains(e.relatedTarget)) {
                cell.classList.remove('drag-over');
                hideAISuggestion();
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            const cell = e.target.closest('.calendar-cell');
            if (!cell || !AppData.draggedRecipe) return;
            
            cell.classList.remove('drag-over');
            
            const dayKey = cell.dataset.day;
            
            // Check if dragged from another calendar cell (move operation)
            if (AppData.draggedElement && AppData.draggedElement.dataset.mealKey) {
                const sourceMealKey = AppData.draggedElement.dataset.mealKey;
                if (AppData.mealPlan[sourceMealKey]) {
                    // Remove from source
                    delete AppData.mealPlan[sourceMealKey];
                }
            }
            
            // Create new meal entry
            const mealKey = `${dayKey}-${Date.now()}`;
            AppData.mealPlan[mealKey] = {
                id: AppData.draggedRecipe.id,
                name: AppData.draggedRecipe.name,
                cost: AppData.draggedRecipe.cost_per_portion || 3.50,
                portions: AppData.draggedRecipe.portions || 50,
                time: '',
                type: 'Mahlzeit'
            };
            
            // Refresh calendar to show new meal
            refreshMealPlanningDisplay();
            
            // Add drag functionality to the new meal
            const mealEvent = cell.querySelector('.meal-event');
            if (mealEvent) {
                mealEvent.addEventListener('dragstart', handleDragStart);
                mealEvent.addEventListener('dragend', handleDragEnd);
            }
            
            // Add success animation
            cell.classList.add('drop-success');
            setTimeout(() => cell.classList.remove('drop-success'), 600);
            
            // Update costs and nutrition
            updateCostSummary();
            updateNutritionBalance();
            
            // Show success message
            const dayNames = {
                'monday': 'Montag', 'tuesday': 'Dienstag', 'wednesday': 'Mittwoch',
                'thursday': 'Donnerstag', 'friday': 'Freitag', 'saturday': 'Samstag', 'sunday': 'Sonntag'
            };
            const mealNames = {
                'breakfast': 'Fr√ºhst√ºck', 'lunch': 'Mittagessen', 'dinner': 'Abendessen'
            };
            
            showToast(`‚úÖ ${AppData.draggedRecipe.name} zu ${dayNames[day]} ${mealNames[meal]} hinzugef√ºgt`, 'success');
            
            console.log('üìç Dropped:', AppData.draggedRecipe.name, 'in', slot);
        }

        // ===== COST & NUTRITION CALCULATION =====
        
        function updateCostSummary() {
            let breakfastCost = 0;
            let lunchCost = 0;
            let dinnerCost = 0;
            
            Object.keys(AppData.mealPlan).forEach(slot => {
                const meal = AppData.mealPlan[slot];
                if (meal) {
                    const recipe = AppData.recipes.find(r => r.id === meal.id);
                    if (recipe) {
                        const cost = (recipe.cost_per_portion || 0) * (recipe.portions || 0);
                        
                        if (slot.includes('breakfast')) {
                            breakfastCost += cost;
                        } else if (slot.includes('lunch')) {
                            lunchCost += cost;
                        } else if (slot.includes('dinner')) {
                            dinnerCost += cost;
                        }
                    }
                }
            });
            
            const totalCost = breakfastCost + lunchCost + dinnerCost;
            
            document.getElementById('breakfastCost').textContent = `‚Ç¨${breakfastCost.toFixed(0)}`;
            document.getElementById('lunchCost').textContent = `‚Ç¨${lunchCost.toFixed(0)}`;
            document.getElementById('dinnerCost').textContent = `‚Ç¨${dinnerCost.toFixed(0)}`;
            document.getElementById('totalWeeklyCost').innerHTML = `<strong>‚Ç¨${totalCost.toFixed(0)}</strong>`;
            
            // Update savings badge
            const originalCost = totalCost * 1.15; // Simulate 15% more without AI
            const savings = originalCost - totalCost;
            const savingsBadge = document.getElementById('savingsBadge');
            
            if (savings > 0) {
                savingsBadge.textContent = `‚Ç¨${savings.toFixed(0)} gespart durch KI`;
                savingsBadge.className = 'badge bg-success';
            } else {
                savingsBadge.textContent = 'Keine Einsparungen';
                savingsBadge.className = 'badge bg-secondary';
            }
        }

        async function updateNutritionBalance() {
            const recipeIds = [];
            
            // Collect all recipe IDs from meal plan
            Object.keys(AppData.mealPlan).forEach(slot => {
                const meal = AppData.mealPlan[slot];
                if (meal && meal.id) {
                    recipeIds.push(meal.id);
                }
            });
            
            if (recipeIds.length === 0) {
                // Reset to defaults if no meals planned
                document.getElementById('proteinPercent').textContent = '25%';
                document.getElementById('carbsPercent').textContent = '45%';
                document.getElementById('fatPercent').textContent = '30%';
                
                document.getElementById('proteinBar').style.width = '25%';
                document.getElementById('carbsBar').style.width = '45%';
                document.getElementById('fatBar').style.width = '30%';
                
                document.getElementById('nutritionStatus').textContent = 'Keine Gerichte geplant';
                document.getElementById('nutritionStatus').className = 'badge bg-secondary';
                return;
            }
            
            try {
                // Call nutrition calculation API
                const response = await fetch(`${API_BASE_URL}/nutrition/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': TENANT_ID
                    },
                    body: JSON.stringify({ recipeIds })
                });
                
                if (!response.ok) {
                    throw new Error('Nutrition calculation failed');
                }
                
                const nutritionData = await response.json();
                
                // Update nutrition percentages
                document.getElementById('proteinPercent').textContent = `${nutritionData.proteinPercent}%`;
                document.getElementById('carbsPercent').textContent = `${nutritionData.carbsPercent}%`;
                document.getElementById('fatPercent').textContent = `${nutritionData.fatPercent}%`;
                
                // Update progress bars
                document.getElementById('proteinBar').style.width = `${nutritionData.proteinPercent}%`;
                document.getElementById('carbsBar').style.width = `${nutritionData.carbsPercent}%`;
                document.getElementById('fatBar').style.width = `${nutritionData.fatPercent}%`;
                
                // Update nutrition status with recommendations
                const nutritionStatus = document.getElementById('nutritionStatus');
                const proteinPercent = nutritionData.proteinPercent;
                const carbsPercent = nutritionData.carbsPercent;
                const fatPercent = nutritionData.fatPercent;
                
                if (proteinPercent >= 15 && proteinPercent <= 30 && 
                    carbsPercent >= 45 && carbsPercent <= 65 && 
                    fatPercent <= 35) {
                    nutritionStatus.textContent = 'Ausgewogen';
                    nutritionStatus.className = 'badge bg-success';
                } else if (proteinPercent < 15) {
                    nutritionStatus.textContent = 'Mehr Protein ben√∂tigt';
                    nutritionStatus.className = 'badge bg-warning';
                } else if (carbsPercent > 65) {
                    nutritionStatus.textContent = 'Zu viele Kohlenhydrate';
                    nutritionStatus.className = 'badge bg-warning';
                } else if (fatPercent > 35) {
                    nutritionStatus.textContent = 'Zu viel Fett';
                    nutritionStatus.className = 'badge bg-danger';
                } else {
                    nutritionStatus.textContent = 'Optimierung m√∂glich';
                    nutritionStatus.className = 'badge bg-info';
                }
                
                // Log nutrition recommendations
                if (nutritionData.recommendations && nutritionData.recommendations.length > 0) {
                    console.log('ü•ó Ern√§hrungsempfehlungen:', nutritionData.recommendations);
                }
                
            } catch (error) {
                console.error('Failed to calculate nutrition:', error);
                
                // Fallback to basic calculation
                let totalProtein = 0;
                let totalCarbs = 0;
                let totalFat = 0;
                let totalMeals = 0;
                
                Object.keys(AppData.mealPlan).forEach(slot => {
                    const meal = AppData.mealPlan[slot];
                    if (meal) {
                        const recipe = AppData.recipes.find(r => r.id === meal.id);
                        if (recipe) {
                            // Use default values if nutrition data not available
                            totalProtein += recipe.protein || 25;
                            totalCarbs += recipe.carbs || 35;
                            totalFat += recipe.fat || 15;
                            totalMeals++;
                        }
                    }
                });
                
                if (totalMeals > 0) {
                    const total = totalProtein + totalCarbs + totalFat;
                    const proteinPercent = Math.round((totalProtein / total) * 100);
                    const carbsPercent = Math.round((totalCarbs / total) * 100);
                    const fatPercent = Math.round((totalFat / total) * 100);
                    
                    document.getElementById('proteinPercent').textContent = `${proteinPercent}%`;
                    document.getElementById('carbsPercent').textContent = `${carbsPercent}%`;
                    document.getElementById('fatPercent').textContent = `${fatPercent}%`;
                    
                    document.getElementById('proteinBar').style.width = `${proteinPercent}%`;
                    document.getElementById('carbsBar').style.width = `${carbsPercent}%`;
                    document.getElementById('fatBar').style.width = `${fatPercent}%`;
                    
                    document.getElementById('nutritionStatus').textContent = 'Sch√§tzwerte verwendet';
                    document.getElementById('nutritionStatus').className = 'badge bg-secondary';
                }
            }
        }

        // ===== AI FUNCTIONS =====
        
        function showAISuggestion(cell, recipeId) {
            const slot = cell.dataset.slot;
            const [day, mealType] = slot.split('-');
            const recipe = AppData.recipes.find(r => r.id === parseInt(recipeId));
            
            if (!recipe) return;
            
            // Erstelle AI-Vorschlag-Element
            let suggestionEl = document.getElementById('ai-suggestion');
            if (!suggestionEl) {
                suggestionEl = document.createElement('div');
                suggestionEl.id = 'ai-suggestion';
                suggestionEl.className = 'ai-suggestion-tooltip';
                document.body.appendChild(suggestionEl);
            }
            
            // Analysiere basierend auf aktuellem Modus
            const mode = getCurrentAIMode();
            let suggestion = '';
            let recommendationClass = 'neutral';
            
            switch (mode) {
                case 'cost_optimized':
                    if (recipe.cost_per_portion < 2.50) {
                        suggestion = 'üí∞ Sehr g√ºnstig! Perfekt f√ºr Kostenoptimierung';
                        recommendationClass = 'good';
                    } else if (recipe.cost_per_portion > 4.00) {
                        suggestion = '‚ö†Ô∏è Teures Gericht - Alternative empfohlen';
                        recommendationClass = 'warning';
                    } else {
                        suggestion = 'üíµ Mittlere Preisklasse';
                    }
                    break;
                    
                case 'balanced_nutrition':
                    // Pr√ºfe auf ausgewogene N√§hrwerte
                    if (recipe.tags && recipe.tags.includes('Gesund')) {
                        suggestion = 'ü•ó N√§hrstoffreich! Gute Wahl';
                        recommendationClass = 'good';
                    } else if (recipe.tags && recipe.tags.includes('Protein')) {
                        suggestion = 'üí™ Hoher Proteingehalt';
                        recommendationClass = 'good';
                    } else {
                        suggestion = 'üçΩÔ∏è Standard-N√§hrwerte';
                    }
                    break;
                    
                case 'variety':
                    // Pr√ºfe ob Gericht schon diese Woche geplant ist
                    const alreadyPlanned = Object.values(AppData.mealPlan)
                        .filter(m => m.id === recipe.id).length;
                    if (alreadyPlanned > 0) {
                        suggestion = `‚ö†Ô∏è Bereits ${alreadyPlanned}x diese Woche geplant`;
                        recommendationClass = 'warning';
                    } else {
                        suggestion = '‚úÖ Neue Abwechslung!';
                        recommendationClass = 'good';
                    }
                    break;
                    
                case 'seasonal':
                    const month = new Date().getMonth();
                    const isWinter = month >= 11 || month <= 2;
                    const isSummer = month >= 5 && month <= 8;
                    
                    if ((isWinter && recipe.tags && recipe.tags.includes('Eintopf')) ||
                        (isSummer && recipe.tags && recipe.tags.includes('Salat'))) {
                        suggestion = 'üåø Perfekt zur Jahreszeit!';
                        recommendationClass = 'good';
                    } else {
                        suggestion = 'üìÖ Ganzjahres-Gericht';
                    }
                    break;
                    
                case 'inventory_based':
                    suggestion = 'üì¶ Lagerbestand wird gepr√ºft...';
                    break;
            }
            
            // Positioniere Tooltip
            const rect = cell.getBoundingClientRect();
            suggestionEl.style.top = (rect.top - 40) + 'px';
            suggestionEl.style.left = rect.left + 'px';
            suggestionEl.style.width = rect.width + 'px';
            suggestionEl.className = `ai-suggestion-tooltip ${recommendationClass}`;
            suggestionEl.innerHTML = `<i class="bi bi-robot"></i> ${suggestion}`;
            suggestionEl.style.display = 'block';
        }
        
        function hideAISuggestion() {
            const suggestionEl = document.getElementById('ai-suggestion');
            if (suggestionEl) {
                suggestionEl.style.display = 'none';
            }
        }
        
        function getCurrentAIMode() {
            const activeButton = document.querySelector('.ai-button.active');
            if (activeButton) {
                const mode = activeButton.getAttribute('data-param');
                console.log(`üîç Active button mode: ${mode}`);
                // Map UI modes to API modes
                const modeMap = {
                    'cost': 'cost_optimized',
                    'nutrition': 'balanced_nutrition',
                    'variety': 'variety',
                    'seasonal': 'seasonal',
                    'inventory': 'inventory_based'
                };
                const apiMode = modeMap[mode] || 'cost_optimized';
                console.log(`üîÑ Mapped to API mode: ${apiMode}`);
                return apiMode;
            }
            console.log('‚ö†Ô∏è No active button found, using cost_optimized');
            return 'cost_optimized';
        }
        
        function toggleAIMode(mode) {
            console.log(`ü§ñ toggleAIMode called with mode: ${mode}`);
            AppData.aiMode = mode;
            
            // Update button states
            document.querySelectorAll('.ai-button').forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the correct button
            const targetButton = document.querySelector(`[data-param="${mode}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Update status
            const statusTexts = {
                'cost': 'Kosten-Optimierung aktiv',
                'nutrition': 'N√§hrwert-Balance aktiv',
                'variety': 'Abwechslung aktiv',
                'seasonal': 'Saisonal aktiv',
                'inventory': 'Lagerbestand-Optimierung aktiv'
            };
            
            document.getElementById('aiStatus').innerHTML = `
                <small><i class="bi bi-check-circle me-1"></i>KI-Modus: ${statusTexts[mode]}</small>
            `;
            
            showToast(`ü§ñ KI-Modus ge√§ndert: ${statusTexts[mode]}`, 'info');
            
            // LIVE-ANPASSUNG: Plan sofort neu generieren wenn Modus gewechselt wird
            if (Object.keys(AppData.mealPlan).length > 0) {
                setTimeout(() => {
                    showToast(`üîÑ Erstelle neuen ${statusTexts[mode]} Plan...`, 'info');
                    // Leeren den aktuellen Plan f√ºr komplett neue Generierung
                    AppData.mealPlan = {};
                    generateAIWeekMenu(); // Neuen Plan mit leerem currentPlan
                }, 500);
            }
        }

        function updateAIMode(mode) {
            AppData.aiMode = mode;
            const modeNames = {
                'cost_optimized': 'Kostenoptimiert',
                'balanced_nutrition': 'Ausgewogene Ern√§hrung',
                'variety': 'Maximale Abwechslung',
                'seasonal': 'Saisonal',
                'inventory_based': 'Lagerbasiert'
            };
            showToast(`ü§ñ KI-Modus ge√§ndert: ${modeNames[mode]}`, 'info');
        }
        
        function optimizeCurrentPlan() {
            // Optimiere den aktuellen Plan basierend auf dem gew√§hlten Modus
            const currentMode = AppData.aiMode || 'cost';
            
            if (Object.keys(AppData.mealPlan).length === 0) {
                showToast('‚ùå Kein Plan zum Optimieren vorhanden!', 'error');
                return;
            }
            
            showToast('üîß Optimiere Plan nach ' + currentMode + ' Kriterien...', 'info');
            optimizeExistingPlan(currentMode);
        }
        
        async function optimizeExistingPlan(mode) {
            // Optimiere den bestehenden Plan basierend auf dem neuen Modus
            try {
                const response = await fetch(`${API_BASE_URL}/ai/optimize-plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': TENANT_ID
                    },
                    body: JSON.stringify({
                        mode: mode === 'cost' ? 'cost_optimized' : 
                              mode === 'nutrition' ? 'balanced_nutrition' :
                              mode === 'variety' ? 'variety' :
                              mode === 'seasonal' ? 'seasonal' : 'inventory_based',
                        currentPlan: AppData.mealPlan,
                        weekNumber: AppData.currentWeek || 1
                    })
                });
                
                if (!response.ok) throw new Error('Optimization failed');
                
                const result = await response.json();
                
                // Zeige √Ñnderungen an
                let changesCount = 0;
                if (result.changes) {
                    Object.keys(result.changes).forEach(slot => {
                        const oldMeal = AppData.mealPlan[slot];
                        const newMeal = result.changes[slot];
                        
                        if (oldMeal && newMeal && oldMeal.id !== newMeal.id) {
                            changesCount++;
                            // Visuelles Feedback f√ºr √Ñnderungen
                            const cell = document.querySelector(`.calendar-cell[data-slot="${slot}"]`);
                            if (cell) {
                                cell.classList.add('optimizing');
                                setTimeout(() => {
                                    AppData.mealPlan[slot] = newMeal;
                                    updateCalendarCell(cell, slot);
                                    cell.classList.remove('optimizing');
                                    cell.classList.add('optimized');
                                    setTimeout(() => cell.classList.remove('optimized'), 2000);
                                }, 500);
                            }
                        }
                    });
                }
                
                if (changesCount > 0) {
                    showToast(`‚úÖ ${changesCount} Gerichte optimiert!`, 'success');
                    updateCostSummary();
                    updateNutritionBalance();
                } else {
                    showToast('‚úì Plan ist bereits optimal f√ºr diesen Modus', 'info');
                }
                
            } catch (error) {
                console.error('Optimization error:', error);
                // Fallback: Generiere neuen Plan
                generateAIWeekMenu();
            }
        }
        
        async function generateAIWeekMenu() {
            const modeNames = {
                'cost_optimized': 'Kostenoptimierung',
                'balanced_nutrition': 'Ausgewogene Ern√§hrung',
                'variety': 'Maximale Abwechslung',
                'seasonal': 'Saisonale Auswahl',
                'inventory_based': 'Lagerbasierte Optimierung'
            };
            
            // Ensure recipes are loaded before AI generation
            if (!AppData.recipes || AppData.recipes.length === 0) {
                console.log('üîÑ Loading recipes before AI generation...');
                await loadRecipeLibrary();
                
                // Double-check after loading
                if (!AppData.recipes || AppData.recipes.length === 0) {
                    showToast('‚ùå Keine Rezepte verf√ºgbar f√ºr KI-Generierung', 'error');
                    return;
                }
            }
            
            // Check if custom mode is active
            const activeButton = document.querySelector('.ai-button.active');
            const isCustomMode = activeButton && activeButton.classList.contains('custom-mode');
            const currentMode = getCurrentAIMode();
            
            // Get custom config if custom mode is active
            let customConfig = null;
            if (isCustomMode || currentMode === 'custom') {
                // Try to get custom config from active button
                if (activeButton && activeButton.customConfig) {
                    customConfig = activeButton.customConfig;
                } else if (AppData.activeCustomConfig) {
                    customConfig = AppData.activeCustomConfig;
                }
            }
            
            const modeName = customConfig ? customConfig.name : modeNames[currentMode] || 'Standard';
            showToast(`ü§ñ KI generiert Wochenmen√º mit ${modeName}...`, 'info');
            
            try {
                // Build request body
                const requestBody = {
                    mode: customConfig ? 'custom' : currentMode,
                    weekNumber: AppData.currentWeek || 1,
                    currentPlan: AppData.mealPlan
                };
                
                // Add custom config if available
                if (customConfig) {
                    requestBody.customConfig = customConfig;
                }
                
                // Call AI API
                const response = await fetch(`${API_BASE_URL}/ai/suggest-meals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': TENANT_ID
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) throw new Error('AI suggestion failed');
                
                const aiPlan = await response.json();
                
                // Clear current meal plan
                AppData.mealPlan = {};
                
                // Check if we have a mealPlan in the response
                if (aiPlan.mealPlan) {
                    console.log('üìä Processing AI meal plan with', Object.keys(aiPlan.mealPlan).length, 'entries');
                    
                    Object.keys(aiPlan.mealPlan).forEach(key => {
                        const recipe = aiPlan.mealPlan[key];
                        if (recipe) {
                            // Key is already in format "monday-breakfast", "tuesday-lunch", etc.
                            // Use it directly for new table structure
                            AppData.mealPlan[key] = {
                                id: recipe.id,
                                name: recipe.name,
                                cost: recipe.cost_per_portion || recipe.cost || 3.50,
                                portions: recipe.portions || 50
                            };
                        }
                    });
                    
                    console.log('‚úÖ Saved', Object.keys(AppData.mealPlan).length, 'meals to AppData.mealPlan');
                } else {
                    console.log('‚ùå No mealPlan in AI response');
                }
                
                // Update the UI
                
                // Refresh calendar
                refreshMealPlanningDisplay();
                updateCostSummary();
                updateNutritionBalance();
                
                const totalMeals = Object.keys(AppData.mealPlan).length;
                const avgCost = parseFloat(aiPlan.averageCostPerMeal || 0);
                const estimatedSavings = Math.round((3.50 - avgCost) * totalMeals * 400); // Average portions
                
                showToast(`üéØ KI-Wochenmen√º generiert! ${totalMeals} Gerichte geplant. Gesch√§tzte Einsparung: ‚Ç¨${estimatedSavings}`, 'success');
                
                // Update metrics
                document.getElementById('plannedMenusCount').textContent = totalMeals;
                document.getElementById('aiSavingsAmount').textContent = `‚Ç¨${estimatedSavings}`;
                
            } catch (error) {
                console.error('Error generating AI meal plan:', error);
                showToast('‚ùå Fehler beim Generieren des KI-Men√ºs', 'error');
            }
        }

        function generateAISuggestions() {
            const suggestions = [];
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const meals = ['breakfast', 'lunch', 'dinner'];
            
            days.forEach(day => {
                meals.forEach(meal => {
                    const availableRecipes = AppData.recipes.filter(r => r.category === meal);
                    if (availableRecipes.length > 0) {
                        let selectedRecipe;
                        
                        // AI selection based on mode
                        switch (AppData.aiMode) {
                            case 'cost':
                                selectedRecipe = availableRecipes.sort((a, b) => a.cost - b.cost)[0];
                                break;
                            case 'nutrition':
                                selectedRecipe = availableRecipes.sort((a, b) => b.protein - a.protein)[0];
                                break;
                            case 'variety':
                                selectedRecipe = availableRecipes[Math.floor(Math.random() * availableRecipes.length)];
                                break;
                            case 'seasonal':
                                selectedRecipe = availableRecipes.find(r => r.name.includes('K√ºrbis')) || availableRecipes[0];
                                break;
                            default:
                                selectedRecipe = availableRecipes[0];
                        }
                        
                        if (Math.random() > 0.3) { // 70% chance to add a meal
                            suggestions.push({
                                slot: `${day}-${meal}`,
                                recipe: selectedRecipe
                            });
                        }
                    }
                });
            });
            
            return suggestions;
        }

        function optimizeCurrentPlan() {
            showToast('ü§ñ KI analysiert aktuellen Speiseplan und sucht Optimierungsm√∂glichkeiten...', 'info');
            
            setTimeout(() => {
                const improvements = [];
                
                // Find optimization opportunities
                Object.keys(AppData.mealPlan).forEach(slot => {
                    const meal = AppData.mealPlan[slot];
                    if (meal) {
                        const recipe = AppData.recipes.find(r => r.id === meal.id);
                        if (recipe) {
                            // Find cheaper alternatives
                            const alternatives = AppData.recipes.filter(r => 
                                r.category === recipe.category && 
                                r.cost < recipe.cost && 
                                r.id !== recipe.id
                            );
                            
                            if (alternatives.length > 0) {
                                const bestAlternative = alternatives.sort((a, b) => a.cost - b.cost)[0];
                                const savings = (recipe.cost - bestAlternative.cost) * recipe.portions;
                                
                                improvements.push({
                                    slot: slot,
                                    current: recipe,
                                    alternative: bestAlternative,
                                    savings: savings
                                });
                            }
                        }
                    }
                });
                
                if (improvements.length > 0) {
                    const totalSavings = improvements.reduce((sum, imp) => sum + imp.savings, 0);
                    
                    // Apply first improvement as example
                    const firstImprovement = improvements[0];
                    AppData.mealPlan[firstImprovement.slot] = { 
                        id: firstImprovement.alternative.id, 
                        name: firstImprovement.alternative.name 
                    };
                    
                    // Refresh calendar
                    refreshMealPlanningDisplay();
                    updateCostSummary();
                    updateNutritionBalance();
                    
                    showToast(`‚ú® Optimierung abgeschlossen! ${improvements.length} Verbesserungen gefunden. Einsparung: ‚Ç¨${totalSavings.toFixed(0)}`, 'success');
                } else {
                    showToast('‚úÖ Ihr Speiseplan ist bereits optimal!', 'info');
                }
                
            }, 2500);
        }

        // ===== CALENDAR NAVIGATION =====
        
        function previousWeek() {
            AppData.currentWeek = Math.max(1, AppData.currentWeek - 1);
            document.getElementById('currentWeek').textContent = `KW ${AppData.currentWeek}, 2024`;
            showToast(`Wechsel zu KW ${AppData.currentWeek}`, 'info');
        }

        function nextWeek() {
            AppData.currentWeek = Math.min(52, AppData.currentWeek + 1);
            document.getElementById('currentWeek').textContent = `KW ${AppData.currentWeek}, 2024`;
            showToast(`Wechsel zu KW ${AppData.currentWeek}`, 'info');
        }

        // ===== PRODUCTS =====
        
        async function loadProducts() {
            console.log('Loading products...');
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Lade Produkte...</td></tr>';
            
            try {
                console.log('Calling API...');
                const response = await api.getProducts({ limit: 50 });
                console.log('API Response:', response);
                const products = response.items || [];
                
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Keine Produkte gefunden</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    
                    const stockLevel = getStockLevel(product.stock, product.min_stock);
                    const stockPercent = Math.min(100, (product.stock / product.min_stock) * 50);
                    
                    row.innerHTML = `
                        <td><strong>${product.article_number}</strong></td>
                        <td>${product.name}</td>
                        <td><span class="badge bg-secondary">${product.category ? product.category.name : 'Ohne Kategorie'}</span></td>
                        <td><strong>‚Ç¨${product.price.toFixed(2)}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="stock-indicator me-2">
                                    <div class="stock-fill ${stockLevel}" style="width: ${stockPercent}%"></div>
                                </div>
                                <span>${product.stock} ${product.unit}</span>
                            </div>
                        </td>
                        <td><small class="text-muted">${product.supplier ? product.supplier.name : 'Kein Lieferant'}</small></td>
                        <td><span class="badge bg-${product.status === 'active' ? 'success' : 'danger'}">${product.status === 'active' ? 'Aktiv' : 'Inaktiv'}</span></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary" data-action="viewProductDetails" data-param="${product.id}" title="Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" data-action="editProductDetails" data-param="${product.id}" title="Bearbeiten">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-action="deleteProduct" data-param="${product.id}" title="L√∂schen">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading products:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Fehler beim Laden der Produkte</td></tr>';
                showToast('Fehler beim Laden der Produkte', 'error');
            }
        }

        function getStockLevel(stock, minStock) {
            if (stock < minStock) return 'low';
            if (stock < minStock * 2) return 'medium';
            return 'high';
        }

        // ===== RECIPES =====
        
        async function loadRecipes() {
            const recipeGrid = document.getElementById('recipeGrid');
            if (!recipeGrid) return;
            
            recipeGrid.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Lade Rezepte...</span></div></div>';
            
            try {
                // Load recipes
                const response = await api.getRecipes({ limit: 100 });
                const recipes = response.items || [];
                
                // Load recipe statistics
                try {
                    const statsResponse = await fetch(`${API_BASE_URL}/recipes/stats`, {
                        headers: {
                            'X-Tenant-ID': TENANT_ID
                        }
                    });
                    
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        
                        // Update dashboard numbers
                        document.getElementById('totalRecipes').textContent = stats.totalRecipes || 0;
                        document.getElementById('favoriteRecipes').textContent = stats.favoriteRecipes || 0;
                        document.getElementById('averagePortions').textContent = stats.averagePortions || 0;
                        document.getElementById('averageCost').textContent = `‚Ç¨${stats.averageCost || '0.00'}`;
                    }
                } catch (statsError) {
                    console.error('Error loading recipe stats:', statsError);
                }
                
                recipeGrid.innerHTML = '';
                
                if (recipes.length === 0) {
                    recipeGrid.innerHTML = '<div class="col-12 text-center text-muted">Keine Rezepte gefunden</div>';
                    return;
                }
                
                recipes.forEach(recipe => {
                    const recipeCard = document.createElement('div');
                    recipeCard.className = 'col-md-4 mb-4';
                    
                    // Parse tags if they're a string
                    let tagsHtml = '';
                    if (recipe.tags) {
                        const tags = typeof recipe.tags === 'string' ? recipe.tags.split(',') : recipe.tags;
                        tagsHtml = tags.map(tag => `<span class="badge bg-secondary me-1">${tag.trim()}</span>`).join('');
                    }
                    
                    // Calculate total time
                    const totalTime = (recipe.prep_time || 0) + (recipe.cook_time || 0);
                    
                    // Use the recipe's cost_per_portion or calculate if not available
                    let costPerPortion = recipe.cost_per_portion ? `‚Ç¨${recipe.cost_per_portion.toFixed(2)}` : 'N/A';
                    
                    recipeCard.innerHTML = `
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${recipe.name}</h5>
                                <p class="card-text">
                                    <strong>Portionen:</strong> ${recipe.portions}<br>
                                    <strong>Zubereitungszeit:</strong> ${totalTime} Min<br>
                                    <strong>Kosten:</strong> ${costPerPortion} pro Portion<br>
                                    <strong>Zutaten:</strong> ${recipe.ingredients ? recipe.ingredients.length : 0}
                                </p>
                                <div class="mb-3">${tagsHtml}</div>
                                ${recipe.notes ? `<p class="text-muted small">${recipe.notes}</p>` : ''}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" data-action="editRecipe" data-param="${recipe.id}">
                                        <i class="bi bi-pencil"></i> Bearbeiten
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" data-action="copyRecipe" data-param="${recipe.id}">
                                        <i class="bi bi-files"></i> Kopieren
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    recipeGrid.appendChild(recipeCard);
                });
                
            } catch (error) {
                console.error('Error loading recipes:', error);
                recipeGrid.innerHTML = '<div class="col-12 text-center text-danger">Fehler beim Laden der Rezepte</div>';
                showToast('Fehler beim Laden der Rezepte', 'error');
            }
        }

        // ===== UTILITY FUNCTIONS =====
        
        function showToast(message, type = 'info') {
            const toastBody = document.getElementById('toastBody');
            const toast = document.getElementById('liveToast');
            
            toastBody.textContent = message;
            toast.className = 'toast show';
            
            // Add type-specific styling
            if (type === 'success') {
                toast.classList.add('bg-success', 'text-white');
            } else if (type === 'warning') {
                toast.classList.add('bg-warning', 'text-dark');
            } else if (type === 'danger') {
                toast.classList.add('bg-danger', 'text-white');
            } else {
                toast.classList.add('bg-info', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                bsToast.hide();
            }, 4000);
        }

        function showModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
            
            // Special handling for AI Designer Modal
            if (modalId === 'aiDesignerModal') {
                // Wait for modal to be fully shown, then force tab visibility
                const modalElement = document.getElementById(modalId);
                modalElement.addEventListener('shown.bs.modal', function () {
                    console.log('üîß Modal ge√∂ffnet, aktiviere Tabs...');
                    
                    // Force show the first tab content
                    const firstTabContent = document.querySelector('#simple');
                    const allTabPanes = document.querySelectorAll('#aiDesignerModal .tab-pane');
                    
                    // Hide all tab panes first
                    allTabPanes.forEach(pane => {
                        pane.classList.remove('show', 'active');
                        pane.style.display = 'none';
                    });
                    
                    // Show the first tab
                    if (firstTabContent) {
                        firstTabContent.classList.add('show', 'active');
                        firstTabContent.style.display = 'block';
                        console.log('‚úÖ Erstes Tab forciert sichtbar gemacht');
                    }
                    
                    // Initialize Bootstrap Tab functionality for all tabs
                    const tabs = document.querySelectorAll('#aiDesignerModal [data-bs-toggle="tab"]');
                    tabs.forEach(tab => {
                        tab.addEventListener('click', function() {
                            const target = document.querySelector(this.getAttribute('data-bs-target'));
                            
                            // Hide all tab panes
                            allTabPanes.forEach(pane => {
                                pane.classList.remove('show', 'active');
                                pane.style.display = 'none';
                            });
                            
                            // Show target tab
                            if (target) {
                                target.classList.add('show', 'active');
                                target.style.display = 'block';
                            }
                        });
                    });
                    
                    console.log('‚úÖ Tab Click-Handler initialisiert');
                }, { once: true });
            }
        }

        function filterRecipes(searchTerm) {
            const recipeItems = document.querySelectorAll('#recipeList .recipe-item');
            
            recipeItems.forEach(item => {
                const recipeName = item.querySelector('.recipe-name').textContent.toLowerCase();
                const isVisible = recipeName.includes(searchTerm.toLowerCase());
                
                item.style.display = isVisible ? 'block' : 'none';
                
                if (isVisible) {
                    item.classList.add('slide-in');
                }
            });
        }

        // Recipe category filtering
        let currentRecipeCategory = 'all';
        
        function filterRecipesByCategory(category) {
            console.log('Filtering recipes by category:', category);
            currentRecipeCategory = category;
            
            // Update active tab
            document.querySelectorAll('#recipe-category-tabs .nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // Filter recipes
            const recipeItems = document.querySelectorAll('#recipeList .recipe-item');
            let visibleCount = 0;
            
            recipeItems.forEach(item => {
                const recipeCategory = item.dataset.category || 'lunch'; // fallback to lunch
                const shouldShow = category === 'all' || recipeCategory === category;
                
                item.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Update recipe count
            updateRecipeCount(visibleCount);
            
            // Clear search when changing category
            const searchInput = document.getElementById('recipeSearchInput');
            if (searchInput) searchInput.value = '';
        }
        
        function clearRecipeSearch() {
            const searchInput = document.getElementById('recipeSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterRecipes('');
            }
        }
        
        function updateRecipeCount(count) {
            const countElement = document.getElementById('recipeCount');
            if (countElement) {
                countElement.textContent = `${count} Rezepte`;
            }
        }

        // ===== ACTION FUNCTIONS =====
        
        function generateWeeklyMenu() {
            generateAIWeekMenu();
        }

        // ===== SUPPLIER MANAGEMENT =====
        
        async function editSupplier(supplierId) {
            try {
                // Load supplier data from API
                const supplier = await api.getSupplier(supplierId);
                
                const supplierModal = document.createElement('div');
                supplierModal.className = 'modal fade';
                supplierModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Lieferant bearbeiten</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editSupplierForm">
                                    <div class="mb-3">
                                        <label class="form-label">Firmenname</label>
                                        <input type="text" class="form-control" id="supplierName" value="${supplier.name}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kontaktperson</label>
                                        <input type="text" class="form-control" id="supplierContact" value="${supplier.contact_person || ''}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="supplierEmail" value="${supplier.email || ''}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Telefon</label>
                                        <input type="tel" class="form-control" id="supplierPhone" value="${supplier.phone || ''}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Adresse</label>
                                        <textarea class="form-control" id="supplierAddress" rows="3">${supplier.address || ''}</textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                <button type="button" class="btn btn-primary" data-action="saveSupplier" data-param="${supplierId}">Speichern</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(supplierModal);
                const modal = new bootstrap.Modal(supplierModal);
                modal.show();
                
                // Clean up modal when closed
                supplierModal.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(supplierModal);
                });
                
            } catch (error) {
                console.error('Error loading supplier:', error);
                showToast('Fehler beim Laden der Lieferantendaten', 'error');
            }
        }

        async function saveSupplier(supplierId) {
            try {
                const name = document.getElementById('supplierName').value;
                const contact = document.getElementById('supplierContact').value;
                const email = document.getElementById('supplierEmail').value;
                const phone = document.getElementById('supplierPhone').value;
                const address = document.getElementById('supplierAddress').value;
                
                if (!name.trim()) {
                    showToast('Firmenname ist erforderlich', 'error');
                    return;
                }
                
                // Update supplier via API
                const updatedSupplier = await api.updateSupplier(supplierId, {
                    name: name.trim(),
                    contact_person: contact.trim(),
                    email: email.trim(),
                    phone: phone.trim(),
                    address: address.trim()
                });
                
                showToast(`‚úÖ Lieferant ${name} erfolgreich aktualisiert!`, 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                modal.hide();
                
                // Refresh supplier list if we're on the suppliers tab
                if (document.getElementById('suppliers') && document.getElementById('suppliers').classList.contains('active')) {
                    loadSuppliers();
                }
                
            } catch (error) {
                console.error('Error saving supplier:', error);
                showToast('Fehler beim Speichern der Lieferantendaten', 'error');
            }
        }

        function rateSupplier(supplierId) {
            const ratingModal = document.createElement('div');
            ratingModal.className = 'modal fade';
            ratingModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Lieferant bewerten</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Bewertung</label>
                                <div class="rating-stars">
                                    <i class="fas fa-star" data-rating="1"></i>
                                    <i class="fas fa-star" data-rating="2"></i>
                                    <i class="fas fa-star" data-rating="3"></i>
                                    <i class="fas fa-star" data-rating="4"></i>
                                    <i class="fas fa-star" data-rating="5"></i>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kommentar</label>
                                <textarea class="form-control" id="ratingComment" rows="3" placeholder="Optionaler Kommentar..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-primary" data-action="saveRating" data-param="${supplierId}">Bewertung abgeben</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(ratingModal);
            const modal = new bootstrap.Modal(ratingModal);
            modal.show();
            
            // Add star rating functionality
            const stars = ratingModal.querySelectorAll('.rating-stars i');
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    stars.forEach((s, i) => {
                        s.style.color = i <= index ? '#ffc107' : '#dee2e6';
                    });
                    ratingModal.setAttribute('data-rating', index + 1);
                });
            });
        }

        function saveRating(supplierId) {
            const rating = document.querySelector('.modal.show').getAttribute('data-rating') || '5';
            const comment = document.getElementById('ratingComment').value;
            
            showToast(`‚úÖ Bewertung (${rating} Sterne) f√ºr Lieferant ${supplierId} gespeichert!`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            modal.hide();
        }

        async function loadSuppliers() {
            const tbody = document.getElementById('suppliersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Lade Lieferanten...</td></tr>';
            
            try {
                const response = await api.getSuppliers({ limit: 50 });
                const suppliers = response.items || [];
                
                tbody.innerHTML = '';
                
                if (suppliers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Keine Lieferanten gefunden</td></tr>';
                    return;
                }
                
                suppliers.forEach(supplier => {
                    const row = document.createElement('tr');
                    
                    // Generate star rating display
                    const ratingStars = Math.floor(supplier.rating);
                    const starHtml = '‚òÖ'.repeat(ratingStars) + '‚òÜ'.repeat(5 - ratingStars);
                    
                    row.innerHTML = `
                        <td><strong>${supplier.name}</strong></td>
                        <td>${supplier.contact_person || '-'}</td>
                        <td>${supplier.email || '-'}</td>
                        <td>${supplier.phone || '-'}</td>
                        <td>
                            <span class="text-warning">${starHtml}</span>
                            <small class="text-muted">(${supplier.rating.toFixed(1)})</small>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-secondary" data-action="editSupplier" data-param="${supplier.id}" title="Bearbeiten">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" data-action="rateSupplier" data-param="${supplier.id}" title="Bewerten">
                                    <i class="bi bi-star"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-action="deleteSupplier" data-param="${supplier.id}" title="L√∂schen">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading suppliers:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Fehler beim Laden der Lieferanten</td></tr>';
                showToast('Fehler beim Laden der Lieferanten', 'error');
            }
        }
        
        // ===== ORDER MANAGEMENT =====
        
        async function viewOrder(orderId) {
            try {
                // Load order data from API
                const order = await api.getOrder(orderId);
                
                const orderModal = document.createElement('div');
                orderModal.className = 'modal fade';
                
                // Status badge color mapping
                const statusColors = {
                    'pending': 'warning',
                    'confirmed': 'info',
                    'delivered': 'success',
                    'cancelled': 'danger'
                };
                
                // Status text mapping
                const statusTexts = {
                    'pending': 'Ausstehend',
                    'confirmed': 'Best√§tigt',
                    'delivered': 'Geliefert',
                    'cancelled': 'Storniert'
                };
                
                // Build items table
                const itemsHtml = order.items.map(item => `
                    <tr>
                        <td>${item.product_name}</td>
                        <td>${item.quantity} ${item.unit}</td>
                        <td>‚Ç¨${item.unit_price.toFixed(2)}</td>
                        <td>‚Ç¨${item.total_price.toFixed(2)}</td>
                    </tr>
                `).join('');
                
                orderModal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Bestellung ${order.order_number}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Bestelldetails</h6>
                                        <p><strong>Bestelldatum:</strong> ${new Date(order.order_date).toLocaleDateString()}</p>
                                        <p><strong>Lieferant:</strong> ${order.supplier ? order.supplier.name : 'Unbekannt'}</p>
                                        <p><strong>Status:</strong> <span class="badge bg-${statusColors[order.status]}">${statusTexts[order.status]}</span></p>
                                        <p><strong>Gesamtbetrag:</strong> ‚Ç¨${order.total_amount.toFixed(2)}</p>
                                        ${order.delivery_date ? `<p><strong>Lieferdatum:</strong> ${new Date(order.delivery_date).toLocaleDateString()}</p>` : ''}
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Lieferadresse</h6>
                                        <p>${order.delivery_address || 'Hauptk√ºche<br>Musterstra√üe 123<br>12345 Musterstadt'}</p>
                                        ${order.notes ? `<p><strong>Notizen:</strong> ${order.notes}</p>` : ''}
                                    </div>
                                </div>
                                <hr>
                                <h6>Bestellte Artikel</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Artikel</th>
                                                <th>Menge</th>
                                                <th>Preis</th>
                                                <th>Gesamt</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${itemsHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                                ${order.status === 'pending' ? `<button type="button" class="btn btn-primary" data-action="confirmOrder" data-param="${orderId}">Best√§tigen</button>` : ''}
                                ${order.status === 'confirmed' ? `<button type="button" class="btn btn-success" data-action="deliverOrder" data-param="${orderId}">Als geliefert markieren</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(orderModal);
                const modal = new bootstrap.Modal(orderModal);
                modal.show();
                
                // Clean up modal when closed
                orderModal.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(orderModal);
                });
                
            } catch (error) {
                console.error('Error loading order:', error);
                showToast('Fehler beim Laden der Bestellungsdaten', 'error');
            }
        }

        async function confirmOrder(orderId) {
            if (confirm('M√∂chten Sie diese Bestellung wirklich best√§tigen?')) {
                try {
                    // Confirm order via API
                    await api.confirmOrder(orderId);
                    
                    showToast(`‚úÖ Bestellung wurde best√§tigt!`, 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Refresh orders list if we're on the orders tab
                    if (document.getElementById('orders') && document.getElementById('orders').classList.contains('active')) {
                        loadOrders();
                    }
                    
                } catch (error) {
                    console.error('Error confirming order:', error);
                    showToast('Fehler beim Best√§tigen der Bestellung', 'error');
                }
            }
        }
        
        async function deliverOrder(orderId) {
            if (confirm('M√∂chten Sie diese Bestellung als geliefert markieren?')) {
                try {
                    // Mark order as delivered via API
                    await api.deliverOrder(orderId);
                    
                    showToast(`‚úÖ Bestellung wurde als geliefert markiert!`, 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Refresh orders list if we're on the orders tab
                    if (document.getElementById('orders') && document.getElementById('orders').classList.contains('active')) {
                        loadOrders();
                    }
                    
                } catch (error) {
                    console.error('Error delivering order:', error);
                    showToast('Fehler beim Markieren als geliefert', 'error');
                }
            }
        }
        
        async function loadOrders() {
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Lade Bestellungen...</td></tr>';
            
            try {
                const response = await api.getOrders({ limit: 50 });
                const orders = response.items || [];
                
                tbody.innerHTML = '';
                
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Keine Bestellungen gefunden</td></tr>';
                    return;
                }
                
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    
                    // Status badge color mapping
                    const statusColors = {
                        'pending': 'warning',
                        'confirmed': 'info',
                        'delivered': 'success',
                        'cancelled': 'danger'
                    };
                    
                    // Status text mapping
                    const statusTexts = {
                        'pending': 'Ausstehend',
                        'confirmed': 'Best√§tigt',
                        'delivered': 'Geliefert',
                        'cancelled': 'Storniert'
                    };
                    
                    row.innerHTML = `
                        <td><strong>${order.order_number}</strong></td>
                        <td>${new Date(order.order_date).toLocaleDateString()}</td>
                        <td>${order.supplier ? order.supplier.name : 'Unbekannt'}</td>
                        <td><span class="badge bg-${statusColors[order.status]}">${statusTexts[order.status]}</span></td>
                        <td><strong>‚Ç¨${order.total_amount.toFixed(2)}</strong></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary" data-action="viewOrder" data-param="${order.id}" title="Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${order.status === 'pending' ? `<button class="btn btn-sm btn-outline-success" data-action="confirmOrder" data-param="${order.id}" title="Best√§tigen">
                                    <i class="bi bi-check"></i>
                                </button>` : ''}
                                ${order.status === 'confirmed' ? `<button class="btn btn-sm btn-outline-info" data-action="deliverOrder" data-param="${order.id}" title="Geliefert">
                                    <i class="bi bi-truck"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Fehler beim Laden der Bestellungen</td></tr>';
                showToast('Fehler beim Laden der Bestellungen', 'error');
            }
        }

        function viewInvoice(orderId) {
            const invoiceModal = document.createElement('div');
            invoiceModal.className = 'modal fade';
            invoiceModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Rechnung #R${orderId}${new Date().getFullYear()}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="invoice-header text-center mb-4">
                                <h4>FoodSuite Pro</h4>
                                <p>Rechnung f√ºr Bestellung #${orderId}</p>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Rechnungsadresse</h6>
                                    <p>Hauptk√ºche<br>
                                    Musterstra√üe 123<br>
                                    12345 Musterstadt</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Rechnungsdaten</h6>
                                    <p><strong>Rechnungsnummer:</strong> R${orderId}${new Date().getFullYear()}</p>
                                    <p><strong>Datum:</strong> ${new Date().toLocaleDateString()}</p>
                                    <p><strong>F√§lligkeitsdatum:</strong> ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</p>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Artikel</th>
                                            <th>Menge</th>
                                            <th>Einzelpreis</th>
                                            <th>Gesamt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Karotten Bio</td>
                                            <td>10 kg</td>
                                            <td>‚Ç¨2.50</td>
                                            <td>‚Ç¨25.00</td>
                                        </tr>
                                        <tr>
                                            <td>Rinderhackfleisch</td>
                                            <td>5 kg</td>
                                            <td>‚Ç¨12.00</td>
                                            <td>‚Ç¨60.00</td>
                                        </tr>
                                        <tr>
                                            <td>Nudeln</td>
                                            <td>20 Pakete</td>
                                            <td>‚Ç¨1.20</td>
                                            <td>‚Ç¨24.00</td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="3">Zwischensumme</th>
                                            <th>‚Ç¨109.00</th>
                                        </tr>
                                        <tr>
                                            <th colspan="3">MwSt. (19%)</th>
                                            <th>‚Ç¨20.71</th>
                                        </tr>
                                        <tr>
                                            <th colspan="3">Gesamtbetrag</th>
                                            <th>‚Ç¨129.71</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                            <button type="button" class="btn btn-primary" data-action="printInvoice" data-param="${orderId}">Drucken</button>
                            <button type="button" class="btn btn-success" data-action="downloadInvoice" data-param="${orderId}">PDF Download</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(invoiceModal);
            const modal = new bootstrap.Modal(invoiceModal);
            modal.show();
        }

        function printOrder(orderId) {
            showToast(`üñ®Ô∏è Bestellung #${orderId} wird gedruckt...`, 'info');
            setTimeout(() => showToast('‚úÖ Bestellung erfolgreich gedruckt!', 'success'), 1500);
        }

        function printInvoice(orderId) {
            showToast(`üñ®Ô∏è Rechnung #R${orderId}${new Date().getFullYear()} wird gedruckt...`, 'info');
            setTimeout(() => showToast('‚úÖ Rechnung erfolgreich gedruckt!', 'success'), 1500);
        }

        function downloadInvoice(orderId) {
            showToast(`üì• Rechnung #R${orderId}${new Date().getFullYear()} wird als PDF heruntergeladen...`, 'info');
            setTimeout(() => showToast('‚úÖ PDF erfolgreich heruntergeladen!', 'success'), 2000);
        }

        // ===== INVENTORY MANAGEMENT =====
        
        async function updateStock(productId) {
            try {
                // Load current product data from API
                const product = await api.getProduct(productId);
                
                const stockModal = document.createElement('div');
                stockModal.className = 'modal fade';
                stockModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Bestand aktualisieren</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Produkt</label>
                                    <input type="text" class="form-control" value="${product.name} (${product.article_number})" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Aktueller Bestand</label>
                                    <input type="number" class="form-control" id="currentStock" value="${product.stock}" readonly>
                                    <small class="text-muted">Einheit: ${product.unit}, Mindestbestand: ${product.min_stock}</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">√Ñnderungsmenge</label>
                                    <div class="input-group">
                                        <button class="btn btn-outline-danger" type="button" data-action="setNegativeStock">-</button>
                                        <input type="number" class="form-control" id="stockChange" placeholder="Menge eingeben (+ oder -)">
                                        <button class="btn btn-outline-success" type="button" data-action="setPositiveStock">+</button>
                                    </div>
                                    <small class="text-muted">Positive Werte = Zugang, Negative Werte = Abgang</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Grund f√ºr √Ñnderung</label>
                                    <select class="form-select" id="changeReason">
                                        <option value="delivery">Lieferung</option>
                                        <option value="consumption">Verbrauch</option>
                                        <option value="correction">Korrektur</option>
                                        <option value="waste">Verschwendung</option>
                                        <option value="transfer">Umlagerung</option>
                                        <option value="manual">Manuelle Anpassung</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notizen</label>
                                    <textarea class="form-control" id="stockNote" rows="2" placeholder="Optionale Notizen..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Neuer Bestand (Vorschau)</label>
                                    <input type="number" class="form-control" id="newStockPreview" readonly>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                <button type="button" class="btn btn-primary" data-action="saveStockUpdate" data-param="${productId}">Bestand aktualisieren</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(stockModal);
                const modal = new bootstrap.Modal(stockModal);
                modal.show();
                
                // Add real-time preview calculation
                const stockChangeInput = stockModal.querySelector('#stockChange');
                const newStockPreview = stockModal.querySelector('#newStockPreview');
                const currentStock = product.stock;
                
                stockChangeInput.addEventListener('input', () => {
                    const change = parseFloat(stockChangeInput.value) || 0;
                    newStockPreview.value = currentStock + change;
                    
                    // Color code the preview
                    if (newStockPreview.value < 0) {
                        newStockPreview.className = 'form-control text-danger';
                    } else if (newStockPreview.value < product.min_stock) {
                        newStockPreview.className = 'form-control text-warning';
                    } else {
                        newStockPreview.className = 'form-control text-success';
                    }
                });
                
                // Initialize preview
                newStockPreview.value = currentStock;
                
                // Clean up modal when closed
                stockModal.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(stockModal);
                });
                
            } catch (error) {
                console.error('Error loading product for stock update:', error);
                showToast('Fehler beim Laden der Produktdaten', 'error');
            }
        }

        async function saveStockUpdate(productId) {
            try {
                const currentStock = parseFloat(document.getElementById('currentStock').value);
                const stockChange = parseFloat(document.getElementById('stockChange').value) || 0;
                const reason = document.getElementById('changeReason').value;
                const note = document.getElementById('stockNote').value;
                
                if (stockChange === 0) {
                    showToast('‚ö†Ô∏è Bitte geben Sie eine √Ñnderungsmenge ein!', 'warning');
                    return;
                }
                
                // Update stock via API
                const updatedProduct = await api.updateProductStock(productId, {
                    quantity: stockChange,
                    reason: reason,
                    notes: note
                });
                
                const changeText = stockChange > 0 ? `+${stockChange}` : `${stockChange}`;
                showToast(`‚úÖ Bestand aktualisiert! √Ñnderung: ${changeText}`, 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                modal.hide();
                
                // Refresh inventory or products list if visible
                if (document.getElementById('inventory') && document.getElementById('inventory').classList.contains('active')) {
                    loadInventory();
                } else if (document.getElementById('products') && document.getElementById('products').classList.contains('active')) {
                    loadProducts();
                }
                
            } catch (error) {
                console.error('Error updating stock:', error);
                showToast('Fehler beim Aktualisieren des Bestands', 'error');
            }
        }
        
        async function loadInventory() {
            const tbody = document.getElementById('inventoryTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Lade Inventar...</td></tr>';
            
            try {
                const response = await api.getProducts({ limit: 100 });
                const products = response.items || [];
                
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Keine Produkte im Inventar gefunden</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    
                    // Calculate stock status
                    let stockStatus = 'success';
                    let stockText = 'Ausreichend';
                    
                    if (product.stock <= 0) {
                        stockStatus = 'danger';
                        stockText = 'Ausverkauft';
                    } else if (product.stock < product.min_stock) {
                        stockStatus = 'warning';
                        stockText = 'Niedrig';
                    } else if (product.stock < product.min_stock * 2) {
                        stockStatus = 'info';
                        stockText = 'Mittel';
                    }
                    
                    // Calculate stock percentage for progress bar
                    const stockPercent = Math.min(100, (product.stock / (product.max_stock || product.min_stock * 3)) * 100);
                    
                    row.innerHTML = `
                        <td><strong>${product.article_number}</strong></td>
                        <td>${product.name}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress me-2" style="width: 60px; height: 8px;">
                                    <div class="progress-bar bg-${stockStatus}" style="width: ${stockPercent}%"></div>
                                </div>
                                <span>${product.stock} ${product.unit}</span>
                            </div>
                        </td>
                        <td><span class="badge bg-${stockStatus}">${stockText}</span></td>
                        <td><small class="text-muted">${product.storage_location || 'Nicht angegeben'}</small></td>
                        <td>
                            <small class="text-muted">
                                Min: ${product.min_stock} ${product.unit}<br>
                                Max: ${product.max_stock || 'Nicht festgelegt'} ${product.unit}
                            </small>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary" data-action="updateStock" data-param="${product.id}" title="Bestand √§ndern">
                                    <i class="bi bi-arrow-up-circle"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" data-action="transferStock" data-param="${product.id}" title="Umlagern">
                                    <i class="bi bi-arrow-left-right"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" data-action="viewProductDetails" data-param="${product.id}" title="Details">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading inventory:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Fehler beim Laden des Inventars</td></tr>';
                showToast('Fehler beim Laden des Inventars', 'error');
            }
        }
        
        // ===== GOODS RECEIPT MANAGEMENT =====
        
        async function loadGoodsReceipts() {
            const tbody = document.getElementById('goodsReceiptsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Lade Wareneing√§nge...</td></tr>';
            
            try {
                const goodsReceipts = await api.get('/goods-receipts');
                
                tbody.innerHTML = '';
                
                if (goodsReceipts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Keine Wareneing√§nge gefunden</td></tr>';
                    return;
                }
                
                goodsReceipts.forEach(receipt => {
                    const row = document.createElement('tr');
                    
                    const statusBadge = getReceiptStatusBadge(receipt.status);
                    const receivedDate = new Date(receipt.received_date).toLocaleDateString('de-DE');
                    
                    row.innerHTML = `
                        <td><strong>${receipt.receipt_number}</strong></td>
                        <td>
                            ${receipt.order ? receipt.order.order_number : 'N/A'}
                            ${receipt.order ? `<br><small class="text-muted">‚Ç¨${receipt.order.total_amount.toFixed(2)}</small>` : ''}
                        </td>
                        <td>${receipt.supplier ? receipt.supplier.name : 'Unbekannt'}</td>
                        <td>${receivedDate}</td>
                        <td>
                            <span class="badge bg-secondary">${receipt.total_items} Artikel</span>
                        </td>
                        <td>‚Ç¨${receipt.total_received_value ? receipt.total_received_value.toFixed(2) : '0.00'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary" data-action="viewGoodsReceipt" data-param="${receipt.id}" title="Anzeigen">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" data-action="editGoodsReceipt" data-param="${receipt.id}" title="Bearbeiten">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-action="deleteGoodsReceipt" data-param="${receipt.id}" title="L√∂schen">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading goods receipts:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Fehler beim Laden der Wareneing√§nge</td></tr>';
                showToast('Fehler beim Laden der Wareneing√§nge', 'error');
            }
        }
        
        async function loadPendingDeliveries() {
            const tbody = document.getElementById('pendingDeliveriesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Lade erwartete Lieferungen...</td></tr>';
            
            try {
                const deliveries = await api.get('/pending-deliveries');
                
                tbody.innerHTML = '';
                
                if (deliveries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Keine erwarteten Lieferungen gefunden</td></tr>';
                    return;
                }
                
                deliveries.forEach(delivery => {
                    const row = document.createElement('tr');
                    
                    const deliveryDate = new Date(delivery.order.delivery_date).toLocaleDateString('de-DE');
                    const statusBadge = getOrderStatusBadge(delivery.order.status);
                    const daysBadge = getDaysUntilDeliveryBadge(delivery.days_until_delivery);
                    
                    row.innerHTML = `
                        <td>
                            <strong>${delivery.order.order_number}</strong>
                            <br><small class="text-muted">Bestellt: ${new Date(delivery.order.order_date).toLocaleDateString('de-DE')}</small>
                        </td>
                        <td>${delivery.supplier ? delivery.supplier.name : 'Unbekannt'}</td>
                        <td>${deliveryDate}</td>
                        <td>
                            <span class="badge bg-secondary">${delivery.item_count} Artikel</span>
                        </td>
                        <td>‚Ç¨${delivery.total_value.toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>${daysBadge}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-success" data-action="createGoodsReceiptFromOrder" data-param="${delivery.order.id}" title="Wareneingang erfassen">
                                    <i class="bi bi-truck"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" data-action="viewOrderDetails" data-param="${delivery.order.id}" title="Bestellung anzeigen">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading pending deliveries:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Fehler beim Laden der erwarteten Lieferungen</td></tr>';
                showToast('Fehler beim Laden der erwarteten Lieferungen', 'error');
            }
        }
        
        function getReceiptStatusBadge(status) {
            const statusMap = {
                'received': { text: 'Eingegangen', class: 'bg-success' },
                'partial': { text: 'Teilweise', class: 'bg-warning' },
                'pending': { text: 'Ausstehend', class: 'bg-secondary' },
                'quality_issue': { text: 'Qualit√§tsproblem', class: 'bg-danger' }
            };
            const badge = statusMap[status] || { text: status, class: 'bg-secondary' };
            return `<span class="badge ${badge.class}">${badge.text}</span>`;
        }
        
        function getOrderStatusBadge(status) {
            const statusMap = {
                'confirmed': { text: 'Best√§tigt', class: 'bg-info' },
                'shipped': { text: 'Versandt', class: 'bg-primary' },
                'delivered': { text: 'Geliefert', class: 'bg-success' },
                'cancelled': { text: 'Storniert', class: 'bg-danger' }
            };
            const badge = statusMap[status] || { text: status, class: 'bg-secondary' };
            return `<span class="badge ${badge.class}">${badge.text}</span>`;
        }
        
        function getDaysUntilDeliveryBadge(days) {
            if (days < 0) {
                return `<span class="badge bg-danger">${Math.abs(days)} Tage √ºberf√§llig</span>`;
            } else if (days === 0) {
                return `<span class="badge bg-warning">Heute</span>`;
            } else if (days === 1) {
                return `<span class="badge bg-info">Morgen</span>`;
            } else if (days <= 3) {
                return `<span class="badge bg-primary">${days} Tage</span>`;
            } else {
                return `<span class="badge bg-secondary">${days} Tage</span>`;
            }
        }
        
        function createGoodsReceiptFromOrder(orderId) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Wareneingang erfassen</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="goodsReceiptForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Eingangsnummer</label>
                                            <input type="text" class="form-control" name="receipt_number" value="WE-${Date.now()}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Eingangsdatum</label>
                                            <input type="date" class="form-control" name="received_date" value="${new Date().toISOString().split('T')[0]}" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Anmerkungen</label>
                                    <textarea class="form-control" name="notes" rows="3" placeholder="Zustand der Ware, Besonderheiten, etc."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Artikel</label>
                                    <div id="receiptItemsList" class="border rounded p-3">
                                        <p class="text-muted">Lade Bestellartikel...</p>
                                    </div>
                                </div>
                                
                                <input type="hidden" name="order_id" value="${orderId}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-success" onclick="submitGoodsReceipt()">Wareneingang speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Load order items
            loadOrderItemsForReceipt(orderId);
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        async function loadOrderItemsForReceipt(orderId) {
            const container = document.getElementById('receiptItemsList');
            try {
                const order = await api.get(`/orders/${orderId}`);
                const orderItems = order.items || [];
                
                if (orderItems.length === 0) {
                    container.innerHTML = '<p class="text-muted">Keine Artikel in dieser Bestellung gefunden</p>';
                    return;
                }
                
                container.innerHTML = orderItems.map((item, index) => `
                    <div class="row mb-2 align-items-center receipt-item" data-product-id="${item.product_id}">
                        <div class="col-md-4">
                            <strong>${item.product ? item.product.name : 'Produkt #' + item.product_id}</strong>
                            <br><small class="text-muted">${item.product ? item.product.article_number : ''}</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Bestellt:</label>
                            <input type="number" class="form-control form-control-sm" value="${item.quantity}" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Erhalten:</label>
                            <input type="number" class="form-control form-control-sm" name="received_quantity_${index}" value="${item.quantity}" min="0" step="0.1">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Zustand:</label>
                            <select class="form-select form-select-sm" name="condition_${index}">
                                <option value="good">Gut</option>
                                <option value="damaged">Besch√§digt</option>
                                <option value="expired">Abgelaufen</option>
                                <option value="rejected">Zur√ºckgewiesen</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Preis:</label>
                            <input type="number" class="form-control form-control-sm" name="unit_price_${index}" value="${item.unit_price}" step="0.01">
                        </div>
                        <input type="hidden" name="product_id_${index}" value="${item.product_id}">
                        <input type="hidden" name="ordered_quantity_${index}" value="${item.quantity}">
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading order items:', error);
                container.innerHTML = '<p class="text-danger">Fehler beim Laden der Bestellartikel</p>';
            }
        }
        
        async function submitGoodsReceipt() {
            const form = document.getElementById('goodsReceiptForm');
            const formData = new FormData(form);
            const receiptItems = document.querySelectorAll('.receipt-item');
            
            const items = [];
            receiptItems.forEach((item, index) => {
                const productId = formData.get(`product_id_${index}`);
                const orderedQuantity = parseFloat(formData.get(`ordered_quantity_${index}`)) || 0;
                const receivedQuantity = parseFloat(formData.get(`received_quantity_${index}`)) || 0;
                const condition = formData.get(`condition_${index}`);
                const unitPrice = parseFloat(formData.get(`unit_price_${index}`)) || 0;
                
                items.push({
                    product_id: parseInt(productId),
                    ordered_quantity: orderedQuantity,
                    received_quantity: receivedQuantity,
                    condition: condition,
                    unit_price: unitPrice,
                    notes: ''
                });
            });
            
            const receiptData = {
                order_id: parseInt(formData.get('order_id')),
                receipt_number: formData.get('receipt_number'),
                received_date: formData.get('received_date'),
                notes: formData.get('notes'),
                items: items
            };
            
            try {
                await api.post('/goods-receipts', receiptData);
                showToast('Wareneingang erfolgreich erfasst', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                modal.hide();
                
                // Refresh data
                await loadGoodsReceipts();
                await loadPendingDeliveries();
                await loadInventory();
                
            } catch (error) {
                console.error('Error creating goods receipt:', error);
                showToast('Fehler beim Erfassen des Wareneingangs', 'error');
            }
        }
        
        function viewGoodsReceipt(receiptId) {
            // Implementation for viewing goods receipt details
            showToast('Wareneingang-Details werden geladen...', 'info');
        }
        
        function editGoodsReceipt(receiptId) {
            // Implementation for editing goods receipt
            showToast('Wareneingang-Bearbeitung wird ge√∂ffnet...', 'info');
        }
        
        async function deleteGoodsReceipt(receiptId) {
            if (!confirm('M√∂chten Sie diesen Wareneingang wirklich l√∂schen?')) {
                return;
            }
            
            try {
                await api.delete(`/goods-receipts/${receiptId}`);
                showToast('Wareneingang gel√∂scht', 'success');
                await loadGoodsReceipts();
            } catch (error) {
                console.error('Error deleting goods receipt:', error);
                showToast('Fehler beim L√∂schen des Wareneingangs', 'error');
            }
        }
        
        function showGoodsReceipts() {
            document.getElementById('goods-receipts-tab').click();
        }
        
        function showPendingDeliveries() {
            document.getElementById('pending-deliveries-tab').click();
        }
        
        function createGoodsReceipt() {
            // Show modal to select order or create manual receipt
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Neuer Wareneingang</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Wie m√∂chten Sie den Wareneingang erfassen?</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="showPendingOrdersForReceipt()">Aus bestehender Bestellung</button>
                                <button class="btn btn-outline-primary" onclick="createManualGoodsReceipt()">Manueller Wareneingang</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        function showPendingOrdersForReceipt() {
            // Close current modal and show pending deliveries tab
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            modal.hide();
            document.getElementById('pending-deliveries-tab').click();
        }
        
        function createManualGoodsReceipt() {
            showToast('Manueller Wareneingang wird implementiert...', 'info');
        }

        // Load appropriate data when switching inventory tabs
        document.addEventListener('DOMContentLoaded', function() {
            const inventoryTabs = document.querySelectorAll('#inventoryTabs button[data-bs-toggle="tab"]');
            inventoryTabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target').substring(1);
                    switch(targetId) {
                        case 'stock':
                            loadInventory();
                            break;
                        case 'goods-receipts':
                            loadGoodsReceipts();
                            break;
                        case 'pending-deliveries':
                            loadPendingDeliveries();
                            break;
                    }
                });
            });
        });
        
        function transferStock(productId) {
            const transferModal = document.createElement('div');
            transferModal.className = 'modal fade';
            transferModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Umlagerung</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Produkt ID</label>
                                <input type="text" class="form-control" value="${productId}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Von Lager</label>
                                <select class="form-select" id="fromWarehouse">
                                    <option value="main">Hauptlager</option>
                                    <option value="kitchen">K√ºchenlager</option>
                                    <option value="cold">K√ºhllager</option>
                                    <option value="dry">Trockenlager</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Zu Lager</label>
                                <select class="form-select" id="toWarehouse">
                                    <option value="main">Hauptlager</option>
                                    <option value="kitchen">K√ºchenlager</option>
                                    <option value="cold">K√ºhllager</option>
                                    <option value="dry">Trockenlager</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Menge</label>
                                <input type="number" class="form-control" id="transferAmount" placeholder="Menge zur Umlagerung">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Grund</label>
                                <input type="text" class="form-control" id="transferReason" placeholder="Grund f√ºr Umlagerung">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-warning" data-action="processTransfer" data-param="${productId}">Umlagerung durchf√ºhren</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(transferModal);
            const modal = new bootstrap.Modal(transferModal);
            modal.show();
        }

        function processTransfer(productId) {
            const fromWarehouse = document.getElementById('fromWarehouse').value;
            const toWarehouse = document.getElementById('toWarehouse').value;
            const amount = document.getElementById('transferAmount').value;
            const reason = document.getElementById('transferReason').value;
            
            if (!amount || fromWarehouse === toWarehouse) {
                showToast('‚ö†Ô∏è Bitte pr√ºfen Sie die Umlagerungsdaten!', 'warning');
                return;
            }
            
            const warehouseNames = {
                main: 'Hauptlager',
                kitchen: 'K√ºchenlager',
                cold: 'K√ºhllager',
                dry: 'Trockenlager'
            };
            
            showToast(`‚úÖ Umlagerung abgeschlossen! ${amount} Einheiten von ${warehouseNames[fromWarehouse]} zu ${warehouseNames[toWarehouse]}`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            modal.hide();
        }

        function requestReorder(productId) {
            const reorderModal = document.createElement('div');
            reorderModal.className = 'modal fade';
            reorderModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Nachbestellung</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Niedriger Bestand erkannt!</strong> Eine Nachbestellung wird empfohlen.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Produkt ID</label>
                                <input type="text" class="form-control" value="${productId}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Aktueller Bestand</label>
                                <input type="text" class="form-control" value="${Math.floor(Math.random() * 10) + 1} kg" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Empfohlene Bestellmenge</label>
                                <input type="number" class="form-control" id="reorderAmount" value="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bevorzugter Lieferant</label>
                                <select class="form-select" id="preferredSupplier">
                                    <option value="1">Bio-Frische GmbH</option>
                                    <option value="2">Regionale K√∂stlichkeiten</option>
                                    <option value="3">Gro√ük√ºchen-Service</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Priorit√§t</label>
                                <select class="form-select" id="orderPriority">
                                    <option value="low">Niedrig</option>
                                    <option value="medium">Mittel</option>
                                    <option value="high">Hoch</option>
                                    <option value="urgent">Dringend</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-danger" data-action="submitReorder" data-param="${productId}">Nachbestellung erstellen</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(reorderModal);
            const modal = new bootstrap.Modal(reorderModal);
            modal.show();
        }

        function submitReorder(productId) {
            const amount = document.getElementById('reorderAmount').value;
            const supplier = document.getElementById('preferredSupplier').value;
            const priority = document.getElementById('orderPriority').value;
            
            const priorityText = {
                low: 'Niedrig',
                medium: 'Mittel',
                high: 'Hoch',
                urgent: 'Dringend'
            };
            
            showToast(`‚úÖ Nachbestellung erstellt! ${amount} Einheiten, Priorit√§t: ${priorityText[priority]}`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            modal.hide();
            
            // Update status in inventory table
            setTimeout(() => {
                const inventoryRows = document.querySelectorAll('#inventoryTable tbody tr');
                if (inventoryRows[productId - 1]) {
                    const statusCell = inventoryRows[productId - 1].querySelector('td:nth-child(4)');
                    statusCell.innerHTML = '<span class="badge bg-info">Nachbestellt</span>';
                }
            }, 500);
        }

        // ===== PRODUCT MANAGEMENT =====
        
        function viewProductDetails(productId) {
            const detailsModal = document.createElement('div');
            detailsModal.className = 'modal fade';
            detailsModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Produkt Details - ID: ${productId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Grunddaten</h6>
                                    <p><strong>Produkt-ID:</strong> ${productId}</p>
                                    <p><strong>Name:</strong> Beispielprodukt ${productId}</p>
                                    <p><strong>Kategorie:</strong> Lebensmittel</p>
                                    <p><strong>Lieferant:</strong> Bio-Frische GmbH</p>
                                    <p><strong>Preis:</strong> ‚Ç¨${(Math.random() * 10 + 1).toFixed(2)}/kg</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Bestandsdaten</h6>
                                    <p><strong>Aktueller Bestand:</strong> ${Math.floor(Math.random() * 100) + 10} kg</p>
                                    <p><strong>Mindestbestand:</strong> 20 kg</p>
                                    <p><strong>Lagerort:</strong> K√ºhlraum A</p>
                                    <p><strong>Letzte Lieferung:</strong> ${new Date().toLocaleDateString()}</p>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>N√§hrwerte (pro 100g)</h6>
                                    <table class="table table-sm">
                                        <tr><td>Kalorien:</td><td>${Math.floor(Math.random() * 300 + 50)} kcal</td></tr>
                                        <tr><td>Protein:</td><td>${Math.floor(Math.random() * 20 + 5)} g</td></tr>
                                        <tr><td>Kohlenhydrate:</td><td>${Math.floor(Math.random() * 50 + 10)} g</td></tr>
                                        <tr><td>Fett:</td><td>${Math.floor(Math.random() * 15 + 2)} g</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Allergene & Zus√§tze</h6>
                                    <span class="badge bg-warning me-1">Gluten</span>
                                    <span class="badge bg-info me-1">Laktose</span>
                                    <span class="badge bg-success me-1">Bio</span>
                                    <span class="badge bg-secondary me-1">Vegan</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                            <button type="button" class="btn btn-primary" data-action="editProductDetails" data-param="${productId}">Bearbeiten</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(detailsModal);
            const modal = new bootstrap.Modal(detailsModal);
            modal.show();
        }

        function editProductDetails(productId) {
            const editModal = document.createElement('div');
            editModal.className = 'modal fade';
            editModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Produkt bearbeiten - ID: ${productId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Produktname</label>
                                        <input type="text" class="form-control" id="productName" value="Beispielprodukt ${productId}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kategorie</label>
                                        <select class="form-select" id="productCategory">
                                            <option value="vegetables">Gem√ºse</option>
                                            <option value="meat">Fleisch</option>
                                            <option value="dairy">Milchprodukte</option>
                                            <option value="grains">Getreide</option>
                                            <option value="spices">Gew√ºrze</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Preis (‚Ç¨/kg)</label>
                                        <input type="number" class="form-control" id="productPrice" value="${(Math.random() * 10 + 1).toFixed(2)}" step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Mindestbestand</label>
                                        <input type="number" class="form-control" id="minStock" value="20">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Lagerort</label>
                                        <input type="text" class="form-control" id="storageLocation" value="K√ºhlraum A">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Haltbarkeit (Tage)</label>
                                        <input type="number" class="form-control" id="shelfLife" value="7">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Beschreibung</label>
                                <textarea class="form-control" id="productDescription" rows="3">Hochqualitatives Produkt f√ºr die Gro√ük√ºche</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-primary" data-action="saveProductChanges" data-param="${productId}">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
            const modal = new bootstrap.Modal(editModal);
            modal.show();
        }

        function saveProductChanges(productId) {
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const price = document.getElementById('productPrice').value;
            
            showToast(`‚úÖ Produkt ${name} erfolgreich aktualisiert!`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            modal.hide();
        }

        function deleteProduct(productId) {
            if (confirm('M√∂chten Sie dieses Produkt wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                showToast(`‚ö†Ô∏è Produkt ${productId} wurde gel√∂scht!`, 'warning');
                
                // Remove from product table
                setTimeout(() => {
                    const productRows = document.querySelectorAll('#productsTable tbody tr');
                    if (productRows[productId - 1]) {
                        productRows[productId - 1].remove();
                    }
                }, 500);
            }
        }

        // ===== RECIPE MANAGEMENT =====
        
        function editRecipe(recipeId) {
            const editModal = document.createElement('div');
            editModal.className = 'modal fade';
            editModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Rezept bearbeiten</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Rezeptname</label>
                                <input type="text" class="form-control" id="recipeName" value="Beispielrezept ${recipeId}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kategorie</label>
                                <select class="form-select" id="recipeCategory">
                                    <option value="appetizer">Vorspeise</option>
                                    <option value="main">Hauptspeise</option>
                                    <option value="dessert">Nachspeise</option>
                                    <option value="soup">Suppe</option>
                                    <option value="salad">Salat</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Portionen</label>
                                        <input type="number" class="form-control" id="servings" value="4">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Zubereitungszeit (Min)</label>
                                        <input type="number" class="form-control" id="cookingTime" value="30">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Zutaten</label>
                                <textarea class="form-control" id="ingredients" rows="4">200g Hackfleisch
150g Zwiebeln
2 Tomaten
Salt, Pfeffer nach Geschmack</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Zubereitung</label>
                                <textarea class="form-control" id="instructions" rows="4">1. Zwiebeln schneiden und anbraten
2. Hackfleisch hinzuf√ºgen und anbraten
3. Tomaten hinzuf√ºgen und w√ºrzen
4. 20 Minuten k√∂cheln lassen</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-primary" data-action="saveRecipeChanges" data-param="${recipeId}">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
            const modal = new bootstrap.Modal(editModal);
            modal.show();
        }

        function saveRecipeChanges(recipeId) {
            const name = document.getElementById('recipeName').value;
            const category = document.getElementById('recipeCategory').value;
            const servings = document.getElementById('servings').value;
            const cookingTime = document.getElementById('cookingTime').value;
            
            showToast(`‚úÖ Rezept "${name}" erfolgreich aktualisiert!`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            modal.hide();
        }

        function copyRecipe(recipeId) {
            const copyModal = document.createElement('div');
            copyModal.className = 'modal fade';
            copyModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Rezept kopieren</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Neuer Rezeptname</label>
                                <input type="text" class="form-control" id="newRecipeName" value="Kopie von Beispielrezept ${recipeId}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Anpassungen</label>
                                <textarea class="form-control" id="recipeChanges" rows="3" placeholder="Beschreiben Sie die √Ñnderungen am kopierten Rezept..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-success" data-action="createRecipeCopy" data-param="${recipeId}">Kopie erstellen</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(copyModal);
            const modal = new bootstrap.Modal(copyModal);
            modal.show();
        }

        function createRecipeCopy(recipeId) {
            const newName = document.getElementById('newRecipeName').value;
            const changes = document.getElementById('recipeChanges').value;
            
            showToast(`‚úÖ Rezept "${newName}" erfolgreich erstellt!`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            modal.hide();
        }

        function applyAIRecommendation(id) {
            showToast(`ü§ñ KI-Empfehlung ${id} wird angewendet...`, 'info');
            
            setTimeout(() => {
                showToast('‚úÖ Empfehlung erfolgreich angewendet!', 'success');
                
                // Update savings
                const currentSavings = parseInt(document.getElementById('aiSavingsAmount').textContent.replace('‚Ç¨', '').replace(',', ''));
                document.getElementById('aiSavingsAmount').textContent = `‚Ç¨${(currentSavings + 67).toLocaleString()}`;
                
            }, 1500);
        }

        function exportMealPlan() {
            showToast('üìÑ Speiseplan wird exportiert...', 'info');
            setTimeout(() => showToast('‚úÖ Speiseplan erfolgreich exportiert!', 'success'), 2000);
        }

        function exportProducts() {
            showToast('üìÑ Produktdaten werden exportiert...', 'info');
            setTimeout(() => showToast('‚úÖ Produktdaten erfolgreich exportiert!', 'success'), 1500);
        }

        function exportAnalytics() {
            showToast('üìä Analytics-Report wird erstellt...', 'info');
            setTimeout(() => showToast('‚úÖ Analytics-Report erfolgreich exportiert!', 'success'), 2000);
        }

        // ===== PRICE MONITORING =====
        
        async function loadPriceMonitoring() {
            try {
                // Load price trends
                const trendsResponse = await fetch(`${API_BASE_URL}/price-monitoring/trends`);
                if (trendsResponse.ok) {
                    const trends = await trendsResponse.json();
                    updatePriceTrends(trends);
                }
                
                // Load active alerts
                const alertsResponse = await fetch(`${API_BASE_URL}/price-monitoring/alerts`);
                if (alertsResponse.ok) {
                    const alerts = await alertsResponse.json();
                    updatePriceAlerts(alerts);
                }
                
                // Load price comparisons for top products
                loadSupplierComparisons();
                
                // Initialize chart
                initializePriceHistoryChart();
                
            } catch (error) {
                console.error('Failed to load price monitoring:', error);
                showToast('‚ùå Fehler beim Laden der Preis√ºberwachung', 'error');
            }
        }
        
        function updatePriceTrends(data) {
            document.getElementById('priceIncreaseCount').textContent = data.summary?.rising || 0;
            document.getElementById('priceDecreaseCount').textContent = data.summary?.falling || 0;
            
            // Update biggest changes list
            const changesList = document.getElementById('biggestChanges');
            changesList.innerHTML = '';
            
            data.trends?.slice(0, 5).forEach(trend => {
                const changeClass = trend.change > 0 ? 'text-danger' : 'text-success';
                const arrow = trend.change > 0 ? '‚Üë' : '‚Üì';
                
                changesList.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${trend.productName}</h6>
                            <small class="text-muted">‚Ç¨${trend.firstPrice.toFixed(2)} ‚Üí ‚Ç¨${trend.lastPrice.toFixed(2)}</small>
                        </div>
                        <div class="${changeClass}">
                            <strong>${arrow} ${Math.abs(trend.change)}%</strong>
                        </div>
                    </div>
                `;
            });
        }
        
        function updatePriceAlerts(alerts) {
            document.getElementById('activeAlertsCount').textContent = alerts.filter(a => a.active).length;
            
            const alertsTable = document.getElementById('priceAlertsTable');
            alertsTable.innerHTML = '';
            
            alerts.forEach(alert => {
                const statusClass = alert.triggered > 0 ? 'text-danger' : 'text-success';
                const statusText = alert.triggered > 0 ? `${alert.triggered}x ausgel√∂st` : 'Aktiv';
                
                alertsTable.innerHTML += `
                    <tr>
                        <td>Produkt ${alert.productId}</td>
                        <td>${getAlertTypeText(alert.type)}</td>
                        <td>${alert.threshold}${alert.type.includes('threshold') ? '‚Ç¨' : '%'}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${alert.lastTriggered ? new Date(alert.lastTriggered).toLocaleDateString('de-DE') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAlert('${alert.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function getAlertTypeText(type) {
            const types = {
                'increase': 'Preiserh√∂hung',
                'decrease': 'Preissenkung',
                'threshold_above': '√úberschreitung',
                'threshold_below': 'Unterschreitung'
            };
            return types[type] || type;
        }
        
        async function loadSupplierComparisons() {
            try {
                // For demo, load top 10 products
                const productsResponse = await fetch(`${API_BASE_URL}/products?limit=10`);
                if (!productsResponse.ok) return;
                
                const products = await productsResponse.json();
                const comparisonTable = document.getElementById('supplierComparisonTable');
                comparisonTable.innerHTML = '';
                
                let totalSavings = 0;
                
                for (const product of products.data || products) {
                    const comparisonResponse = await fetch(`${API_BASE_URL}/price-monitoring/compare/${product.id}`);
                    if (comparisonResponse.ok) {
                        const comparison = await comparisonResponse.json();
                        if (comparison.suppliers && comparison.suppliers.length > 1) {
                            const savings = parseFloat(comparison.potentialSaving || 0);
                            totalSavings += savings;
                            
                            comparisonTable.innerHTML += `
                                <tr>
                                    <td>${product.name}</td>
                                    <td>${comparison.suppliers[0].supplierName}</td>
                                    <td>‚Ç¨${comparison.suppliers[0].price.toFixed(2)}</td>
                                    <td class="text-success">${comparison.bestPrice.supplierName}</td>
                                    <td class="text-success">‚Ç¨${comparison.bestPrice.price.toFixed(2)}</td>
                                    <td class="text-warning">‚Ç¨${savings.toFixed(2)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="switchSupplier(${product.id}, ${comparison.bestPrice.supplierId})">
                                            Wechseln
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }
                    }
                }
                
                document.getElementById('potentialSavings').textContent = `‚Ç¨${totalSavings.toFixed(2)}`;
                
            } catch (error) {
                console.error('Failed to load supplier comparisons:', error);
            }
        }
        
        function initializePriceHistoryChart() {
            const ctx = document.getElementById('priceHistoryChart');
            if (!ctx) return;
            
            // Sample data for demonstration
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Vor 30 Tagen', 'Vor 25 Tagen', 'Vor 20 Tagen', 'Vor 15 Tagen', 'Vor 10 Tagen', 'Vor 5 Tagen', 'Heute'],
                    datasets: [{
                        label: 'Kartoffeln',
                        data: [1.20, 1.25, 1.30, 1.45, 1.60, 1.55, 1.80],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }, {
                        label: 'Tomaten',
                        data: [2.50, 2.45, 2.60, 2.80, 2.75, 2.90, 3.10],
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1
                    }, {
                        label: 'Rindfleisch',
                        data: [8.50, 8.60, 8.80, 9.20, 9.50, 9.45, 10.20],
                        borderColor: 'rgb(255, 205, 86)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function showPriceAlertModal() {
            const modal = new bootstrap.Modal(document.getElementById('priceAlertModal'));
            
            // Load products for dropdown
            fetch(`${API_BASE_URL}/products`)
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('alertProductId');
                    select.innerHTML = '<option value="">Produkt w√§hlen...</option>';
                    (data.data || data).forEach(product => {
                        select.innerHTML += `<option value="${product.id}">${product.name}</option>`;
                    });
                });
            
            modal.show();
        }
        
        async function createPriceAlert() {
            const alertData = {
                name: document.getElementById('alertName').value,
                productId: document.getElementById('alertProductId').value,
                type: document.getElementById('alertType').value,
                threshold: document.getElementById('alertThreshold').value,
                email: document.getElementById('alertEmail').value
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/price-monitoring/alerts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-tenant-id': TENANT_ID
                    },
                    body: JSON.stringify(alertData)
                });
                
                if (response.ok) {
                    showToast('‚úÖ Preisalarm erfolgreich erstellt!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('priceAlertModal')).hide();
                    loadPriceMonitoring(); // Reload data
                } else {
                    showToast('‚ùå Fehler beim Erstellen des Preisalarms', 'error');
                }
            } catch (error) {
                console.error('Failed to create price alert:', error);
                showToast('‚ùå Fehler beim Erstellen des Preisalarms', 'error');
            }
        }
        
        async function deleteAlert(alertId) {
            if (!confirm('M√∂chten Sie diesen Preisalarm wirklich l√∂schen?')) return;
            
            try {
                // In real app, would DELETE to API
                showToast('‚úÖ Preisalarm gel√∂scht', 'success');
                loadPriceMonitoring();
            } catch (error) {
                showToast('‚ùå Fehler beim L√∂schen', 'error');
            }
        }
        
        async function switchSupplier(productId, newSupplierId) {
            if (!confirm('M√∂chten Sie wirklich den Lieferanten wechseln?')) return;
            
            try {
                // In real app, would update product's supplier
                showToast('‚úÖ Lieferant erfolgreich gewechselt!', 'success');
                loadSupplierComparisons();
            } catch (error) {
                showToast('‚ùå Fehler beim Lieferantenwechsel', 'error');
            }
        }
        
        function exportPriceReport() {
            showToast('üìä Preisbericht wird erstellt...', 'info');
            setTimeout(() => showToast('‚úÖ Preisbericht erfolgreich exportiert!', 'success'), 2000);
        }
        
        // Update price trend period
        document.getElementById('priceTrendPeriod')?.addEventListener('change', (e) => {
            showToast(`üìä Lade Daten f√ºr ${e.target.selectedOptions[0].text}...`, 'info');
            // Reload chart with new period
            initializePriceHistoryChart();
        });

        function startInventoryCheck() {
            showToast('üìã Inventur wird gestartet...', 'info');
            setTimeout(() => showToast('‚úÖ Inventur erfolgreich abgeschlossen!', 'success'), 3000);
        }

        function runPriceComparison() {
            showToast('üîç Preisvergleich wird gestartet...', 'info');
            loadPriceComparisonData();
        }

        // ========= ANALYTICS FUNCTIONS =========
        async function loadAnalytics() {
            try {
                // Load price comparison data
                await loadPriceComparisonData();
                
                // Load cost trends
                await loadCostTrends();
                
                // Load savings opportunities table
                await loadSavingsOpportunities();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Fehler beim Laden der Analytics', 'error');
            }
        }

        async function loadPriceComparisonData() {
            try {
                const response = await fetch(`${API_BASE_URL}/analytics/price-comparison`, {
                    headers: { 'x-tenant-id': TENANT_ID }
                });
                
                if (!response.ok) throw new Error('Failed to load price comparison');
                
                const data = await response.json();
                
                // Prepare data for chart
                const labels = data.products.map(p => p.name.length > 20 ? p.name.substring(0, 20) + '...' : p.name);
                const currentPrices = data.products.map(p => p.currentPrice);
                const lowestPrices = data.products.map(p => p.lowestPrice);
                
                // Initialize or update price comparison chart
                const ctx = document.getElementById('priceComparisonChart');
                if (ctx) {
                    const chartCtx = ctx.getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.priceComparisonChartInstance) {
                        window.priceComparisonChartInstance.destroy();
                    }
                    
                    window.priceComparisonChartInstance = new Chart(chartCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Aktueller Preis',
                                data: currentPrices,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }, {
                                label: 'G√ºnstigster Preis',
                                data: lowestPrices,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Preisvergleich Top 10 Produkte'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ‚Ç¨' + context.parsed.y.toFixed(2);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '‚Ç¨' + value.toFixed(2);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Update savings opportunities
                if (data.totalPotentialSavings > 0) {
                    showToast(`‚úÖ Preisvergleich abgeschlossen! M√∂gliche Einsparungen: ‚Ç¨${data.totalPotentialSavings.toFixed(2)}`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading price comparison:', error);
                showToast('Fehler beim Laden des Preisvergleichs', 'error');
            }
        }

        async function loadCostTrends() {
            try {
                const response = await fetch(`${API_BASE_URL}/analytics/cost-trends?period=month`, {
                    headers: { 'x-tenant-id': TENANT_ID }
                });
                
                if (!response.ok) throw new Error('Failed to load cost trends');
                
                const data = await response.json();
                
                // Prepare data for chart
                const labels = data.trends.map(t => {
                    const date = new Date(t.date);
                    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                });
                const costs = data.trends.map(t => t.cost);
                
                // Initialize or update cost trend chart
                const ctx = document.getElementById('costTrendChart');
                if (ctx) {
                    const chartCtx = ctx.getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.costTrendChartInstance) {
                        window.costTrendChartInstance.destroy();
                    }
                    
                    window.costTrendChartInstance = new Chart(chartCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Tageskosten',
                                data: costs,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Kostenentwicklung (30 Tage)'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'Kosten: ‚Ç¨' + context.parsed.y.toFixed(2);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '‚Ç¨' + value;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading cost trends:', error);
                showToast('Fehler beim Laden der Kostentrends', 'error');
            }
        }

        async function loadSavingsOpportunities() {
            try {
                const response = await fetch(`${API_BASE_URL}/analytics/price-comparison`, {
                    headers: { 'x-tenant-id': TENANT_ID }
                });
                
                if (!response.ok) throw new Error('Failed to load savings opportunities');
                
                const data = await response.json();
                
                // Update the savings table
                const tbody = document.querySelector('#analytics table tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    
                    // Show top 5 savings opportunities
                    const topSavings = data.products
                        .filter(p => p.potentialSaving > 0)
                        .sort((a, b) => b.potentialSaving - a.potentialSaving)
                        .slice(0, 5);
                    
                    topSavings.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${product.name}</strong></td>
                            <td>‚Ç¨${product.currentPrice.toFixed(2)}</td>
                            <td>‚Ç¨${product.lowestPrice.toFixed(2)}</td>
                            <td><strong class="text-success">‚Ç¨${product.potentialSaving.toFixed(2)}</strong></td>
                            <td>${product.lowestSupplier}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="switchSupplier(${product.id}, '${product.lowestSupplier}')">
                                    <i class="bi bi-check-circle me-1"></i>Wechseln
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Add summary row if there are savings
                    if (topSavings.length > 0) {
                        const summaryRow = document.createElement('tr');
                        summaryRow.className = 'table-info fw-bold';
                        summaryRow.innerHTML = `
                            <td colspan="3">Gesamtpotential (Top 5)</td>
                            <td colspan="3" class="text-success">‚Ç¨${topSavings.reduce((sum, p) => sum + p.potentialSaving, 0).toFixed(2)}</td>
                        `;
                        tbody.appendChild(summaryRow);
                    }
                }
                
            } catch (error) {
                console.error('Error loading savings opportunities:', error);
            }
        }

        function switchSupplier(productId, supplierName) {
            showToast(`Lieferantenwechsel zu ${supplierName} wird vorbereitet...`, 'info');
            // In a real implementation, this would update the product's supplier
            setTimeout(() => {
                showToast(`‚úÖ Lieferant erfolgreich gewechselt zu ${supplierName}`, 'success');
                loadSavingsOpportunities(); // Reload the table
            }, 1500);
        }

        function filterProducts(searchTerm) {
            console.log('Filtering products:', searchTerm);
        }

        function filterByCategory(category) {
            console.log('Filtering by category:', category);
        }

        function filterByStock(stock) {
            console.log('Filtering by stock:', stock);
        }

        function filterByStatus(status) {
            console.log('Filtering by status:', status);
        }

        function clearProductFilters() {
            showToast('üîÑ Filter zur√ºckgesetzt', 'info');
        }

        function logout() {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                showToast('üëã Abmeldung erfolgreich', 'info');
            }
        }

        // ===== API CLIENT =====
        
        // Dynamic API URL - works for Railway HTTPS and local HTTP
        const API_BASE_URL = window.location.origin + '/api';
        console.log('API_BASE_URL configured as:', API_BASE_URL);
        const TENANT_ID = 'demo';
        
        class APIClient {
            constructor() {
                this.baseURL = API_BASE_URL;
                this.tenantId = TENANT_ID;
            }
            
            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-tenant-id': this.tenantId,
                        ...options.headers
                    },
                    ...options
                };
                
                try {
                    const response = await fetch(url, config);
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: 'Network error' }));
                        throw new Error(error.error || `HTTP ${response.status}`);
                    }
                    
                    // Handle 204 No Content responses
                    if (response.status === 204) {
                        return null;
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API Request failed:', error);
                    throw error;
                }
            }
            
            // Products API
            async getProducts(params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const endpoint = `/products${queryString ? '?' + queryString : ''}`;
                return this.request(endpoint);
            }
            
            async getProduct(id) {
                return this.request(`/products/${id}`);
            }
            
            async createProduct(productData) {
                return this.request('/products', {
                    method: 'POST',
                    body: JSON.stringify(productData)
                });
            }
            
            async updateProduct(id, productData) {
                return this.request(`/products/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(productData)
                });
            }
            
            async deleteProduct(id) {
                return this.request(`/products/${id}`, {
                    method: 'DELETE'
                });
            }
            
            async updateProductStock(id, stockData) {
                return this.request(`/products/${id}/stock`, {
                    method: 'PUT',
                    body: JSON.stringify(stockData)
                });
            }
            
            async getLowStockProducts() {
                return this.request('/products/stock/low');
            }
            
            async getProductCategories() {
                return this.request('/products/categories/all');
            }
            
            // Suppliers API
            async getSuppliers(params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const endpoint = `/suppliers${queryString ? '?' + queryString : ''}`;
                return this.request(endpoint);
            }
            
            async getSupplier(id) {
                return this.request(`/suppliers/${id}`);
            }
            
            async createSupplier(supplierData) {
                return this.request('/suppliers', {
                    method: 'POST',
                    body: JSON.stringify(supplierData)
                });
            }
            
            async updateSupplier(id, supplierData) {
                return this.request(`/suppliers/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(supplierData)
                });
            }
            
            async deleteSupplier(id) {
                return this.request(`/suppliers/${id}`, {
                    method: 'DELETE'
                });
            }
            
            async rateSupplier(id, rating, comment) {
                return this.request(`/suppliers/${id}/rate`, {
                    method: 'POST',
                    body: JSON.stringify({ rating, comment })
                });
            }
            
            // Orders API
            async getOrders(params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const endpoint = `/orders${queryString ? '?' + queryString : ''}`;
                return this.request(endpoint);
            }
            
            async getOrder(id) {
                return this.request(`/orders/${id}`);
            }
            
            async createOrder(orderData) {
                return this.request('/orders', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
            }
            
            async updateOrder(id, orderData) {
                return this.request(`/orders/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(orderData)
                });
            }
            
            async confirmOrder(id) {
                return this.request(`/orders/${id}/confirm`, {
                    method: 'PUT'
                });
            }
            
            async deliverOrder(id) {
                return this.request(`/orders/${id}/deliver`, {
                    method: 'PUT'
                });
            }
            
            async cancelOrder(id) {
                return this.request(`/orders/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Recipes API
            async getRecipes(params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const endpoint = `/recipes${queryString ? '?' + queryString : ''}`;
                return this.request(endpoint);
            }
            
            async getRecipe(id) {
                return this.request(`/recipes/${id}`);
            }
            
            async createRecipe(recipeData) {
                return this.request('/recipes', {
                    method: 'POST',
                    body: JSON.stringify(recipeData)
                });
            }
            
            async updateRecipe(id, recipeData) {
                return this.request(`/recipes/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(recipeData)
                });
            }
            
            async deleteRecipe(id) {
                return this.request(`/recipes/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Dashboard API
            async getDashboardStats() {
                try {
                    const [products, suppliers, orders, lowStock, analyticsData] = await Promise.all([
                        this.getProducts({ limit: 1 }),
                        this.getSuppliers({ limit: 1 }),
                        this.getOrders({ limit: 1 }),
                        this.getLowStockProducts(),
                        fetch(`${API_BASE_URL}/analytics/dashboard`, {
                            headers: { 'x-tenant-id': TENANT_ID }
                        }).then(res => res.json())
                    ]);
                    
                    return {
                        totalProducts: products.pagination.total,
                        totalSuppliers: suppliers.pagination.total,
                        totalOrders: orders.pagination.total,
                        lowStockCount: lowStock.length,
                        ...analyticsData // Merge analytics data
                    };
                } catch (error) {
                    console.error('Failed to load dashboard stats:', error);
                    return {
                        totalProducts: 0,
                        totalSuppliers: 0,
                        totalOrders: 0,
                        lowStockCount: 0,
                        activeProducts: 0,
                        activeSuppliers: 0,
                        activeRecipes: 0,
                        inventoryValue: 0,
                        costSavings: 0,
                        ordersToday: 0
                    };
                }
            }
        }
        
        // Initialize API client
        const api = new APIClient();
        
        // ===== ADVANCED FILTERS =====
        
        // State for advanced filters
        let advancedFilters = {
            priceRange: { min: 0, max: 999 },
            timeRange: { min: 0, max: 120 },
            allergens: [],
            season: 'all',
            category: 'all',
            difficulty: 'all'
        };
        
        function applyAdvancedFilters() {
            console.log('Applying advanced filters:', advancedFilters);
            
            // Get current tab to determine what to filter
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;
            
            const tabId = activeTab.id;
            
            if (tabId === 'recipes') {
                // Filter recipes based on advanced criteria
                filterRecipes();
            } else if (tabId === 'mealplanning') {
                // Filter recipe library in meal planning
                filterRecipeLibrary();
            }
            
            showToast('Filter angewendet', 'success');
        }
        
        function resetAdvancedFilters() {
            advancedFilters = {
                priceRange: { min: 0, max: 999 },
                timeRange: { min: 0, max: 120 },
                allergens: [],
                season: 'all',
                category: 'all',
                difficulty: 'all'
            };
            
            // Reset UI elements
            const filterInputs = document.querySelectorAll('.filter-input');
            filterInputs.forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else if (input.type === 'number') input.value = input.defaultValue || '';
                else if (input.tagName === 'SELECT') input.selectedIndex = 0;
            });
            
            applyAdvancedFilters();
            showToast('Filter zur√ºckgesetzt', 'info');
        }
        
        function filterRecipes() {
            const recipes = document.querySelectorAll('.recipe-item');
            let visibleCount = 0;
            
            recipes.forEach(recipe => {
                const price = parseFloat(recipe.dataset.price || 0);
                const time = parseInt(recipe.dataset.time || 0);
                const allergens = (recipe.dataset.allergens || '').split(',');
                const season = recipe.dataset.season || 'all';
                const category = recipe.dataset.category || 'all';
                const difficulty = recipe.dataset.difficulty || 'medium';
                
                let show = true;
                
                // Price filter
                if (price < advancedFilters.priceRange.min || price > advancedFilters.priceRange.max) {
                    show = false;
                }
                
                // Time filter
                if (time < advancedFilters.timeRange.min || time > advancedFilters.timeRange.max) {
                    show = false;
                }
                
                // Allergen filter
                if (advancedFilters.allergens.length > 0) {
                    const hasAllergen = advancedFilters.allergens.some(a => allergens.includes(a));
                    if (hasAllergen) show = false;
                }
                
                // Season filter
                if (advancedFilters.season !== 'all' && season !== advancedFilters.season) {
                    show = false;
                }
                
                // Category filter
                if (advancedFilters.category !== 'all' && category !== advancedFilters.category) {
                    show = false;
                }
                
                // Difficulty filter
                if (advancedFilters.difficulty !== 'all' && difficulty !== advancedFilters.difficulty) {
                    show = false;
                }
                
                recipe.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });
            
            // Update results count
            const resultsInfo = document.getElementById('filterResultsInfo');
            if (resultsInfo) {
                resultsInfo.textContent = `${visibleCount} Rezepte gefunden`;
            }
        }
        
        function filterRecipeLibrary() {
            // Similar to filterRecipes but for meal planning recipe library
            const recipes = document.querySelectorAll('#recipeLibrary .list-group-item');
            filterRecipes(); // Reuse the same logic
        }
        
        // ===== BATCH OPERATIONS =====
        
        let selectedRecipes = new Set();
        let batchMode = false;
        
        // Update batch selection count
        function updateBatchSelection() {
            const selectedCheckboxes = document.querySelectorAll('.batch-checkbox input:checked');
            const count = selectedCheckboxes.length;
            document.getElementById('selectedRecipeCount').textContent = count;
            
            // Show/hide batch operations bar
            const batchBar = document.getElementById('batchOperationsBar');
            if (batchBar) {
                batchBar.style.display = count > 0 ? 'block' : 'none';
            }
        }
        
        function toggleBatchSelection() {
            batchMode = !batchMode;
            const batchControls = document.getElementById('batchControls');
            
            if (batchMode) {
                // Show batch controls
                if (!batchControls) {
                    const controls = document.createElement('div');
                    controls.id = 'batchControls';
                    controls.className = 'batch-controls p-3 bg-light border rounded mb-3';
                    controls.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="selectAllRecipes()">
                                    <i class="bi bi-check-all"></i> Alle ausw√§hlen
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearBatchSelection()">
                                    <i class="bi bi-x-circle"></i> Auswahl aufheben
                                </button>
                                <span class="ms-3 text-muted">
                                    <span id="selectedCount">0</span> ausgew√§hlt
                                </span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-warning" onclick="batchEditRecipes()">
                                    <i class="bi bi-pencil"></i> Bearbeiten
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="batchDeleteRecipes()">
                                    <i class="bi bi-trash"></i> L√∂schen
                                </button>
                            </div>
                        </div>
                    `;
                    const recipeContent = document.querySelector('#recipes .card-body');
                    if (recipeContent) {
                        recipeContent.insertBefore(controls, recipeContent.firstChild);
                    }
                }
                
                // Add checkboxes to recipes
                addBatchCheckboxes();
            } else {
                // Hide batch controls
                if (batchControls) batchControls.remove();
                removeBatchCheckboxes();
                selectedRecipes.clear();
            }
            
            showToast(batchMode ? 'Stapelverarbeitung aktiviert' : 'Stapelverarbeitung deaktiviert', 'info');
        }
        
        function addBatchCheckboxes() {
            const recipes = document.querySelectorAll('.recipe-item');
            recipes.forEach(recipe => {
                if (!recipe.querySelector('.batch-checkbox')) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'batch-checkbox form-check-input me-2';
                    checkbox.dataset.recipeId = recipe.dataset.id;
                    checkbox.onchange = function() {
                        if (this.checked) {
                            selectedRecipes.add(this.dataset.recipeId);
                        } else {
                            selectedRecipes.delete(this.dataset.recipeId);
                        }
                        updateSelectedCount();
                    };
                    recipe.insertBefore(checkbox, recipe.firstChild);
                }
            });
        }
        
        function removeBatchCheckboxes() {
            const checkboxes = document.querySelectorAll('.batch-checkbox');
            checkboxes.forEach(cb => cb.remove());
        }
        
        function selectAllRecipes() {
            const checkboxes = document.querySelectorAll('.batch-checkbox:not(:checked)');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedRecipes.add(cb.dataset.recipeId);
            });
            updateSelectedCount();
        }
        
        function clearBatchSelection() {
            const checkboxes = document.querySelectorAll('.batch-checkbox:checked');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedRecipes.clear();
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = selectedRecipes.size;
            }
        }
        
        async function batchEditRecipes() {
            if (selectedRecipes.size === 0) {
                showToast('Keine Rezepte ausgew√§hlt', 'warning');
                return;
            }
            
            // Show batch edit modal
            const modal = new bootstrap.Modal(document.getElementById('batchEditModal') || createBatchEditModal());
            modal.show();
        }
        
        async function batchDeleteRecipes() {
            if (selectedRecipes.size === 0) {
                showToast('Keine Rezepte ausgew√§hlt', 'warning');
                return;
            }
            
            if (!confirm(`M√∂chten Sie wirklich ${selectedRecipes.size} Rezepte l√∂schen?`)) {
                return;
            }
            
            try {
                const deletePromises = Array.from(selectedRecipes).map(id => 
                    api.deleteRecipe(id)
                );
                
                await Promise.all(deletePromises);
                showToast(`${selectedRecipes.size} Rezepte erfolgreich gel√∂scht`, 'success');
                
                // Refresh and clear selection
                loadRecipes();
                clearBatchSelection();
                toggleBatchSelection(); // Exit batch mode
            } catch (error) {
                showToast('Fehler beim L√∂schen der Rezepte', 'error');
                console.error('Batch delete error:', error);
            }
        }
        
        function createBatchEditModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'batchEditModal';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Stapelbearbeitung - ${selectedRecipes.size} Rezepte</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="batchEditForm">
                                <div class="mb-3">
                                    <label class="form-label">Kategorie √§ndern</label>
                                    <select class="form-select" id="batchCategory">
                                        <option value="">Nicht √§ndern</option>
                                        <option value="vorspeise">Vorspeise</option>
                                        <option value="hauptgang">Hauptgang</option>
                                        <option value="nachspeise">Nachspeise</option>
                                        <option value="snack">Snack</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Preisanpassung (%)</label>
                                    <input type="number" class="form-control" id="batchPriceAdjust" 
                                           placeholder="z.B. 10 f√ºr +10%, -5 f√ºr -5%">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tags hinzuf√ºgen</label>
                                    <input type="text" class="form-control" id="batchTags" 
                                           placeholder="vegetarisch, glutenfrei, ...">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <button type="button" class="btn btn-primary" onclick="applyBatchEdit()">√Ñnderungen anwenden</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }
        
        async function applyBatchEdit() {
            const category = document.getElementById('batchCategory').value;
            const priceAdjust = parseFloat(document.getElementById('batchPriceAdjust').value) || 0;
            const tags = document.getElementById('batchTags').value.split(',').map(t => t.trim()).filter(t => t);
            
            try {
                const updatePromises = Array.from(selectedRecipes).map(async id => {
                    const recipe = await api.getRecipe(id);
                    const updates = {};
                    
                    if (category) updates.category = category;
                    if (priceAdjust !== 0) {
                        updates.price = recipe.price * (1 + priceAdjust / 100);
                    }
                    if (tags.length > 0) {
                        updates.tags = [...new Set([...(recipe.tags || []), ...tags])];
                    }
                    
                    return api.updateRecipe(id, { ...recipe, ...updates });
                });
                
                await Promise.all(updatePromises);
                showToast('Stapelbearbeitung erfolgreich', 'success');
                
                // Close modal and refresh
                bootstrap.Modal.getInstance(document.getElementById('batchEditModal')).hide();
                loadRecipes();
                clearBatchSelection();
            } catch (error) {
                showToast('Fehler bei der Stapelbearbeitung', 'error');
                console.error('Batch edit error:', error);
            }
        }
        
        // ===== EXPORT FUNCTIONS =====
        
        function showExportModal() {
            const modal = new bootstrap.Modal(document.getElementById('exportModal') || createExportModal());
            modal.show();
        }
        
        function createExportModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'exportModal';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Daten exportieren</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="list-group">
                                <button class="list-group-item list-group-item-action" onclick="exportToPDF()">
                                    <i class="bi bi-file-pdf text-danger me-2"></i>
                                    Als PDF exportieren
                                </button>
                                <button class="list-group-item list-group-item-action" onclick="exportToExcel()">
                                    <i class="bi bi-file-excel text-success me-2"></i>
                                    Als Excel exportieren
                                </button>
                                <button class="list-group-item list-group-item-action" onclick="exportToCSV()">
                                    <i class="bi bi-file-csv text-primary me-2"></i>
                                    Als CSV exportieren
                                </button>
                                <button class="list-group-item list-group-item-action" onclick="exportToICS()">
                                    <i class="bi bi-calendar-event text-info me-2"></i>
                                    Als Kalender (ICS) exportieren
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }
        
        async function exportToPDF() {
            showToast('PDF-Export wird vorbereitet...', 'info');
            
            try {
                // Get current view data
                const activeTab = document.querySelector('.tab-content.active').id;
                let data = {};
                
                switch (activeTab) {
                    case 'mealplanning':
                        data = await getMealPlanData();
                        break;
                    case 'recipes':
                        data = await api.getRecipes();
                        break;
                    case 'products':
                        data = await api.getProducts();
                        break;
                    default:
                        data = { error: 'Unsupported view' };
                }
                
                // In a real implementation, you would use a library like jsPDF
                // For now, we'll simulate the export
                console.log('Exporting to PDF:', data);
                
                setTimeout(() => {
                    showToast('PDF erfolgreich exportiert', 'success');
                    // Trigger download
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `foodsuite-export-${activeTab}-${new Date().toISOString().split('T')[0]}.pdf`;
                    a.click();
                }, 1000);
            } catch (error) {
                showToast('Fehler beim PDF-Export', 'error');
                console.error('PDF export error:', error);
            }
        }
        
        async function exportToExcel() {
            showToast('Excel-Export wird vorbereitet...', 'info');
            
            try {
                const activeTab = document.querySelector('.tab-content.active').id;
                let data = {};
                
                switch (activeTab) {
                    case 'mealplanning':
                        data = await getMealPlanData();
                        break;
                    case 'recipes':
                        data = await api.getRecipes();
                        break;
                    case 'products':
                        data = await api.getProducts();
                        break;
                }
                
                // Convert to CSV format for Excel
                const csv = convertToCSV(data.data || data);
                const blob = new Blob([csv], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `foodsuite-${activeTab}-${new Date().toISOString().split('T')[0]}.xlsx`;
                a.click();
                
                showToast('Excel-Export erfolgreich', 'success');
            } catch (error) {
                showToast('Fehler beim Excel-Export', 'error');
                console.error('Excel export error:', error);
            }
        }
        
        async function exportToCSV() {
            showToast('CSV-Export wird vorbereitet...', 'info');
            
            try {
                const activeTab = document.querySelector('.tab-content.active').id;
                let data = {};
                
                switch (activeTab) {
                    case 'mealplanning':
                        data = await getMealPlanData();
                        break;
                    case 'recipes':
                        data = await api.getRecipes();
                        break;
                    case 'products':
                        data = await api.getProducts();
                        break;
                }
                
                const csv = convertToCSV(data.data || data);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `foodsuite-${activeTab}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                showToast('CSV-Export erfolgreich', 'success');
            } catch (error) {
                showToast('Fehler beim CSV-Export', 'error');
                console.error('CSV export error:', error);
            }
        }
        
        function convertToCSV(data) {
            if (!Array.isArray(data)) return '';
            if (data.length === 0) return '';
            
            // Get headers from first object
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            // Convert data rows
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    // Escape quotes and wrap in quotes if contains comma
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }
        
        async function exportToICS() {
            showToast('Kalender-Export wird vorbereitet...', 'info');
            
            try {
                const mealPlanData = await getMealPlanData();
                const icsContent = generateICS(mealPlanData);
                
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `foodsuite-speiseplan-${new Date().toISOString().split('T')[0]}.ics`;
                a.click();
                
                showToast('Kalender-Export erfolgreich', 'success');
            } catch (error) {
                showToast('Fehler beim Kalender-Export', 'error');
                console.error('ICS export error:', error);
            }
        }
        
        function generateICS(mealPlanData) {
            let ics = 'BEGIN:VCALENDAR\n';
            ics += 'VERSION:2.0\n';
            ics += 'PRODID:-//FoodSuite//Meal Plan//DE\n';
            ics += 'CALSCALE:GREGORIAN\n';
            ics += 'METHOD:PUBLISH\n';
            
            // Add events for each meal
            Object.entries(mealPlanData).forEach(([date, meals]) => {
                meals.forEach(meal => {
                    const uid = `${date}-${meal.id}@foodsuite.local`;
                    const dtstart = date.replace(/-/g, '');
                    
                    ics += 'BEGIN:VEVENT\n';
                    ics += `UID:${uid}\n`;
                    ics += `DTSTART;VALUE=DATE:${dtstart}\n`;
                    ics += `DTEND;VALUE=DATE:${dtstart}\n`;
                    ics += `SUMMARY:${meal.name}\n`;
                    ics += `DESCRIPTION:Preis: ‚Ç¨${meal.price} | Portionen: ${meal.portions}\n`;
                    ics += 'END:VEVENT\n';
                });
            });
            
            ics += 'END:VCALENDAR';
            return ics;
        }
        
        async function getMealPlanData() {
            // Get current meal plan from calendar
            const calendar = document.getElementById('mealCalendar');
            const mealPlan = {};
            
            if (calendar) {
                const cells = calendar.querySelectorAll('.calendar-day');
                cells.forEach(cell => {
                    const date = cell.dataset.date;
                    const meals = cell.querySelectorAll('.meal-item');
                    
                    if (meals.length > 0) {
                        mealPlan[date] = Array.from(meals).map(meal => ({
                            id: meal.dataset.recipeId,
                            name: meal.querySelector('.meal-name').textContent,
                            price: parseFloat(meal.dataset.price || 0),
                            portions: parseInt(meal.dataset.portions || 50)
                        }));
                    }
                });
            }
            
            return mealPlan;
        }
        
        // ===== HISTORY MANAGEMENT =====
        
        const planHistory = [];
        let currentHistoryIndex = -1;
        const MAX_HISTORY_SIZE = 20;
        
        function saveToHistory(planData) {
            // Remove any history items after current index
            if (currentHistoryIndex < planHistory.length - 1) {
                planHistory.splice(currentHistoryIndex + 1);
            }
            
            // Add new history item
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                plan: JSON.parse(JSON.stringify(planData)), // Deep clone
                weekNumber: getCurrentWeekNumber(),
                stats: calculatePlanStats(planData)
            };
            
            planHistory.push(historyItem);
            
            // Limit history size
            if (planHistory.length > MAX_HISTORY_SIZE) {
                planHistory.shift();
            }
            
            currentHistoryIndex = planHistory.length - 1;
            updateHistoryUI();
        }
        
        function calculatePlanStats(planData) {
            let totalCost = 0;
            let totalMeals = 0;
            let totalPortions = 0;
            
            Object.values(planData).forEach(dayMeals => {
                dayMeals.forEach(meal => {
                    totalMeals++;
                    totalCost += meal.price * meal.portions;
                    totalPortions += meal.portions;
                });
            });
            
            return {
                totalCost,
                totalMeals,
                totalPortions,
                avgCostPerPortion: totalPortions > 0 ? totalCost / totalPortions : 0
            };
        }
        
        function showHistoryView() {
            const modal = new bootstrap.Modal(document.getElementById('historyModal') || createHistoryModal());
            updateHistoryList();
            modal.show();
        }
        
        function createHistoryModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'historyModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Speiseplan Historie</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="historyList" class="list-group">
                                <!-- History items will be inserted here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }
        
        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (planHistory.length === 0) {
                historyList.innerHTML = '<p class="text-center text-muted">Keine Historie vorhanden</p>';
                return;
            }
            
            historyList.innerHTML = planHistory.map((item, index) => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">KW ${item.weekNumber} - ${new Date(item.timestamp).toLocaleString('de-DE')}</h6>
                            <p class="mb-1">
                                <small>
                                    ${item.stats.totalMeals} Gerichte | 
                                    ${item.stats.totalPortions} Portionen | 
                                    ‚Ç¨${item.stats.totalCost.toFixed(2)} Gesamt
                                </small>
                            </p>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="restorePlan(${index})">
                                <i class="bi bi-arrow-clockwise"></i> Wiederherstellen
                            </button>
                            <button class="btn btn-outline-secondary" onclick="comparePlans(${index})">
                                <i class="bi bi-diagram-2"></i> Vergleichen
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function restorePlan(historyIndex) {
            if (historyIndex < 0 || historyIndex >= planHistory.length) return;
            
            const historyItem = planHistory[historyIndex];
            
            // Confirm restoration
            if (!confirm(`M√∂chten Sie den Speiseplan von KW ${historyItem.weekNumber} wiederherstellen?`)) {
                return;
            }
            
            // Save current plan to history before restoring
            const currentPlan = getMealPlanData();
            if (Object.keys(currentPlan).length > 0) {
                saveToHistory(currentPlan);
            }
            
            // Restore the plan
            applyPlanToCalendar(historyItem.plan);
            currentHistoryIndex = historyIndex;
            
            showToast('Speiseplan wiederhergestellt', 'success');
            
            // Close history modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('historyModal'));
            if (modal) modal.hide();
        }
        
        function applyPlanToCalendar(planData) {
            // Clear current calendar
            const cells = document.querySelectorAll('.calendar-day .meals-container');
            cells.forEach(cell => cell.innerHTML = '');
            
            // Apply plan data
            Object.entries(planData).forEach(([date, meals]) => {
                const cell = document.querySelector(`.calendar-day[data-date="${date}"] .meals-container`);
                if (cell) {
                    meals.forEach(meal => {
                        const mealElement = createMealElement(meal);
                        cell.appendChild(mealElement);
                    });
                }
            });
            
            updateMealPlanStats();
        }
        
        function comparePlans(historyIndex) {
            const currentPlan = getMealPlanData();
            const historicalPlan = planHistory[historyIndex];
            
            // Create comparison view
            const modal = new bootstrap.Modal(document.getElementById('compareModal') || createCompareModal());
            
            // Populate comparison data
            populateComparison(currentPlan, historicalPlan);
            
            modal.show();
        }
        
        function createCompareModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'compareModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Speiseplan Vergleich</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Aktueller Plan</h6>
                                    <div id="currentPlanComparison"></div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Historischer Plan</h6>
                                    <div id="historicalPlanComparison"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }
        
        function populateComparison(currentPlan, historicalPlan) {
            const currentStats = calculatePlanStats(currentPlan);
            const historicalStats = historicalPlan.stats;
            
            document.getElementById('currentPlanComparison').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <p>Gerichte: ${currentStats.totalMeals}</p>
                        <p>Portionen: ${currentStats.totalPortions}</p>
                        <p>Gesamtkosten: ‚Ç¨${currentStats.totalCost.toFixed(2)}</p>
                        <p>Kosten/Portion: ‚Ç¨${currentStats.avgCostPerPortion.toFixed(2)}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('historicalPlanComparison').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <p>Gerichte: ${historicalStats.totalMeals}</p>
                        <p>Portionen: ${historicalStats.totalPortions}</p>
                        <p>Gesamtkosten: ‚Ç¨${historicalStats.totalCost.toFixed(2)}</p>
                        <p>Kosten/Portion: ‚Ç¨${historicalStats.avgCostPerPortion.toFixed(2)}</p>
                    </div>
                </div>
            `;
        }
        
        function updateHistoryUI() {
            // Update undo/redo buttons if they exist
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) {
                undoBtn.disabled = currentHistoryIndex <= 0;
            }
            if (redoBtn) {
                redoBtn.disabled = currentHistoryIndex >= planHistory.length - 1;
            }
        }
        
        // ===== MOBILE TOUCH SUPPORT =====
        
        let touchItem = null;
        let touchOffset = { x: 0, y: 0 };
        let touchClone = null;
        
        function initMobileSupport() {
            // Check if touch device
            if (!('ontouchstart' in window)) return;
            
            console.log('Initializing mobile touch support');
            
            // Add touch classes
            document.body.classList.add('touch-device');
            
            // Initialize touch drag for meal planning
            initTouchDragAndDrop();
            
            // Initialize mobile menu
            initMobileMenu();
            
            // Optimize modals for mobile
            optimizeModalsForMobile();
            
            // Add viewport meta if not exists
            if (!document.querySelector('meta[name="viewport"]')) {
                const viewport = document.createElement('meta');
                viewport.name = 'viewport';
                viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no';
                document.head.appendChild(viewport);
            }
        }
        
        function initTouchDragAndDrop() {
            // Recipe library items
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
        }
        
        function handleTouchStart(e) {
            const target = e.target.closest('.draggable, .meal-item');
            if (!target) return;
            
            e.preventDefault();
            touchItem = target;
            
            const touch = e.touches[0];
            const rect = target.getBoundingClientRect();
            touchOffset.x = touch.clientX - rect.left;
            touchOffset.y = touch.clientY - rect.top;
            
            // Create clone for dragging
            touchClone = target.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.width = rect.width + 'px';
            touchClone.style.height = rect.height + 'px';
            touchClone.style.opacity = '0.8';
            touchClone.style.zIndex = '9999';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.transition = 'none';
            document.body.appendChild(touchClone);
            
            // Position clone
            touchClone.style.left = (touch.clientX - touchOffset.x) + 'px';
            touchClone.style.top = (touch.clientY - touchOffset.y) + 'px';
            
            // Add dragging class
            target.classList.add('dragging');
        }
        
        function handleTouchMove(e) {
            if (!touchItem || !touchClone) return;
            
            e.preventDefault();
            const touch = e.touches[0];
            
            // Update clone position
            touchClone.style.left = (touch.clientX - touchOffset.x) + 'px';
            touchClone.style.top = (touch.clientY - touchOffset.y) + 'px';
            
            // Find drop target
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            const validTarget = dropTarget?.closest('.meals-container, .meal-drop-zone');
            
            // Remove previous hover states
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            if (validTarget) {
                validTarget.classList.add('drag-over');
            }
        }
        
        function handleTouchEnd(e) {
            if (!touchItem || !touchClone) return;
            
            e.preventDefault();
            const touch = e.changedTouches[0];
            
            // Find drop target
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            const validTarget = dropTarget?.closest('.meals-container');
            
            if (validTarget) {
                handleTouchDrop(touchItem, validTarget);
            }
            
            // Cleanup
            if (touchClone) {
                touchClone.remove();
                touchClone = null;
            }
            
            if (touchItem) {
                touchItem.classList.remove('dragging');
                touchItem = null;
            }
            
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
        
        function handleTouchDrop(draggedItem, dropTarget) {
            if (draggedItem.classList.contains('meal-item')) {
                // Moving existing meal
                dropTarget.appendChild(draggedItem);
            } else {
                // Adding new meal from recipe library
                const recipeData = {
                    id: draggedItem.dataset.recipeId,
                    name: draggedItem.querySelector('.recipe-name').textContent,
                    price: parseFloat(draggedItem.dataset.price),
                    portions: 50 // Default portions
                };
                
                const mealElement = createMealElement(recipeData);
                dropTarget.appendChild(mealElement);
            }
            
            updateMealPlanStats();
            showToast('Gericht hinzugef√ºgt', 'success');
        }
        
        function initMobileMenu() {
            const menuToggle = document.getElementById('mobileMenuToggle');
            if (!menuToggle) {
                // Create mobile menu toggle if not exists
                const toggle = document.createElement('button');
                toggle.id = 'mobileMenuToggle';
                toggle.className = 'btn btn-primary d-lg-none position-fixed bottom-0 end-0 m-3';
                toggle.style.zIndex = '1000';
                toggle.innerHTML = '<i class="bi bi-list"></i>';
                toggle.onclick = mobileMenuToggle;
                document.body.appendChild(toggle);
            }
        }
        
        function mobileMenuToggle() {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;
            
            sidebar.classList.toggle('show-mobile');
            
            // Add overlay
            let overlay = document.getElementById('mobileOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'mobileOverlay';
                overlay.className = 'mobile-overlay';
                overlay.onclick = () => {
                    sidebar.classList.remove('show-mobile');
                    overlay.classList.remove('show');
                };
                document.body.appendChild(overlay);
            }
            
            overlay.classList.toggle('show', sidebar.classList.contains('show-mobile'));
        }
        
        function optimizeModalsForMobile() {
            // Make modals full-screen on mobile
            if (window.innerWidth < 768) {
                document.addEventListener('show.bs.modal', function(e) {
                    const modal = e.target;
                    const dialog = modal.querySelector('.modal-dialog');
                    if (dialog && !dialog.classList.contains('modal-fullscreen')) {
                        dialog.classList.add('modal-fullscreen-sm-down');
                    }
                });
            }
        }
        
        function handleTouchDrag(element) {
            let touchItem = null;
            let initialX = 0;
            let initialY = 0;
            let currentX = 0;
            let currentY = 0;
            
            element.addEventListener('touchstart', dragStart, { passive: false });
            element.addEventListener('touchmove', drag, { passive: false });
            element.addEventListener('touchend', dragEnd, { passive: false });
            
            function dragStart(e) {
                e.preventDefault();
                touchItem = e.target.closest('.draggable');
                if (!touchItem) return;
                
                const touch = e.touches[0];
                initialX = touch.clientX;
                initialY = touch.clientY;
                
                touchItem.classList.add('dragging');
            }
            
            function drag(e) {
                if (!touchItem) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                currentX = touch.clientX - initialX;
                currentY = touch.clientY - initialY;
                
                touchItem.style.transform = `translate(${currentX}px, ${currentY}px)`;
            }
            
            function dragEnd(e) {
                if (!touchItem) return;
                
                touchItem.classList.remove('dragging');
                touchItem.style.transform = '';
                touchItem = null;
            }
        }
        
        // Initialize mobile support when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMobileSupport);
        } else {
            initMobileSupport();
        }
        
        // Helper function to get current week number
        function getCurrentWeekNumber() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const diff = now - start;
            const oneWeek = 1000 * 60 * 60 * 24 * 7;
            return Math.ceil(diff / oneWeek);
        }
        
        // Helper function to create meal element
        function createMealElement(mealData) {
            const mealDiv = document.createElement('div');
            mealDiv.className = 'meal-item mb-2 p-2 bg-light rounded';
            mealDiv.dataset.recipeId = mealData.id;
            mealDiv.dataset.price = mealData.price;
            mealDiv.dataset.portions = mealData.portions;
            mealDiv.draggable = true;
            
            mealDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="meal-name">${mealData.name}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeMeal(this)">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <small class="text-muted">‚Ç¨${mealData.price.toFixed(2)} | ${mealData.portions} Port.</small>
            `;
            
            return mealDiv;
        }
        
        // Helper function to remove meal
        function removeMeal(button) {
            const meal = button.closest('.meal-item');
            meal.remove();
            updateMealPlanStats();
            showToast('Gericht entfernt', 'info');
        }
        
        // Helper function to update meal plan stats
        function updateMealPlanStats() {
            const planData = getMealPlanData();
            const stats = calculatePlanStats(planData);
            
            // Update UI elements if they exist
            const costElement = document.getElementById('totalCost');
            if (costElement) {
                costElement.textContent = `‚Ç¨${stats.totalCost.toFixed(2)}`;
            }
            
            const mealsElement = document.getElementById('totalMeals');
            if (mealsElement) {
                mealsElement.textContent = stats.totalMeals;
            }
            
            // Save to history
            if (Object.keys(planData).length > 0) {
                saveToHistory(planData);
            }
        }
        
        // ===== INITIALIZATION =====
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ FoodSuite Pro - Vollst√§ndige Anwendung geladen');
            
            // Initialize user management
            initializeUserManagement();
            
            // Initialize automation settings
            setTimeout(() => {
                initializeAutomationSettings();
            }, 500);
            
            // Initialize collaboration features
            setTimeout(() => {
                initializeCollaboration();
            }, 1000);
            
            // Add event listeners for all interactions
            document.addEventListener('click', function(e) {
                // Handle tab navigation
                if (e.target.hasAttribute('data-tab') || e.target.closest('[data-tab]')) {
                    e.preventDefault();
                    const target = e.target.hasAttribute('data-tab') ? e.target : e.target.closest('[data-tab]');
                    const tabId = target.getAttribute('data-tab');
                    showTab(tabId);
                    return;
                }
                
                // Handle data-action clicks
                const actionElement = e.target.hasAttribute('data-action') ? e.target : e.target.closest('[data-action]');
                if (actionElement) {
                    e.preventDefault();
                    const action = actionElement.getAttribute('data-action');
                    const param = actionElement.getAttribute('data-param');
                    const modal = actionElement.getAttribute('data-modal');
                    const message = actionElement.getAttribute('data-message');
                    const type = actionElement.getAttribute('data-type');
                    
                    console.log(`üéØ Executing action: ${action}`, { param, modal, message, type });
                    
                    // Execute the appropriate function
                    try {
                        switch (action) {
                            case 'showModal':
                                if (modal && typeof showModal === 'function') showModal(modal);
                                break;
                            case 'applyAIRecommendation':
                                if (param && typeof applyAIRecommendation === 'function') applyAIRecommendation(parseInt(param));
                                break;
                            case 'toggleAIMode':
                                if (param && typeof toggleAIMode === 'function') toggleAIMode(param);
                                break;
                            case 'editSupplier':
                                if (param && typeof editSupplier === 'function') editSupplier(parseInt(param));
                                break;
                            case 'deleteSupplier':
                                if (param && typeof deleteSupplier === 'function') deleteSupplier(parseInt(param));
                                break;
                            case 'viewOrder':
                                if (param && typeof viewOrder === 'function') viewOrder(parseInt(param));
                                break;
                            case 'confirmOrder':
                                if (param && typeof confirmOrder === 'function') confirmOrder(parseInt(param));
                                break;
                            case 'showToast':
                                if (message && type && typeof showToast === 'function') showToast(message, type);
                                break;
                            case 'generateAIWeekMenu':
                                if (typeof generateAIWeekMenu === 'function') generateAIWeekMenu();
                                else showToast('KI Wochenmen√º wird generiert...', 'info');
                                break;
                            case 'optimizeCurrentPlan':
                                optimizeCurrentPlan();
                                break;
                            case 'exportMealPlan':
                                if (typeof exportMealPlan === 'function') exportMealPlan();
                                else showToast('Speiseplan wird exportiert...', 'info');
                                break;
                            case 'exportProducts':
                                if (typeof exportProducts === 'function') exportProducts();
                                else showToast('Produkte werden exportiert...', 'info');
                                break;
                            case 'clearProductFilters':
                                if (typeof clearProductFilters === 'function') clearProductFilters();
                                else showToast('Filter werden zur√ºckgesetzt...', 'info');
                                break;
                            case 'previousWeek':
                                if (typeof previousWeek === 'function') previousWeek();
                                else showToast('Vorherige Woche wird geladen...', 'info');
                                break;
                            case 'nextWeek':
                                if (typeof nextWeek === 'function') nextWeek();
                                else showToast('N√§chste Woche wird geladen...', 'info');
                                break;
                            case 'logout':
                                if (typeof logout === 'function') logout();
                                else showToast('Abmeldung...', 'info');
                                break;
                            case 'setNegativeStock':
                                const stockInput = document.getElementById('stockChange');
                                if (stockInput) {
                                    stockInput.value = '-' + Math.abs(stockInput.value || 0);
                                }
                                break;
                            case 'setPositiveStock':
                                const stockInputPos = document.getElementById('stockChange');
                                if (stockInputPos) {
                                    stockInputPos.value = '+' + Math.abs(stockInputPos.value || 0);
                                }
                                break;
                            default:
                                console.log(`Unknown action: ${action}`);
                                if (window[action] && typeof window[action] === 'function') {
                                    if (param) window[action](param);
                                    else window[action]();
                                }
                        }
                    } catch (error) {
                        console.error(`Error executing action ${action}:`, error);
                        showToast(`Fehler bei Aktion: ${action}`, 'error');
                    }
                }
            });
            
            // Initialize default tab
            showTab('dashboard');
            
            // Update sync status periodically
            setInterval(() => {
                const syncTexts = ['KI-Sync: aktiv', 'KI-Sync: vor 1 Min', 'KI-Sync: vor 2 Min'];
                document.getElementById('lastSync').textContent = syncTexts[Math.floor(Math.random() * syncTexts.length)];
            }, 60000);
            
            // Show welcome message
            setTimeout(() => {
                showToast('üéâ FoodSuite Pro geladen! Alle Features verf√ºgbar.', 'success');
            }, 1000);
        });
    </script>

    <!-- === USER MANAGEMENT MODALS === -->
    
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-check me-2"></i>FoodSuite Anmeldung
                    </h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Benutzername</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Passwort</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <select class="form-select" id="loginRole">
                                <option value="">Rolle w√§hlen (Demo)</option>
                                <option value="admin">üëë Administrator</option>
                                <option value="manager">üè¢ K√ºchenleiter</option>
                                <option value="chef">üë®‚Äçüç≥ K√ºchenchef</option>
                                <option value="sous_chef">ü•Ñ Sous Chef</option>
                                <option value="nutritionist">ü•ó Ern√§hrungsberater</option>
                                <option value="inventory_manager">üì¶ Lagerverwalter</option>
                                <option value="viewer">üëÅÔ∏è Betrachter</option>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Demo-Modus:</strong> W√§hlen Sie eine Rolle, um die entsprechende Benutzeroberfl√§che zu testen.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-action="performLogin">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Anmelden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-people me-2"></i>Benutzerverwaltung
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Aktive Benutzer</h6>
                                <button class="btn btn-primary btn-sm" data-action="showModal" data-modal="createUserModal">
                                    <i class="bi bi-person-plus me-1"></i>Neuer Benutzer
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Benutzer</th>
                                            <th>Rolle</th>
                                            <th>Status</th>
                                            <th>Letzte Anmeldung</th>
                                            <th>Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-primary rounded-circle text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 14px;">
                                                        AM
                                                    </div>
                                                    <div class="ms-2">
                                                        <div class="fw-bold">Anna M√ºller</div>
                                                        <small class="text-muted">chef.mueller</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-person-workspace me-1"></i>K√ºchenchef
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-circle-fill me-1" style="font-size: 8px;"></i>Online
                                                </span>
                                            </td>
                                            <td>vor 2 Std.</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" title="Bearbeiten">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" title="Rolle √§ndern">
                                                    <i class="bi bi-shield"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-info rounded-circle text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 14px;">
                                                        TS
                                                    </div>
                                                    <div class="ms-2">
                                                        <div class="fw-bold">Thomas Schmidt</div>
                                                        <small class="text-muted">manager.schmidt</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">
                                                    <i class="bi bi-person-badge me-1"></i>K√ºchenleiter
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-circle-fill me-1" style="font-size: 8px;"></i>Online
                                                </span>
                                            </td>
                                            <td>vor 30 Min.</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" title="Bearbeiten">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" title="Rolle √§ndern">
                                                    <i class="bi bi-shield"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-success rounded-circle text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 14px;">
                                                        LW
                                                    </div>
                                                    <div class="ms-2">
                                                        <div class="fw-bold">Lisa Weber</div>
                                                        <small class="text-muted">nutritionist.weber</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-heart-pulse me-1"></i>Ern√§hrungsberater
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-circle-fill me-1" style="font-size: 8px;"></i>Abwesend
                                                </span>
                                            </td>
                                            <td>vor 4 Std.</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" title="Bearbeiten">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" title="Rolle √§ndern">
                                                    <i class="bi bi-shield"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-shield-check me-1"></i>Rollen & Berechtigungen
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="role-hierarchy">
                                        <div class="role-item mb-2">
                                            <span class="badge bg-danger">
                                                <i class="bi bi-shield-check me-1"></i>Administrator
                                            </span>
                                            <small class="d-block text-muted">Vollzugriff</small>
                                        </div>
                                        <div class="role-item mb-2">
                                            <span class="badge bg-primary">
                                                <i class="bi bi-person-badge me-1"></i>K√ºchenleiter
                                            </span>
                                            <small class="d-block text-muted">Speiseplanung & Personal</small>
                                        </div>
                                        <div class="role-item mb-2">
                                            <span class="badge bg-success">
                                                <i class="bi bi-person-workspace me-1"></i>K√ºchenchef
                                            </span>
                                            <small class="d-block text-muted">Rezepte & Planung</small>
                                        </div>
                                        <div class="role-item mb-2">
                                            <span class="badge bg-warning">
                                                <i class="bi bi-person-plus me-1"></i>Sous Chef
                                            </span>
                                            <small class="d-block text-muted">Assistenz</small>
                                        </div>
                                        <div class="role-item mb-2">
                                            <span class="badge bg-info">
                                                <i class="bi bi-heart-pulse me-1"></i>Ern√§hrungsberater
                                            </span>
                                            <small class="d-block text-muted">N√§hrwertanalyse</small>
                                        </div>
                                        <div class="role-item mb-2">
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-boxes me-1"></i>Lagerverwalter
                                            </span>
                                            <small class="d-block text-muted">Lager & Bestellungen</small>
                                        </div>
                                        <div class="role-item">
                                            <span class="badge bg-light text-dark">
                                                <i class="bi bi-eye me-1"></i>Betrachter
                                            </span>
                                            <small class="d-block text-muted">Nur Lesezugriff</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person me-2"></i>Benutzerprofil
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="bg-primary rounded-circle text-white d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px; font-size: 32px;">
                            DU
                        </div>
                        <h5 class="mt-2">Demo User</h5>
                        <span class="badge bg-secondary">Administrator</span>
                    </div>
                    
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Vorname</label>
                                    <input type="text" class="form-control" value="Demo">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nachname</label>
                                    <input type="text" class="form-control" value="User">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">E-Mail</label>
                            <input type="email" class="form-control" value="demo@kantine-hauptwerk.de">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sprache</label>
                            <select class="form-select">
                                <option value="de" selected>Deutsch</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Theme</label>
                            <select class="form-select">
                                <option value="light" selected>Hell</option>
                                <option value="dark">Dunkel</option>
                                <option value="auto">Automatisch</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifications" checked>
                            <label class="form-check-label" for="notifications">
                                E-Mail Benachrichtigungen
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modals -->
    
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Anmelden</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Benutzername</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Passwort</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Angemeldet bleiben</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" form="loginForm" class="btn btn-primary">Anmelden</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Management Modal -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Benutzerverwaltung</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Registrierte Benutzer</h6>
                        <button class="btn btn-primary btn-sm">
                            <i class="bi bi-plus"></i> Neuer Benutzer
                        </button>
                    </div>
                    <div class="list-group" id="userList">
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">L√§dt...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mein Profil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm" onsubmit="handleProfileSave(event)">
                        <div class="mb-3">
                            <label for="profileName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="profileName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="profileEmail" class="form-label">E-Mail</label>
                            <input type="email" class="form-control" id="profileEmail">
                        </div>
                        <div class="mb-3">
                            <label for="profileRole" class="form-label">Rolle</label>
                            <input type="text" class="form-control" id="profileRole" readonly>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profileLanguage" class="form-label">Sprache</label>
                                    <select class="form-select" id="profileLanguage">
                                        <option value="de">Deutsch</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profileTheme" class="form-label">Design</label>
                                    <select class="form-select" id="profileTheme">
                                        <option value="light">Hell</option>
                                        <option value="dark">Dunkel</option>
                                        <option value="auto">Automatisch</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="profileNotifications">
                            <label class="form-check-label" for="profileNotifications">E-Mail-Benachrichtigungen erhalten</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" form="profileForm" class="btn btn-primary">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-download me-2"></i>Daten exportieren
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="mb-3">Exportformat w√§hlen:</h6>
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-export-format="pdf">
                                <i class="bi bi-file-earmark-pdf text-danger me-3" style="font-size: 1.5rem;"></i>
                                <div>
                                    <h6 class="mb-1">PDF-Dokument</h6>
                                    <small class="text-muted">Druckfertiges Dokument f√ºr Archivierung</small>
                                </div>
                            </button>
                            <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-export-format="excel">
                                <i class="bi bi-file-earmark-excel text-success me-3" style="font-size: 1.5rem;"></i>
                                <div>
                                    <h6 class="mb-1">Excel-Tabelle</h6>
                                    <small class="text-muted">F√ºr weitere Bearbeitung und Analysen</small>
                                </div>
                            </button>
                            <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-export-format="csv">
                                <i class="bi bi-file-earmark-text text-primary me-3" style="font-size: 1.5rem;"></i>
                                <div>
                                    <h6 class="mb-1">CSV-Datei</h6>
                                    <small class="text-muted">Universelles Format f√ºr Import/Export</small>
                                </div>
                            </button>
                            <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-export-format="ics">
                                <i class="bi bi-calendar-event text-info me-3" style="font-size: 1.5rem;"></i>
                                <div>
                                    <h6 class="mb-1">Kalenderdatei (ICS)</h6>
                                    <small class="text-muted">F√ºr Outlook, Google Kalender, etc.</small>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="mb-2">Exportoptionen:</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportIncludeNutrition" checked>
                            <label class="form-check-label" for="exportIncludeNutrition">
                                N√§hrwerte einschlie√üen
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportIncludeCosts" checked>
                            <label class="form-check-label" for="exportIncludeCosts">
                                Kosten und Preise einschlie√üen
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportIncludeIngredients">
                            <label class="form-check-label" for="exportIncludeIngredients">
                                Detaillierte Zutatenlisten
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Zeitraum:</label>
                        <select class="form-select" id="exportTimeRange">
                            <option value="current_week">Aktuelle Woche</option>
                            <option value="current_month">Aktueller Monat</option>
                            <option value="last_month">Letzter Monat</option>
                            <option value="custom">Benutzerdefiniert...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-info" id="performExport">
                        <i class="bi bi-download me-1"></i>Exportieren
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-clock-history me-2"></i>Speiseplan-Historie
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Suche in Historie..." id="historySearch">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="historyFilter">
                                <option value="">Alle Zeitr√§ume</option>
                                <option value="week">Letzte Woche</option>
                                <option value="month">Letzter Monat</option>
                                <option value="quarter">Letztes Quartal</option>
                                <option value="year">Letztes Jahr</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="historySort">
                                <option value="date_desc">Neueste zuerst</option>
                                <option value="date_asc">√Ñlteste zuerst</option>
                                <option value="cost_asc">G√ºnstigste zuerst</option>
                                <option value="cost_desc">Teuerste zuerst</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" id="refreshHistory">
                                <i class="bi bi-arrow-clockwise me-1"></i>Aktualisieren
                            </button>
                        </div>
                    </div>
                    <div class="accordion" id="historyAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#historyWeek1">
                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                        <span><strong>KW 2 - 2025</strong> (6. - 12. Januar)</span>
                                        <span class="badge bg-success">Abgeschlossen</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="historyWeek1" class="accordion-collapse collapse show" data-bs-parent="#historyAccordion">
                                <div class="accordion-body">
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <div class="d-flex gap-3 mb-2">
                                                <span><i class="bi bi-currency-euro"></i> Gesamtkosten: <strong>‚Ç¨2,450.00</strong></span>
                                                <span><i class="bi bi-people"></i> Portionen: <strong>1,250</strong></span>
                                                <span><i class="bi bi-calculator"></i> Kosten/Portion: <strong>‚Ç¨1.96</strong></span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" style="width: 85%">Budget: 85% genutzt</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-sm btn-outline-primary me-1" title="Details anzeigen">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-1" title="Plan wiederverwenden">
                                                <i class="bi bi-recycle"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" title="Exportieren">
                                                <i class="bi bi-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Tag</th>
                                                    <th>Fr√ºhst√ºck</th>
                                                    <th>Mittagessen</th>
                                                    <th>Abendessen</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Mo</td>
                                                    <td>M√ºsli-Buffet</td>
                                                    <td>Rindergulasch</td>
                                                    <td>Gem√ºsesuppe</td>
                                                </tr>
                                                <tr>
                                                    <td>Di</td>
                                                    <td>Obstsalat</td>
                                                    <td>Pasta Arrabiata</td>
                                                    <td>K√ºrbissuppe</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#historyWeek2">
                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                        <span><strong>KW 1 - 2025</strong> (30. Dez - 5. Januar)</span>
                                        <span class="badge bg-warning">Teilweise</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="historyWeek2" class="accordion-collapse collapse" data-bs-parent="#historyAccordion">
                                <div class="accordion-body">
                                    <div class="text-muted">Feiertagswoche - reduzierter Betrieb</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="me-auto text-muted">Zeige 2 von 52 Eintr√§gen</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Edit Modal -->
    <div class="modal fade" id="batchEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Stapelbearbeitung Rezepte
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>3 Rezepte ausgew√§hlt</strong> f√ºr Stapelbearbeitung
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Ausgew√§hlte Rezepte:</h6>
                            <div class="list-group mb-3" id="batchEditSelectedRecipes">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Rindergulasch</span>
                                    <button class="btn btn-sm btn-outline-danger" title="Entfernen">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Pasta Arrabiata</span>
                                    <button class="btn btn-sm btn-outline-danger" title="Entfernen">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Schnitzel</span>
                                    <button class="btn btn-sm btn-outline-danger" title="Entfernen">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Bearbeitungsoptionen:</h6>
                            <form id="batchEditForm">
                                <div class="mb-3">
                                    <label class="form-label">Kategorie √§ndern:</label>
                                    <select class="form-select" id="batchCategory">
                                        <option value="">-- Keine √Ñnderung --</option>
                                        <option value="breakfast">Fr√ºhst√ºck</option>
                                        <option value="lunch">Mittagessen</option>
                                        <option value="dinner">Abendessen</option>
                                        <option value="snack">Snack</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Preisanpassung (%):</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="batchPriceAdjustment" placeholder="z.B. 10 f√ºr +10%">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tags hinzuf√ºgen:</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="batchAddTags" placeholder="vegetarisch, glutenfrei">
                                        <button class="btn btn-outline-secondary" type="button">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <div class="mt-2" id="batchTagsList">
                                        <span class="badge bg-secondary me-1">vegetarisch <i class="bi bi-x"></i></span>
                                        <span class="badge bg-secondary me-1">regional <i class="bi bi-x"></i></span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status √§ndern:</label>
                                    <select class="form-select" id="batchStatus">
                                        <option value="">-- Keine √Ñnderung --</option>
                                        <option value="active">Aktiv</option>
                                        <option value="inactive">Inaktiv</option>
                                        <option value="seasonal">Saisonal</option>
                                    </select>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batchUpdateNutrition">
                                    <label class="form-check-label" for="batchUpdateNutrition">
                                        N√§hrwerte neu berechnen
                                    </label>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-warning" id="applyBatchEdit">
                        <i class="bi bi-check-circle me-1"></i>√Ñnderungen anwenden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal fade" id="comparisonModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-purple text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-columns-gap me-2"></i>Speiseplan-Vergleich
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Plan 1 ausw√§hlen:</label>
                            <select class="form-select" id="comparePlan1">
                                <option value="current">Aktueller Plan (KW 3)</option>
                                <option value="week2">KW 2 - 2025</option>
                                <option value="week1">KW 1 - 2025</option>
                                <option value="template1">Vorlage: Wintermen√º</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Plan 2 ausw√§hlen:</label>
                            <select class="form-select" id="comparePlan2">
                                <option value="week2">KW 2 - 2025</option>
                                <option value="week1">KW 1 - 2025</option>
                                <option value="template1">Vorlage: Wintermen√º</option>
                                <option value="template2">Vorlage: Sommermen√º</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Plan 1: Aktuelle Woche</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center mb-3">
                                        <div class="col">
                                            <small class="text-muted">Gesamtkosten</small>
                                            <h5>‚Ç¨2,580</h5>
                                        </div>
                                        <div class="col">
                                            <small class="text-muted">√ò Kosten/Portion</small>
                                            <h5>‚Ç¨2.15</h5>
                                        </div>
                                        <div class="col">
                                            <small class="text-muted">√ò Kalorien</small>
                                            <h5>450 kcal</h5>
                                        </div>
                                    </div>
                                    <h6>Rezept√ºbersicht:</h6>
                                    <ul class="list-unstyled" id="compare1Recipes">
                                        <li><i class="bi bi-check text-success"></i> Rindergulasch (3x)</li>
                                        <li><i class="bi bi-check text-success"></i> Pasta Arrabiata (2x)</li>
                                        <li><i class="bi bi-check text-success"></i> Gem√ºsesuppe (4x)</li>
                                        <li><i class="bi bi-check text-success"></i> M√ºsli-Buffet (5x)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Plan 2: KW 2 - 2025</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center mb-3">
                                        <div class="col">
                                            <small class="text-muted">Gesamtkosten</small>
                                            <h5>‚Ç¨2,450</h5>
                                        </div>
                                        <div class="col">
                                            <small class="text-muted">√ò Kosten/Portion</small>
                                            <h5>‚Ç¨1.96</h5>
                                        </div>
                                        <div class="col">
                                            <small class="text-muted">√ò Kalorien</small>
                                            <h5>425 kcal</h5>
                                        </div>
                                    </div>
                                    <h6>Rezept√ºbersicht:</h6>
                                    <ul class="list-unstyled" id="compare2Recipes">
                                        <li><i class="bi bi-check text-success"></i> Rindergulasch (2x)</li>
                                        <li><i class="bi bi-x text-danger"></i> Schnitzel (3x)</li>
                                        <li><i class="bi bi-check text-success"></i> Gem√ºsesuppe (3x)</li>
                                        <li><i class="bi bi-x text-danger"></i> Obstsalat (4x)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Vergleichsanalyse:</h6>
                        <div class="alert alert-success">
                            <i class="bi bi-graph-down me-1"></i>
                            <strong>Kostenersparnis:</strong> Plan 2 ist ‚Ç¨130 (5%) g√ºnstiger
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-arrow-left-right me-1"></i>
                            <strong>Gemeinsame Rezepte:</strong> 50% √úbereinstimmung (Rindergulasch, Gem√ºsesuppe)
                        </div>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>N√§hrwertunterschied:</strong> Plan 1 hat 25 kcal mehr pro Portion
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="swapPlans">
                        <i class="bi bi-arrow-left-right me-1"></i>Pl√§ne tauschen
                    </button>
                    <button type="button" class="btn btn-primary" id="exportComparison">
                        <i class="bi bi-download me-1"></i>Vergleich exportieren
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DRAG & DROP FIX -->
    <script>
        // Drag & Drop Fix f√ºr FoodSuite
        function fixDragAndDrop() {
            console.log('üîß Fixing Drag & Drop...');
            
            // Ensure AppData exists
            // AppData already defined globally, just ensure drag properties exist
            if (!window.AppData.draggedRecipe) window.AppData.draggedRecipe = null;
            if (!window.AppData.draggedElement) window.AppData.draggedElement = null;
            
            // Fixed handleDragStart
            window.handleDragStart = function(e) {
                console.log('üîÑ Drag started');
                
                AppData.draggedElement = e.target;
                AppData.draggedElement.classList.add('dragging');
                
                const recipeId = parseInt(e.target.dataset.recipeId);
                console.log('Recipe ID:', recipeId);
                console.log('Available recipes:', AppData.recipes.length);
                
                // Find recipe with fallback
                AppData.draggedRecipe = AppData.recipes.find(r => r.id === recipeId);
                
                if (!AppData.draggedRecipe) {
                    // Fallback: create recipe from DOM data
                    AppData.draggedRecipe = {
                        id: recipeId,
                        name: e.target.textContent.trim().split('\n')[0] || 'Unknown Recipe',
                        category: 'main',
                        cost_per_portion: 5.99,
                        portions: 4
                    };
                    console.log('‚ö†Ô∏è Created fallback recipe:', AppData.draggedRecipe);
                }
                
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
                
                console.log('‚úÖ Drag started with recipe:', AppData.draggedRecipe.name);
            };
            
            // Fixed handleDrop
            window.handleDrop = function(e) {
                e.preventDefault();
                console.log('üìç Drop event triggered');
                
                const cell = e.target.closest('.calendar-cell');
                if (!cell) {
                    console.log('‚ùå No calendar cell found');
                    return;
                }
                
                if (!AppData.draggedRecipe) {
                    console.log('‚ùå No dragged recipe found');
                    return;
                }
                
                console.log('‚úÖ Valid drop detected');
                
                cell.classList.remove('drag-over');
                
                const slot = cell.dataset.slot;
                const day = cell.dataset.day;
                const meal = cell.dataset.meal;
                
                console.log('Drop target:', { slot, day, meal });
                
                // Check if dragged from another calendar cell (move operation)
                if (AppData.draggedElement && AppData.draggedElement.closest('.calendar-cell')) {
                    const sourceCell = AppData.draggedElement.closest('.calendar-cell');
                    const sourceSlot = sourceCell.dataset.slot;
                    
                    // Remove from source slot
                    delete AppData.mealPlan[sourceSlot];
                    sourceCell.innerHTML = '<div class="calendar-cell-empty">Rezept hier ablegen</div>';
                    sourceCell.classList.remove('has-meal');
                    
                    console.log('üì§ Moved from:', sourceSlot);
                }
                
                // Add meal to plan
                AppData.mealPlan[slot] = { 
                    id: AppData.draggedRecipe.id, 
                    name: AppData.draggedRecipe.name 
                };
                
                // Create meal HTML
                const mealHTML = `
                    <div class="meal-event" draggable="true" data-recipe-id="${AppData.draggedRecipe.id}">
                        <div class="meal-title">${AppData.draggedRecipe.name}</div>
                        <div class="meal-details">
                            ${AppData.draggedRecipe.portions || 4} Portionen ‚Ä¢ ‚Ç¨${(AppData.draggedRecipe.cost_per_portion || 0).toFixed(2)}/Portion
                        </div>
                        <div class="meal-actions">
                            <button class="btn btn-sm btn-outline-light" onclick="removeMeal('${slot}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Update UI
                cell.innerHTML = mealHTML;
                cell.classList.add('has-meal');
                
                // Add drag functionality to the new meal
                const mealEvent = cell.querySelector('.meal-event');
                if (mealEvent) {
                    mealEvent.addEventListener('dragstart', handleDragStart);
                    mealEvent.addEventListener('dragend', handleDragEnd);
                }
                
                // Add success animation
                cell.classList.add('drop-success');
                setTimeout(() => cell.classList.remove('drop-success'), 600);
                
                console.log('üéâ Recipe successfully dropped!');
                console.log('Current meal plan:', AppData.mealPlan);
                
                // Clean up
                AppData.draggedRecipe = null;
                AppData.draggedElement = null;
            };
            
            console.log('‚úÖ Drag & Drop functions fixed');
        }
        
        // Function to ensure recipes are loaded
        async function ensureRecipesLoaded() {
            if (!AppData.recipes || AppData.recipes.length === 0) {
                console.log('üìö Loading recipes for drag & drop...');
                
                try {
                    const response = await fetch('/api/recipes', {
                        headers: {
                            'X-Tenant-ID': 'demo'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        AppData.recipes = data.items || data.recipes || data || [];
                        console.log(`‚úÖ Loaded ${AppData.recipes.length} recipes`);
                    } else {
                        console.log('‚ö†Ô∏è Failed to load recipes, using fallback');
                        AppData.recipes = [
                            { id: 1, name: 'Gem√ºse-Curry', category: 'main', cost_per_portion: 4.99, portions: 6 },
                            { id: 2, name: 'Nudeln Bolognese', category: 'main', cost_per_portion: 3.99, portions: 4 }
                        ];
                    }
                } catch (error) {
                    console.error('Error loading recipes:', error);
                    AppData.recipes = [
                        { id: 1, name: 'Gem√ºse-Curry', category: 'main', cost_per_portion: 4.99, portions: 6 },
                        { id: 2, name: 'Nudeln Bolognese', category: 'main', cost_per_portion: 3.99, portions: 4 }
                    ];
                }
            }
        }
        
        // Apply fixes when page loads
        setTimeout(() => {
            fixDragAndDrop();
            ensureRecipesLoaded();
        }, 1000);
        
        console.log('üîß Drag & Drop fix script loaded');
        
        // Comprehensive Drag & Drop Fix
        (function() {
            console.log('üîß Applying comprehensive drag & drop fix...');
            
            // Globale Cleanup-Funktion
            function cleanupDraggingState() {
                // Entferne alle dragging Klassen
                document.querySelectorAll('.dragging').forEach(el => {
                    el.classList.remove('dragging');
                    el.style.opacity = ''; // Reset inline styles
                });
                
                // Entferne alle drag-over Klassen
                document.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            }
            
            // Global mouse up handler als Fallback
            document.addEventListener('mouseup', function() {
                setTimeout(cleanupDraggingState, 150);
            });
            
            // Touch-Support f√ºr mobile Ger√§te
            document.addEventListener('touchend', function() {
                setTimeout(cleanupDraggingState, 150);
            });
            
            // √úberwache DOM-√Ñnderungen und f√ºge Event-Listener hinzu
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.classList && node.classList.contains('recipe-item')) {
                            // Zus√§tzliche Sicherheits-Events
                            node.addEventListener('dragend', function() {
                                this.classList.remove('dragging');
                            });
                            
                            node.addEventListener('mouseup', function() {
                                setTimeout(() => {
                                    this.classList.remove('dragging');
                                }, 100);
                            });
                        }
                    });
                });
            });
            
            // Starte Observer
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Periodic cleanup als letzte Sicherheit
            setInterval(function() {
                // Pr√ºfe ob ein Element zu lange im dragging state ist
                document.querySelectorAll('.dragging').forEach(el => {
                    if (!el.matches(':active')) {
                        el.classList.remove('dragging');
                    }
                });
            }, 2000);
            
            console.log('‚úÖ Comprehensive drag & drop fix applied!');
        })();
    </script>

    <!-- KI Designer Modal -->
    <div class="modal fade" id="aiDesignerModal" tabindex="-1" aria-labelledby="aiDesignerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiDesignerModalLabel">
                        <i class="bi bi-person-gear me-2"></i>Speiseplan-Assistent anpassen
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 class="mb-4">üçΩÔ∏è Pers√∂nlichen Speiseplan-Assistenten erstellen</h5>
                    
                    <!-- FORMULAR DIREKT SICHTBAR -->
                            <!-- Modus Name -->
                            <div class="row g-3 mt-2">
                                <div class="col-12">
                                    <label class="form-label"><strong>Name f√ºr Ihren Speiseplan</strong></label>
                                    <input type="text" class="form-control" id="customModeName" placeholder="z.B. Vegetarische K√ºche, Familienfreundlich, Sportler-Men√ºs..." required>
                                </div>
                            </div>
                            
                            <!-- Remove duplicate sections - they are now inside modal -->
                            <!-- Budget & Kosten -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">üí∞ Budget & Kosten</h6>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Max. ‚Ç¨/Portion</strong></label>
                                    <input type="number" class="form-control" id="maxCostPerPortion" placeholder="3.80" step="0.10" min="0">
                                    <div class="form-text">Maximale Kosten pro Portion</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Wochenbudget ‚Ç¨</strong></label>
                                    <input type="number" class="form-control" id="weeklyBudget" placeholder="2400" step="10" min="0">
                                    <div class="form-text">Gesamtes Budget pro Woche</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Zutatenkosten %</strong></label>
                                    <input type="number" class="form-control" id="ingredientCostPercent" placeholder="65" min="0" max="100">
                                    <div class="form-text">Max. % vom Verkaufspreis</div>
                                </div>
                            </div>

                            <!-- N√§hrwerte -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">ü•ó N√§hrwerte pro Portion</h6>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Min. Protein (g)</strong></label>
                                    <input type="number" class="form-control" id="minProteinGrams" placeholder="25" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Max. Kalorien</strong></label>
                                    <input type="number" class="form-control" id="maxCalories" placeholder="600" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Min. Gem√ºse (g)</strong></label>
                                    <input type="number" class="form-control" id="minVegetableGrams" placeholder="200" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Max. Salz (g)</strong></label>
                                    <input type="number" class="form-control" id="maxSaltGrams" placeholder="2.5" step="0.1" min="0">
                                </div>
                            </div>

                            <!-- Zeitmanagement -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">‚è±Ô∏è Zeitmanagement</h6>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Max. Zubereitungszeit (Min)</strong></label>
                                    <input type="number" class="form-control" id="maxPrepTime" placeholder="45" min="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Express-Gerichte/Woche</strong></label>
                                    <input type="number" class="form-control" id="expressPerWeek" placeholder="3" min="0" max="21">
                                    <div class="form-text">Unter 20 Min Zubereitung</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Max. aufwendige/Tag</strong></label>
                                    <input type="number" class="form-control" id="complexPerDay" placeholder="1" min="0" max="3">
                                    <div class="form-text">√úber 60 Min Zubereitung</div>
                                </div>
                            </div>

                            <!-- Vielfalt & Regeln -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">üåà Vielfalt & Regeln</h6>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Min. verschiedene Gerichte/Woche</label>
                                    <input type="number" class="form-control" id="minVarietyPerWeek" value="15" min="5" max="25">
                                    <div class="form-text">Anzahl unterschiedlicher Rezepte</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Max. Wiederholungen/Monat</label>
                                    <input type="number" class="form-control" id="maxRepeatPerMonth" value="2" min="1" max="5">
                                    <div class="form-text">Wie oft darf ein Gericht wiederholt werden</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Vegetarische Tage/Woche</label>
                                    <input type="number" class="form-control" id="veggieDaysPerWeek" value="2" min="0" max="7">
                                    <div class="form-text">Anzahl fleischloser Tage</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">K√ºchen-Schwerpunkte</label>
                                    <select class="form-select" id="cuisinePreferences" multiple>
                                        <option value="deutsch" selected>Deutsche K√ºche</option>
                                        <option value="mediterran">Mediterran</option>
                                        <option value="asiatisch">Asiatisch</option>
                                        <option value="vegetarisch">Vegetarisch</option>
                                        <option value="regional">Regional</option>
                                        <option value="international">International</option>
                                    </select>
                                    <div class="form-text">Mehrfachauswahl m√∂glich</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Saisonale Zutaten bevorzugen</label>
                                    <select class="form-select" id="seasonalPreference">
                                        <option value="0">Nicht wichtig</option>
                                        <option value="50">Wenn m√∂glich</option>
                                        <option value="100" selected>Sehr wichtig</option>
                                    </select>
                                    <div class="form-text">Frische und regionale Produkte</div>
                                </div>
                            </div>
                            
                            <!-- Ausschl√ºsse -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-danger">üö´ Ausschl√ºsse</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Zutaten ausschlie√üen</label>
                                        <input type="text" class="form-control" id="excludeIngredients" placeholder="z.B. Schweinefleisch, N√ºsse">
                                        <div class="form-text">Komma-getrennt</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Allergene ausschlie√üen</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="gluten" id="allergen-gluten">
                                                    <label class="form-check-label" for="allergen-gluten">Gluten</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="lactose" id="allergen-dairy">
                                                    <label class="form-check-label" for="allergen-dairy">Milch</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="nuts" id="allergen-nuts">
                                                    <label class="form-check-label" for="allergen-nuts">N√ºsse</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="fish" id="allergen-fish">
                                                    <label class="form-check-label" for="allergen-fish">Fisch</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kategorien ausschlie√üen</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="meat" id="category-meat">
                                                    <label class="form-check-label" for="category-meat">Fleisch</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="fish" id="category-fish">
                                                    <label class="form-check-label" for="category-fish">Fisch</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="spicy" id="category-spicy">
                                                    <label class="form-check-label" for="category-spicy">Scharf</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="dessert" id="category-dessert">
                                                    <label class="form-check-label" for="category-dessert">Dessert</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Modus Name -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Name f√ºr Ihren Speiseplan</label>
                                    <input type="text" class="form-control" id="customModeName" placeholder="z.B. Vegetarische K√ºche, Familienfreundlich, Sportler-Men√ºs...">
                                    <div class="form-text">Geben Sie Ihrem pers√∂nlichen Speiseplan-Assistenten einen Namen</div>
                                </div>
                            </div>
                            
                            <!-- Budget & Kosten -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">üí∞ Budget & Kosten</h6>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Max. ‚Ç¨/Portion</strong></label>
                                    <input type="number" class="form-control" id="maxCostPerPortion" placeholder="3.80" step="0.10" min="0">
                                    <div class="form-text">Maximale Kosten pro Portion</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Wochenbudget ‚Ç¨</strong></label>
                                    <input type="number" class="form-control" id="weeklyBudget" placeholder="2400" step="10" min="0">
                                    <div class="form-text">Gesamtes Budget pro Woche</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Zutatenkosten %</strong></label>
                                    <input type="number" class="form-control" id="ingredientCostPercent" placeholder="30" min="0" max="100">
                                    <div class="form-text">Max. % vom Verkaufspreis</div>
                                </div>
                            </div>

                            <!-- N√§hrwerte -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">ü•ó N√§hrwerte pro Portion</h6>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Min. Protein (g)</strong></label>
                                    <input type="number" class="form-control" id="minProtein" placeholder="25" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Max. Kalorien</strong></label>
                                    <input type="number" class="form-control" id="maxCalories" placeholder="600" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Min. Gem√ºse %</strong></label>
                                    <input type="number" class="form-control" id="minVeggiePercent" placeholder="30" min="0" max="100">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label"><strong>Max. Salz (mg)</strong></label>
                                    <input type="number" class="form-control" id="maxSaltMg" placeholder="2000" min="0">
                                </div>
                            </div>

                            <!-- Zeitmanagement -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">‚è±Ô∏è Zeitmanagement</h6>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Max. Zubereitungszeit (Min)</strong></label>
                                    <input type="number" class="form-control" id="maxPrepTime" placeholder="45" min="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Express-Gerichte/Woche</strong></label>
                                    <input type="number" class="form-control" id="expressPerWeek" placeholder="2" min="0" max="21">
                                    <div class="form-text">Unter 20 Min Zubereitung</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>Max. aufwendige Gerichte/Tag</strong></label>
                                    <input type="number" class="form-control" id="maxComplexPerDay" placeholder="1" min="0" max="3">
                                    <div class="form-text">√úber 60 Min Zubereitung</div>
                                </div>
                            </div>

                            <!-- Vielfalt & Regeln -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary">üåà Vielfalt & Regeln</h6>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Min. verschiedene Gerichte/Woche</label>
                                    <input type="number" class="form-control" id="minVarietyPerWeek" value="15" min="5" max="25">
                                    <div class="form-text">Anzahl unterschiedlicher Rezepte</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Max. Wiederholungen/Monat</label>
                                    <input type="number" class="form-control" id="maxRepeatPerMonth" value="2" min="1" max="5">
                                    <div class="form-text">Wie oft darf ein Gericht wiederholt werden</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Vegetarische Tage/Woche</label>
                                    <input type="number" class="form-control" id="veggieDaysPerWeek" value="2" min="0" max="7">
                                    <div class="form-text">Anzahl fleischloser Tage</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">K√ºchen-Schwerpunkte</label>
                                    <select class="form-select" id="cuisinePreferences" multiple>
                                        <option value="deutsch" selected>Deutsche K√ºche</option>
                                        <option value="mediterran">Mediterran</option>
                                        <option value="asiatisch">Asiatisch</option>
                                        <option value="vegetarisch">Vegetarisch</option>
                                        <option value="regional">Regional</option>
                                        <option value="international">International</option>
                                    </select>
                                    <div class="form-text">Mehrfachauswahl m√∂glich</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Saisonale Zutaten bevorzugen</label>
                                    <select class="form-select" id="seasonalPreference">
                                        <option value="0">Nicht wichtig</option>
                                        <option value="50">Wenn m√∂glich</option>
                                        <option value="100" selected>Sehr wichtig</option>
                                    </select>
                                    <div class="form-text">Frische und regionale Produkte</div>
                                </div>
                            </div>
                            
                            <!-- Ausschl√ºsse -->
                            <div class="row g-4 mt-3">
                                <div class="col-12">
                                    <h6 class="text-danger">üö´ Ausschl√ºsse</h6>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Zutaten ausschlie√üen</label>
                                        <input type="text" class="form-control" id="excludeIngredients" placeholder="z.B. Schweinefleisch, N√ºsse">
                                        <div class="form-text">Komma-getrennt</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kategorien ausschlie√üen</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="meat" id="category-meat">
                                                    <label class="form-check-label" for="category-meat">Fleisch</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="fish" id="category-fish">
                                                    <label class="form-check-label" for="category-fish">Fisch</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="spicy" id="category-spicy">
                                                    <label class="form-check-label" for="category-spicy">Scharf</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="categories" value="dessert" id="category-dessert">
                                                    <label class="form-check-label" for="category-dessert">Dessert</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Allergene ausschlie√üen</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="gluten" id="allergen-gluten">
                                                    <label class="form-check-label" for="allergen-gluten">Gluten</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="lactose" id="allergen-dairy">
                                                    <label class="form-check-label" for="allergen-dairy">Milch</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="nuts" id="allergen-nuts">
                                                    <label class="form-check-label" for="allergen-nuts">N√ºsse</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergens" value="fish" id="allergen-fish">
                                                    <label class="form-check-label" for="allergen-fish">Fisch</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" id="testCustomModeBtn">
                        <i class="bi bi-play-fill me-1"></i>Testen
                    </button>
                    <button type="button" class="btn btn-success" id="saveCustomModeBtn">
                        <i class="bi bi-save me-1"></i>Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Custom AI Mode Designer Functions
        function buildCustomConfig() {
            const config = {
                type: 'custom',
                // Konkrete Werte statt abstrakte Gewichtungen
                budget: {
                    maxCostPerPortion: parseFloat(document.getElementById('maxCostPerPortion').value) || 3.50,
                    weeklyBudget: parseFloat(document.getElementById('weeklyBudget').value) || null,
                    ingredientCostPercent: parseInt(document.getElementById('ingredientCostPercent').value) || 30
                },
                nutrition: {
                    minProtein: parseInt(document.getElementById('minProtein').value) || 20,
                    maxCalories: parseInt(document.getElementById('maxCalories').value) || 800,
                    minVeggiePercent: parseInt(document.getElementById('minVeggiePercent').value) || 30,
                    maxSaltMg: parseInt(document.getElementById('maxSaltMg').value) || 2000
                },
                timeManagement: {
                    maxPrepTime: parseInt(document.getElementById('maxPrepTime').value) || 45,
                    expressPerWeek: parseInt(document.getElementById('expressPerWeek').value) || 2,
                    maxComplexPerDay: parseInt(document.getElementById('maxComplexPerDay').value) || 1
                },
                variety: {
                    minVarietyPerWeek: parseInt(document.getElementById('minVarietyPerWeek').value) || 15,
                    maxRepeatPerMonth: parseInt(document.getElementById('maxRepeatPerMonth').value) || 2,
                    veggieDaysPerWeek: parseInt(document.getElementById('veggieDaysPerWeek').value) || 2,
                    cuisinePreferences: Array.from(document.getElementById('cuisinePreferences').selectedOptions).map(opt => opt.value),
                    seasonalPreference: parseInt(document.getElementById('seasonalPreference').value) || 100
                },
                exclusions: {
                    ingredients: document.getElementById('excludeIngredients').value.split(',').map(s => s.trim()).filter(s => s),
                    allergens: Array.from(document.querySelectorAll('input[name="allergens"]:checked')).map(cb => cb.value),
                    categories: Array.from(document.querySelectorAll('input[name="categories"]:checked')).map(cb => cb.value)
                }
            };
            
            return config;
        }

        async function testCustomMode() {
            const config = buildCustomConfig();
            
            try {
                showToast('üß™ Teste benutzerdefinierten Modus...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/ai/suggest-meals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-tenant-id': TENANT_ID
                    },
                    body: JSON.stringify({
                        mode: 'custom',
                        weekNumber: 1,
                        currentPlan: {},
                        customConfig: config
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('‚úÖ Test erfolgreich! Neuer Plan generiert.', 'success');
                    
                    // Apply the test plan temporarily
                    AppData.mealPlan = result.mealPlan || {};
                    createMealCalendar();
                } else {
                    throw new Error('Test fehlgeschlagen');
                }
            } catch (error) {
                console.error('Custom mode test error:', error);
                showToast('‚ùå Test fehlgeschlagen: ' + error.message, 'error');
            }
        }

        function saveCustomMode() {
            const config = buildCustomConfig();
            const name = document.getElementById('customModeName').value.trim();
            
            if (!name) {
                showToast('‚ùå Bitte geben Sie einen Namen f√ºr den Modus ein', 'error');
                return;
            }
            
            try {
                // Get existing custom modes from localStorage
                const savedModes = JSON.parse(localStorage.getItem('customAIModes') || '{}');
                
                // Add new mode
                savedModes[name] = {
                    ...config,
                    name: name,
                    created: new Date().toISOString()
                };
                
                // Save to localStorage
                localStorage.setItem('customAIModes', JSON.stringify(savedModes));
                
                // Add button to AI control panel
                addCustomModeButton(name, config);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('aiDesignerModal'));
                modal.hide();
                
                showToast(`‚úÖ Modus "${name}" gespeichert!`, 'success');
                
                // Reset form
                document.getElementById('customModeName').value = '';
                
            } catch (error) {
                console.error('Save custom mode error:', error);
                showToast('‚ùå Speichern fehlgeschlagen: ' + error.message, 'error');
            }
        }

        function addCustomModeButton(name, config) {
            const buttonContainer = document.querySelector('.ai-controls');
            if (!buttonContainer) return;
            
            // Check if button already exists
            const existingButton = document.querySelector(`[data-custom-mode="${name}"]`);
            if (existingButton) {
                existingButton.remove();
            }
            
            // Create new button
            const button = document.createElement('div');
            button.className = 'ai-button custom-mode';
            button.setAttribute('data-custom-mode', name);
            button.innerHTML = `<i class="bi bi-gear me-1"></i>${name}`;
            
            // Store the config on the button
            button.customConfig = config;
            
            button.onclick = () => {
                // Deactivate all other buttons
                document.querySelectorAll('.ai-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Set custom mode
                AppData.aiMode = 'custom';
                AppData.activeCustomConfig = config;
                
                // Generate new plan with custom config
                showToast(`üîÑ Erstelle ${name} Plan...`, 'info');
                AppData.mealPlan = {};
                generateAIWeekMenu(); // Use the main function which now handles custom configs
            };
            
            // Add button before the designer button
            const designerButton = buttonContainer.querySelector('.ai-designer-btn');
            if (designerButton) {
                designerButton.parentNode.insertBefore(button, designerButton);
            } else {
                buttonContainer.appendChild(button);
            }
        }

        async function generateAIWeekMenuWithCustom(customConfig) {
            try {
                const response = await fetch(`${API_BASE_URL}/ai/suggest-meals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-tenant-id': TENANT_ID
                    },
                    body: JSON.stringify({
                        mode: 'custom',
                        weekNumber: 1,
                        currentPlan: {},
                        customConfig: customConfig
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    AppData.mealPlan = result.mealPlan || {};
                    createMealCalendar();
                    showToast('‚úÖ Benutzerdefinierter Plan erstellt!', 'success');
                } else {
                    throw new Error('Plan generation failed');
                }
            } catch (error) {
                console.error('Custom AI generation error:', error);
                showToast('‚ùå Plan-Erstellung fehlgeschlagen', 'error');
            }
        }

        function loadSavedCustomModes() {
            try {
                const savedModes = JSON.parse(localStorage.getItem('customAIModes') || '{}');
                
                Object.entries(savedModes).forEach(([name, config]) => {
                    addCustomModeButton(name, config);
                });
                
                console.log(`üìÇ Loaded ${Object.keys(savedModes).length} custom AI modes`);
            } catch (error) {
                console.error('Error loading custom modes:', error);
            }
        }

        function updateConfigPreview() {
            const config = buildCustomConfig();
            const preview = document.getElementById('configPreview');
            if (preview) {
                preview.textContent = JSON.stringify(config, null, 2);
            }
        }

        // Update preview when values change
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for preview updates
            const previewElements = [
                'costSlider', 'healthSlider', 'varietySlider', 'speedSlider',
                'excludeIngredients', 'maxCostPerMeal', 'totalWeekBudget',
                'minCalories', 'maxCalories', 'minProtein', 'maxCarbs',
                'cuisineItalian', 'cuisineAsian', 'cuisineMediterranean', 'cuisineGerman',
                'prepTimeLimit', 'quickMealsPerWeek', 'maxSameRecipe', 'minDaysBetween'
            ];
            
            previewElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateConfigPreview);
                }
            });
            
            // Add event listeners for checkboxes
            document.querySelectorAll('input[name="allergens"], input[name="categories"]').forEach(cb => {
                cb.addEventListener('change', updateConfigPreview);
            });
            
            // Wait for meal planning tab to be initialized before loading custom modes
            setTimeout(() => {
                loadSavedCustomModes();
            }, 2000);
            
            // Add event listeners for custom mode buttons
            const testBtn = document.getElementById('testCustomModeBtn');
            const saveBtn = document.getElementById('saveCustomModeBtn');
            
            if (testBtn) {
                testBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üß™ Test button clicked');
                    testCustomMode();
                });
            }
            
            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üíæ Save button clicked');
                    saveCustomMode();
                });
            }
        });
    </script>

</body>
</html>